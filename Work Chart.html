<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The New Work Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Nunito', 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .step-connector {
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translate(0, -50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #38bdf8);
            border-radius: 2px;
        }
        .step-connector::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -2px;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #38bdf8;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 50%, #8b5cf6 100%);
        }
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .comparison-table {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }
        @media print {
            .no-print { display: none !important; }
        }
        .work-chart-card {
            transition: all 0.3s ease;
        }
        .work-chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* --- Flat theme to match AI Partner (black/white with accents) --- */
        :root {
            --primary-color: #000000;
            --secondary-color: #333333;
            --bg-color: #ffffff;
            --panel-bg: #ffffff;
            --text-color: #000000;
            --light-text-color: #666666;
            --border-color: #e0e0e0;
            --accent-orange: #ff6b35;
            --accent-yellow: #ffa502;
            --accent-green: #2ed573;
            --accent-purple: #5f27cd;
        }

        body {
            background: var(--bg-color) !important;
            color: var(--text-color);
        }
        .gradient-bg { /* hero */
            background: var(--primary-color) !important;
            color: #ffffff;
            border-radius: 0 !important;
        }
        .glass-effect {
            backdrop-filter: none !important;
            background: var(--panel-bg) !important;
            border: 2px solid var(--border-color) !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06), 0 1px 8px rgba(0,0,0,0.05);
        }
        .comparison-table {
            background: var(--panel-bg) !important;
            border: 2px solid var(--border-color);
        }
        .step-connector {
            background: var(--text-color) !important;
        }
        .step-connector::after {
            border-left-color: var(--text-color) !important;
        }
        /* Primary flat buttons */
        #generate-btn,
        #autofill-btn,
        #refine-btn,
        #download-pdf-btn,
        #download-html-btn {
            background: var(--secondary-color) !important;
            color: #ffffff !important;
            border: 2px solid var(--secondary-color) !important;
        }
        #generate-btn:hover,
        #autofill-btn:hover,
        #refine-btn:hover,
        #download-pdf-btn:hover,
        #download-html-btn:hover {
            background: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        /* Top nav adjustments */
        nav a { color: var(--text-color); }
        .container .border-secondary-200 { border-color: var(--border-color) !important; }
        .container .text-secondary-900 { color: var(--text-color) !important; }
        .container .text-secondary-700 { color: var(--light-text-color) !important; }
        .container .bg-secondary-900 { background-color: var(--primary-color) !important; }
        .container .bg-white\/80 { background-color: rgba(255,255,255,0.95) !important; }

        /* Square corners for boxes */
        .rounded-2xl, .rounded-xl, .rounded-3xl { border-radius: 0 !important; }
        .work-chart-card { padding: 12px !important; }
        /* Compact spacing */
        #chart-container .space-y-6 > * + * { margin-top: 12px !important; }
        #chart-container .space-y-4 > * + * { margin-top: 8px !important; }
        .step-connector { height: 2px !important; width: 36px !important; }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto px-4 py-6 md:py-10 max-w-6xl">
        <!-- Top Nav -->
        <nav class="flex items-center justify-between mb-8">
            <a href="./" class="flex items-center space-x-2">
                <span class="inline-block w-8 h-8 rounded-xl gradient-bg"></span>
                <span class="font-extrabold text-2xl text-secondary-900">The New Work Chart</span>
            </a>
            <div class="flex items-center space-x-3">
                <a href="about.html" class="px-4 py-2 rounded-xl bg-white/80 border border-secondary-200 text-secondary-800 hover:bg-white transition">About</a>
                <button onclick="manageApiKey()" class="px-4 py-2 rounded-xl bg-secondary-100 border border-secondary-200 text-secondary-800 hover:bg-secondary-200 transition text-sm font-medium" title="Manage Venice API Key">üîë API Key</button>
                <a href="#" class="px-4 py-2 rounded-xl bg-secondary-900 text-white hover:bg-secondary-800 transition" onclick="document.getElementById('input-section').scrollIntoView({behavior:'smooth'})">Get Started</a>
            </div>
        </nav>

        <!-- Hero Section (focused) -->
        <header class="text-center mb-10">
            <div class="gradient-bg text-white py-14 px-6 rounded-3xl shadow-2xl">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4">Design Workflows for Humans + AI</h1>
                <p class="text-lg md:text-xl font-light max-w-3xl mx-auto leading-relaxed">
                    Generate clear, beautiful work charts that map your process from trigger to outcome.
                </p>
            </div>
        </header>

        <main class="space-y-8">
            <!-- Input Section -->
            <div id="input-section" class="glass-effect p-8 rounded-3xl shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-secondary-900">1. Describe Your Workflow</h2>
                <p class="text-secondary-700 mb-6 text-lg">Enter a description of a project, job, or any workflow. For example: "A customer support process for handling refund requests."</p>
                <textarea 
                    id="workflow-input" 
                    class="w-full h-40 p-6 border-2 border-secondary-200 rounded-2xl focus:ring-4 focus:ring-primary-200 focus:border-primary-500 transition-all duration-300 text-lg resize-none" 
                    placeholder="Describe the workflow here..."
                ></textarea>
                <button 
                    id="generate-btn" 
                    class="mt-6 w-full bg-gradient-to-r from-primary-600 to-primary-700 text-white font-semibold py-4 px-8 rounded-2xl hover:from-primary-700 hover:to-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 text-lg shadow-lg"
                >
                    <span id="btn-text">Generate Initial Chart & Questions</span>
                    <span id="btn-loader" class="hidden">
                        <svg class="animate-spin h-6 w-6 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating with AI...
                    </span>
                </button>
            </div>

            <!-- Questions Section -->
            <div id="questions-section" class="hidden glass-effect p-8 rounded-3xl shadow-xl">
                <h2 class="text-3xl font-bold mb-6 text-secondary-900">2. Answer Clarifying Questions</h2>
                <p class="text-secondary-700 mb-8 text-lg">Your answers will help create a more accurate and detailed work chart.</p>
                <div id="questions-container" class="space-y-6"></div>
                <div class="mt-8 grid sm:grid-cols-2 gap-4">
                    <button 
                        id="autofill-btn" 
                        class="w-full bg-gradient-to-r from-primary-600 to-primary-700 text-white font-semibold py-4 px-8 rounded-2xl hover:from-primary-700 hover:to-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-50 text-lg shadow-lg"
                    >
                        <span id="autofill-btn-text">Draft Answers with AI</span>
                        <span id="autofill-btn-loader" class="hidden">
                            <svg class="animate-spin h-6 w-6 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Drafting...
                        </span>
                    </button>
                    <button 
                        id="refine-btn" 
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-semibold py-4 px-8 rounded-2xl hover:from-emerald-700 hover:to-emerald-800 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-50 text-lg shadow-lg"
                    >
                         <span id="refine-btn-text">Refine Work Chart</span>
                         <span id="refine-btn-loader" class="hidden">
                            <svg class="animate-spin h-6 w-6 text-white inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Refining with AI...
                        </span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="output-section" class="hidden">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-4 text-secondary-900">3. Your Generated Work Chart</h2>
                    <p class="text-secondary-700 text-xl">A dynamic map of how your work gets done</p>
                </div>
                
                <div class="glass-effect p-8 rounded-3xl shadow-xl">
                    <div class="overflow-x-auto pb-6">
                        <div id="chart-container" class="flex items-start justify-start space-x-16 p-6 min-w-max">
                            <!-- Chart will be generated here -->
                        </div>
                    </div>
                    
                    <!-- PDF Credits (hidden, only for PDF) -->
                    <div id="pdf-credits" class="hidden text-center py-6 border-t border-secondary-200 mt-8">
                        <p class="text-secondary-600 text-sm">Developed by Vivek + AI</p>
                    </div>
                    
                    <div class="flex justify-center mt-8">
                        <button 
                            id="download-pdf-btn" 
                            class="hidden bg-gradient-to-r from-purple-600 to-purple-700 text-white font-semibold py-4 px-8 rounded-2xl hover:from-purple-700 hover:to-purple-800 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all duration-300 transform hover:scale-105 shadow-lg text-lg"
                        >
                            üìÑ Download as PDF
                        </button>
                        <button 
                            id="download-html-btn" 
                            class="hidden ml-4 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-semibold py-4 px-8 rounded-2xl hover:from-emerald-700 hover:to-emerald-800 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition-all duration-300 transform hover:scale-105 shadow-lg text-lg"
                        >
                            üåê Download Comparison HTML
                        </button>
                    </div>
                </div>
                
                <!-- AI Agents & Tools Section -->
                <div id="ai-tools-section" class="hidden glass-effect p-8 rounded-3xl shadow-xl mt-8">
                    <h3 class="text-3xl font-bold mb-6 text-secondary-900">ü§ñ AI Agents & Tools Required</h3>
                    <p class="text-secondary-700 mb-6 text-lg">The following AI capabilities are needed for the AI-assisted workflow:</p>
                    <div id="ai-tools-container" class="space-y-4">
                        <!-- AI tools will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Error Section -->
            <div id="error-box" class="hidden bg-red-50 border-2 border-red-200 text-red-800 px-6 py-4 rounded-2xl shadow-lg" role="alert">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <strong class="font-semibold">Error:</strong>
                        <span class="block sm:inline ml-1" id="error-message"></span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        const generateBtn = document.getElementById('generate-btn');
        const refineBtn = document.getElementById('refine-btn');
        const autofillBtn = document.getElementById('autofill-btn');
        const workflowInput = document.getElementById('workflow-input');
        const questionsSection = document.getElementById('questions-section');
        const questionsContainer = document.getElementById('questions-container');
        const outputSection = document.getElementById('output-section');
        const chartContainer = document.getElementById('chart-container');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadHtmlBtn = document.getElementById('download-html-btn');
        const pdfCredits = document.getElementById('pdf-credits');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const aiToolsSection = document.getElementById('ai-tools-section');
        const aiToolsContainer = document.getElementById('ai-tools-container');
        
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const refineBtnText = document.getElementById('refine-btn-text');
        const refineBtnLoader = document.getElementById('refine-btn-loader');
        const autofillBtnText = document.getElementById('autofill-btn-text');
        const autofillBtnLoader = document.getElementById('autofill-btn-loader');

        let initialWorkChart = null; // kept for backward compatibility in autofill context
        let initialComparison = null;
        let currentWorkflowName = '';
        let analysisUsageByModel = {}; // accumulates { [modelId]: { inputTokens, outputTokens, calls } }

        // Venice API Configuration
        let API_KEY = getStoredApiKey();
        const API_URL = "https://api.venice.ai/api/v1/chat/completions";
        const MODEL = "qwen3-next-80b"; // Using Qwen 3 Next 80B - 262K context, excellent reasoning

        // Load API key from various sources
        function getStoredApiKey() {
            // First check for query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const keyParam = urlParams.get('api_key');
            if (keyParam) {
                localStorage.setItem('venice_api_key', keyParam);
                return keyParam;
            }

            // Fall back to localStorage
            return localStorage.getItem('venice_api_key') || '';
        }

        // Prompt for API key if not found
        function ensureApiKey() {
            if (!API_KEY) {
                const key = prompt('Please enter your Venice API key:');
                if (key) {
                    API_KEY = key;
                    localStorage.setItem('venice_api_key', key);
                    return true;
                }
                return false;
            }
            return true;
        }

        // Prefill from query string (workflow + actions)
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        (function prefillFromQuery(){
            const wf = getQueryParam('workflow');
            const actions = getQueryParam('actions');
            try {
                if (wf) {
                    workflowInput.value = decodeURIComponent(wf);
                }
            } catch(e) { /* ignore */ }
            try {
                if (actions) {
                    const parsed = JSON.parse(decodeURIComponent(actions));
                    if (Array.isArray(parsed) && parsed.length) {
                        currentWorkflowName = (workflowInput.value || '').substring(0,50);
                        // Kick off generation with light guidance appended
                        setTimeout(()=>{
                            if (!workflowInput.value) return;
                            const note = `\n\nContext: Actionable next steps already identified: ${parsed.map(a=>a.step_description).join('; ')}`;
                            workflowInput.value = (workflowInput.value || '') + note;
                            generateBtn.click();
                        }, 400);
                    }
                }
            } catch(e) { /* ignore */ }
        })();
        
        // Comparison schema (documentation only)
        const comparisonInitialSchema = {
            type: "object",
            properties: {
                currentProcess: {
                    type: "object",
                    properties: {
                        name: { type: "string" },
                        steps: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            step: { type: "string" },
                            task: { type: "string" },
                                    owner: { type: "string", enum: ["Human"] },
                            successTarget: { type: "string" },
                                    rule: { type: "string" },
                                    estimatedTimeMinutes: { type: "number" },
                                    estimatedCostUSD: { type: "number" }
                                },
                                required: ["step","task","owner","successTarget","rule","estimatedTimeMinutes","estimatedCostUSD"]
                            }
                        },
                        assumptions: { type: "array", items: { type: "string" } }
                    },
                    required: ["steps"]
                },
                futureProcess: {
                    type: "object",
                    properties: {
                        name: { type: "string" },
                        steps: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    step: { type: "string" },
                                    task: { type: "string" },
                                    owner: { type: "string", enum: ["Human","Agent","Hybrid"] },
                                    successTarget: { type: "string" },
                                    rule: { type: "string" },
                                    estimatedTimeMinutes: { type: "number" },
                                    estimatedCostUSD: { type: "number" }
                                },
                                required: ["step","task","owner","successTarget","rule","estimatedTimeMinutes","estimatedCostUSD"]
                            }
                        },
                        assumptions: { type: "array", items: { type: "string" } }
                    },
                    required: ["steps"]
                },
                questions: { type: "array", items: { type: "string" } }
            },
            required: ["currentProcess","futureProcess","questions"]
        };

        const comparisonRefinedSchema = {
            type: "object",
            properties: {
                currentProcess: comparisonInitialSchema.properties.currentProcess,
                futureProcess: comparisonInitialSchema.properties.futureProcess
            },
            required: ["currentProcess","futureProcess"]
        };

        // Venice model pricing (per 1M tokens, input/output)
        const MODEL_PRICING_PER_MTOK = {
            'venice-uncensored': { in: 0.20, out: 0.90 },
            'qwen-2.5-qwq-32b': { in: 0.50, out: 2.00 },
            'qwen3-4b': { in: 0.05, out: 0.15 },
            'mistral-32-24b': { in: 0.50, out: 2.00 },
            'mistral-31-24b': { in: 0.50, out: 2.00 },
            'qwen3-235b': { in: 0.90, out: 4.50 },
            'llama-3.2-3b': { in: 0.15, out: 0.60 },
            'llama-3.3-70b': { in: 0.70, out: 2.80 },
            'llama-3.1-405b': { in: 1.50, out: 6.00 },
            'dolphin-2.9.2-qwen2-72b': { in: 0.70, out: 2.80 },
            'qwen-2.5-vl': { in: 0.70, out: 2.80 },
            'qwen-2.5-coder-32b': { in: 0.50, out: 2.00 },
            'deepseek-r1-671b': { in: 3.50, out: 14.00 },
            'deepseek-coder-v2-lite': { in: 0.50, out: 2.00 }
        };

        function computeCostForModel(modelId, inputTokens, outputTokens) {
            const pricing = MODEL_PRICING_PER_MTOK[modelId] || { in: 0.50, out: 2.00 };
            const inCost = (Number(inputTokens || 0) / 1_000_000) * pricing.in;
            const outCost = (Number(outputTokens || 0) / 1_000_000) * pricing.out;
            return inCost + outCost;
        }

        function calculateAnalysisCostTotals() {
            let totalCost = 0;
            const byModel = {};
            Object.entries(analysisUsageByModel || {}).forEach(([modelId, usage]) => {
                const cost = computeCostForModel(modelId, usage.inputTokens, usage.outputTokens);
                totalCost += cost;
                byModel[modelId] = (byModel[modelId] || 0) + cost;
            });
            const breakdownLabel = Object.keys(byModel).length
                ? Object.entries(byModel).map(([m, c]) => `${m}: ${formatCurrency(c)}`).join(' ‚Ä¢ ')
                : '';
            return { totalCost, breakdownLabel };
        }

        async function makeApiCall(systemPrompt, userPrompt, schema, modelOverride) {
            let retries = 3;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const payload = {
                        model: modelOverride || MODEL,
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user", 
                                content: userPrompt
                            }
                        ],
                        temperature: 0.7,
                        max_completion_tokens: 30000
                    };

                    console.log('Venice API Request:', JSON.stringify(payload, null, 2));
                    console.log('API Key being used:', API_KEY ? `${API_KEY.substring(0, 8)}...${API_KEY.substring(API_KEY.length - 4)} (length: ${API_KEY.length})` : 'EMPTY/NULL');

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
                        console.error('Venice API Error:', errorData);
                        throw new Error(`API Error (${response.status}): ${errorData.error?.message || errorData.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const content = result.choices?.[0]?.message?.content;

                    if (!content) {
                        throw new Error("Invalid response structure from the API.");
                    }
                    
                    // Extract JSON from the content (in case there's extra text)
                    let jsonStr = content.trim();
                    const jsonStart = jsonStr.indexOf('{');
                    const jsonEnd = jsonStr.lastIndexOf('}');
                    
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        jsonStr = jsonStr.substring(jsonStart, jsonEnd + 1);
                    }
                    
                    // Track token usage for analysis cost
                    try {
                        const modelId = result.model || modelOverride || MODEL;
                        const usage = result.usage || result.choices?.[0]?.usage || {};
                        const inputTokens = usage.prompt_tokens ?? usage.input_tokens ?? usage.promptTokens ?? usage.input ?? 0;
                        const outputTokens = usage.completion_tokens ?? usage.output_tokens ?? usage.completionTokens ?? usage.output ?? 0;
                        const entry = analysisUsageByModel[modelId] || { inputTokens: 0, outputTokens: 0, calls: 0 };
                        entry.inputTokens += Number(inputTokens || 0);
                        entry.outputTokens += Number(outputTokens || 0);
                        entry.calls += 1;
                        analysisUsageByModel[modelId] = entry;
                    } catch (e) { /* ignore usage errors */ }

                    return JSON.parse(jsonStr);

                } catch (error) {
                    console.error("API call failed:", error);
                    retries--;
                    if (retries === 0) {
                        showError(`Failed to get a response after multiple attempts. ${error.message}`);
                        return null;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        generateBtn.addEventListener('click', async () => {
            if (!ensureApiKey()) {
                showError("API key is required. Please enter your Venice API key when prompted.");
                return;
            }

            const userInput = workflowInput.value.trim();
            if (!userInput) {
                showError("Please describe your workflow first.");
                return;
            }

            currentWorkflowName = userInput.substring(0, 50).replace(/[^a-zA-Z0-9\s]/g, '').trim();

            setLoadingState(generateBtn, btnLoader, btnText, true);
            hideError();
            
            const systemPrompt = `You are an expert business process analyst. Based on the workflow description, produce BOTH the current human-only process and a future AI-assisted process.
Rules:
- The current process must assign owner = "Human" for every step.
- The future process can use owner = "Human", "Agent", or "Hybrid".
- For every step, estimate time in minutes. Do NOT include human labor cost.
- For Agent or Hybrid steps, include a compute object: { "modelId": string, "estimatedInputTokens": number, "estimatedOutputTokens": number, "notes": string, "tools": ["list of tools/capabilities needed"] }.
- Keep step lists aligned where possible so comparisons are clear.
- Ask enough clarifying questions to resolve ambiguities (no hard limit; include as many as needed).
Return ONLY JSON with this exact structure:
{
  "currentProcess": {"name": "string", "steps": [{"step": "string", "task": "string", "owner": "Human", "successTarget": "string", "rule": "string", "estimatedTimeMinutes": number}], "assumptions": ["string"]},
  "futureProcess": {"name": "string", "steps": [{"step": "string", "task": "string", "owner": "Human|Agent|Hybrid", "successTarget": "string", "rule": "string", "estimatedTimeMinutes": number, "compute": {"modelId": "string", "estimatedInputTokens": number, "estimatedOutputTokens": number, "notes": "string", "tools": ["string"]}}], "assumptions": ["string"]},
  "questions": ["string"]
}`;

            const userPrompt = `Workflow description: "${userInput}"`;
            
            const data = await makeApiCall(systemPrompt, userPrompt, comparisonInitialSchema);

            if (data) {
                initialComparison = data;
                // for autofill context
                initialWorkChart = data.futureProcess?.steps?.map(s => ({ step: s.step, task: s.task, owner: s.owner, successTarget: s.successTarget, rule: s.rule })) || [];
                renderComparison(initialComparison, true);
                renderQuestions(data.questions || []);
                renderAITools(data.futureProcess);
                outputSection.classList.remove('hidden');
                questionsSection.classList.remove('hidden');
                downloadPdfBtn.classList.remove('hidden');
                downloadHtmlBtn.classList.remove('hidden');
                document.getElementById('output-section').scrollIntoView({ behavior: 'smooth' });
            }

            setLoadingState(generateBtn, btnLoader, btnText, false);
        });

        refineBtn.addEventListener('click', async () => {
            const answers = [];
            const questionElements = document.querySelectorAll('.question-item');
            questionElements.forEach(q => {
                const question = q.querySelector('label').innerText;
                const answer = q.querySelector('input').value.trim();
                if(answer){
                    answers.push({ question, answer });
                }
                
            });

            if (answers.length === 0) {
                showError("Please answer at least one question to refine the chart.");
                return;
            }
            
            setLoadingState(refineBtn, refineBtnLoader, refineBtnText, true);
            hideError();

            const systemPrompt = `You are an expert business process analyst. Refine BOTH the current human-only process and the future AI-assisted process using the user's answers.
Constraints:
- Current process must keep owner = "Human" for all steps.
- Estimate time (minutes) for each step. Do NOT include human labor cost.
- For Agent or Hybrid steps, include/adjust the compute object: { modelId, estimatedInputTokens, estimatedOutputTokens, notes, tools: ["list of tools/capabilities needed"] }.
Return ONLY JSON of the form:
{
  "currentProcess": {"name": "string", "steps": [{"step": "string", "task": "string", "owner": "Human", "successTarget": "string", "rule": "string", "estimatedTimeMinutes": number}], "assumptions": ["string"]},
  "futureProcess": {"name": "string", "steps": [{"step": "string", "task": "string", "owner": "Human|Agent|Hybrid", "successTarget": "string", "rule": "string", "estimatedTimeMinutes": number, "compute": {"modelId": "string", "estimatedInputTokens": number, "estimatedOutputTokens": number, "notes": "string", "tools": ["string"]}}], "assumptions": ["string"]}
}`;

            const userPrompt = `Original Workflow: "${workflowInput.value.trim()}"

Initial Comparison (for context):
${JSON.stringify(initialComparison || {}, null, 2)}
                
                User's Answers:
${answers.map(a => `- Q: ${a.question}\n  A: ${a.answer}`).join('\n')}`;

            const data = await makeApiCall(systemPrompt, userPrompt, comparisonRefinedSchema);

            if (data && data.currentProcess && data.futureProcess) {
                initialComparison = data;
                renderComparison(data, false);
                renderAITools(data.futureProcess);
                questionsSection.classList.add('hidden');
                downloadPdfBtn.classList.remove('hidden');
                downloadHtmlBtn.classList.remove('hidden');
            }
            
            setLoadingState(refineBtn, refineBtnLoader, refineBtnText, false);
        });

        // Auto-fill answers using Venice Mistral model
        autofillBtn?.addEventListener('click', async () => {
            const questions = Array.from(document.querySelectorAll('.question-item label')).map(l => l.innerText.trim());
            if (!questions.length) {
                showError('No questions available to auto-fill yet.');
                return;
            }

            setLoadingState(autofillBtn, autofillBtnLoader, autofillBtnText, true);
            hideError();

            const systemPrompt = `You are assisting with workflow clarification. For the given original workflow and the initial work chart steps, draft concise, practical first-pass answers to each question. Keep each answer to one sentence, be specific, and assume reasonable defaults if unspecified.`;

            const userPrompt = `Original Workflow: "${workflowInput.value.trim()}"

Initial Steps (for context):
${JSON.stringify(initialWorkChart || [], null, 2)}

Questions to answer:
${questions.map((q, i) => `${i + 1}. ${q}`).join('\n')}

Return ONLY a JSON object of the form:
{"answers": ["answer 1", "answer 2", ...]}`;

            const resp = await makeApiCall(systemPrompt, userPrompt, null, 'mistral-31-24b');
            if (resp && Array.isArray(resp.answers)) {
                const inputs = Array.from(document.querySelectorAll('.question-item input'));
                inputs.forEach((inp, idx) => {
                    if (resp.answers[idx]) inp.value = resp.answers[idx];
                });
            }

            setLoadingState(autofillBtn, autofillBtnLoader, autofillBtnText, false);
        });

        downloadPdfBtn.addEventListener('click', () => {
            if (!initialComparison) return;

            // Build a horizontal flow layout specifically for PDF capture
            const pdfRoot = buildPdfFlow(initialComparison);
            document.body.appendChild(pdfRoot);

            const fullWidth = pdfRoot.scrollWidth;
            const fullHeight = pdfRoot.scrollHeight;

            html2canvas(pdfRoot, {
                scale: 2,
                scrollX: 0,
                scrollY: 0,
                backgroundColor: '#ffffff',
                width: fullWidth,
                height: fullHeight,
                windowWidth: fullWidth,
                windowHeight: fullHeight,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);

                const filename = currentWorkflowName ? `work-chart-${slugify(currentWorkflowName)}.pdf` : 'work-chart.pdf';
                pdf.save(filename);

                // Cleanup
                document.body.removeChild(pdfRoot);
            });
        });

        function buildPdfFlow(data) {
            const { currentProcess, futureProcess } = data;
            const cardWidth = 220;
            const spacing = 24;
            const maxSteps = Math.max(currentProcess.steps?.length || 0, futureProcess.steps?.length || 0);
            const width = Math.max(1200, (cardWidth + spacing) * maxSteps + 120);

            const totalsCurrent = calculateTotals(currentProcess.steps || []);
            const totalsFuture = calculateTotals(futureProcess.steps || []);
            const savingsMinutes = Math.max(0, totalsCurrent.minutes - totalsFuture.minutes);

            const root = document.createElement('div');
            root.id = 'pdf-flow-root';
            root.style.position = 'fixed';
            root.style.top = '-10000px';
            root.style.left = '-10000px';
            root.style.background = '#ffffff';
            root.style.padding = '24px';
            root.style.width = `${width}px`;

            const header = document.createElement('div');
            header.className = 'grid grid-cols-3 gap-4 mb-6';
            header.innerHTML = `
                <div class="bg-white border-2 border-secondary-200 rounded-2xl p-5 shadow">
                    <div class="text-secondary-600 text-sm">Current Total Time</div>
                    <div class="text-2xl font-extrabold text-secondary-900">${formatTime(totalsCurrent.minutes)}</div>
                </div>
                <div class="bg-white border-2 border-secondary-200 rounded-2xl p-5 shadow">
                    <div class="text-secondary-600 text-sm">Future Total Time</div>
                    <div class="text-2xl font-extrabold text-secondary-900">${formatTime(totalsFuture.minutes)}</div>
                </div>
                <div class="bg-emerald-50 border-2 border-emerald-200 rounded-2xl p-5 shadow">
                    <div class="text-emerald-700 text-sm">Estimated Time Savings</div>
                    <div class="text-2xl font-extrabold text-emerald-900">${formatTime(savingsMinutes)}</div>
                </div>`;

            const lanes = document.createElement('div');
            lanes.className = 'space-y-6';
            lanes.appendChild(buildLane('Current Process ‚Äî Human Only', currentProcess.steps || [], cardWidth));
            lanes.appendChild(buildLane('Future Process ‚Äî AI-Assisted', futureProcess.steps || [], cardWidth, true));

            root.appendChild(header);
            root.appendChild(lanes);
            return root;
        }

        function buildLane(title, steps, cardWidth, showCompute = false) {
            const lane = document.createElement('div');
            lane.className = 'bg-white border-2 border-secondary-200 rounded-2xl p-5 shadow';

            const h = document.createElement('div');
            h.className = 'text-lg font-bold text-secondary-900 mb-3';
            h.textContent = title;

            const row = document.createElement('div');
            row.className = 'flex items-start';

            const ownerColors = {
                'Human': 'bg-blue-100 text-blue-800 border-blue-200',
                'Agent': 'bg-purple-100 text-purple-800 border-purple-200',
                'Hybrid': 'bg-emerald-100 text-emerald-800 border-emerald-200'
            };

            (steps || []).forEach((step, index) => {
                const ownerColor = ownerColors[step.owner] || 'bg-secondary-100 text-secondary-800 border-secondary-200';
                const card = document.createElement('div');
                card.className = 'relative work-chart-card border-2 border-secondary-200 rounded-2xl p-3 mr-6';
                card.style.width = `${cardWidth}px`;
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="pr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full border ${ownerColor}">${step.owner}</span>
                                <span class="text-sm font-semibold text-secondary-900">${step.step}</span>
                            </div>
                            <div class="text-secondary-800 font-medium">${step.task}</div>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm text-secondary-700">
                                <div>üéØ <span class="font-semibold text-secondary-900">Target:</span> ${step.successTarget}</div>
                                <div>‚öñÔ∏è <span class="font-semibold text-secondary-900">Rule:</span> ${step.rule}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-secondary-600">Time</div>
                            <div class="text-base font-extrabold text-secondary-900">${formatTime(step.estimatedTimeMinutes || 0)}</div>
                            ${showCompute && step.compute ? `<div class=\"mt-2 text-xs text-secondary-600\">${step.compute.modelId} ¬∑ in ${formatTokens(step.compute.estimatedInputTokens)} ¬∑ out ${formatTokens(step.compute.estimatedOutputTokens)}</div>` : ''}
                        </div>
                    </div>`;

                if (index < steps.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'step-connector';
                    card.appendChild(connector);
                }
                row.appendChild(card);
            });

            lane.appendChild(h);
            lane.appendChild(row);
            return lane;
        }

        downloadHtmlBtn.addEventListener('click', () => {
            if (!initialComparison) return;
            const html = generateConsultantHtml(initialComparison, currentWorkflowName);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const filename = currentWorkflowName ? `before-after-${slugify(currentWorkflowName)}.html` : 'before-after.html';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function renderWorkChart(workChartData, isDraft) {
            // kept for compatibility; shows a linear chart if needed
            chartContainer.className = 'flex items-start justify-start space-x-16 p-6 min-w-max';
            chartContainer.innerHTML = '';
            workChartData.forEach((step, index) => {
                const ownerColors = {
                    'Human': 'bg-blue-100 text-blue-800 border-blue-200',
                    'Agent': 'bg-purple-100 text-purple-800 border-purple-200',
                    'Hybrid': 'bg-emerald-100 text-emerald-800 border-emerald-200'
                };
                const ownerColor = ownerColors[step.owner] || 'bg-secondary-100 text-secondary-800 border-secondary-200';

                const card = document.createElement('div');
                card.className = `work-chart-card relative flex-shrink-0 w-80 bg-white p-6 rounded-2xl shadow-lg border-2 ${isDraft ? 'border-dashed border-secondary-300' : 'border-secondary-200'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-secondary-900 leading-tight pr-2">${step.step}</h3>
                        <span class="text-sm font-semibold px-3 py-1.5 rounded-full border ${ownerColor} flex-shrink-0">${step.owner}</span>
                    </div>
                    <p class="text-secondary-800 font-medium mb-6 leading-relaxed">${step.task}</p>
                    <div class="text-sm text-secondary-700 space-y-3">
                        <div class="flex items-start space-x-2">
                            <span class="text-lg">üéØ</span>
                            <div>
                                <span class="font-semibold text-secondary-900">Target:</span>
                                <p class="mt-1">${step.successTarget}</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-lg">‚öñÔ∏è</span>
                            <div>
                                <span class="font-semibold text-secondary-900">Rule:</span>
                                <p class="mt-1">${step.rule}</p>
                            </div>
                        </div>
                    </div>
                `;

                if (index < workChartData.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'step-connector';
                    card.appendChild(connector);
                }

                chartContainer.appendChild(card);
            });
        }

        function renderComparison(comparisonData, isDraft) {
            const { currentProcess, futureProcess } = comparisonData;
            chartContainer.className = 'w-full p-6 space-y-6';
            chartContainer.innerHTML = '';

            const totalsCurrent = calculateTotals(currentProcess.steps || []);
            const totalsFuture = calculateTotals(futureProcess.steps || []);
            const computeTotals = calculateComputeTotals(futureProcess.steps || []);
            const analysisTotals = calculateAnalysisCostTotals();

            const savingsMinutes = Math.max(0, totalsCurrent.minutes - totalsFuture.minutes);

            const header = document.createElement('div');
            header.className = 'w-full mb-6';
            header.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 w-full">
                    <div class="bg-white border-2 ${isDraft ? 'border-dashed border-secondary-300' : 'border-secondary-200'} rounded-2xl p-5 shadow">
                        <div class="text-secondary-600 text-sm">Current Total Time</div>
                        <div class="text-2xl font-extrabold text-secondary-900">${formatTime(totalsCurrent.minutes)}</div>
                    </div>
                    <div class="bg-white border-2 ${isDraft ? 'border-dashed border-secondary-300' : 'border-secondary-200'} rounded-2xl p-5 shadow">
                        <div class="text-secondary-600 text-sm">Future Total Time</div>
                        <div class="text-2xl font-extrabold text-secondary-900">${formatTime(totalsFuture.minutes)}</div>
                    </div>
                    <div class="bg-emerald-50 border-2 border-emerald-200 rounded-2xl p-5 shadow">
                        <div class="text-emerald-700 text-sm">Estimated Time Savings</div>
                        <div class="text-2xl font-extrabold text-emerald-900">${formatTime(savingsMinutes)}</div>
                    </div>
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 lg:grid-cols-2 gap-8 w-full';

            grid.appendChild(renderProcessColumn(currentProcess, 'Current Process ‚Äî Human Only', true, isDraft));
            grid.appendChild(renderProcessColumn(futureProcess, 'Future Process ‚Äî AI-Assisted', false, isDraft));

            chartContainer.appendChild(header);
            chartContainer.appendChild(grid);
        }

        function renderProcessColumn(process, title, isCurrent, isDraft) {
            const col = document.createElement('div');
            col.className = '';

            const container = document.createElement('div');
            container.className = `bg-white p-4 rounded-2xl shadow-lg border-2 ${isDraft ? 'border-dashed border-secondary-300' : 'border-secondary-200'}`;

            const heading = document.createElement('div');
            heading.className = 'flex items-center justify-between mb-3';
            heading.innerHTML = `
                <h3 class="text-lg font-bold text-secondary-900">${title}</h3>
                <span class="text-sm text-secondary-600">${process.name || ''}</span>
            `;

            const list = document.createElement('div');
            list.className = 'space-y-3';

            process.steps.forEach((step, idx) => {
                const ownerColors = {
                    'Human': 'bg-blue-100 text-blue-800 border-blue-200',
                    'Agent': 'bg-purple-100 text-purple-800 border-purple-200',
                    'Hybrid': 'bg-emerald-100 text-emerald-800 border-emerald-200'
                };
                const ownerColor = ownerColors[step.owner] || 'bg-secondary-100 text-secondary-800 border-secondary-200';

                const card = document.createElement('div');
                card.className = 'work-chart-card border-2 border-secondary-200 rounded-xl p-3';
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="pr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full border ${ownerColor}">${step.owner}</span>
                                <span class="text-sm font-semibold text-secondary-900">${step.step}</span>
                            </div>
                            <div class="text-secondary-800 font-medium">${step.task}</div>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm text-secondary-700">
                                <div>üéØ <span class="font-semibold text-secondary-900">Target:</span> ${step.successTarget}</div>
                                <div>‚öñÔ∏è <span class="font-semibold text-secondary-900">Rule:</span> ${step.rule}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-secondary-600">Time</div>
                            <div class="text-base font-extrabold text-secondary-900">${formatTime(step.estimatedTimeMinutes || 0)}</div>
                            ${step.compute ? `<div class=\"mt-2 text-xs text-secondary-600\">${step.compute.modelId} ¬∑ in ${formatTokens(step.compute.estimatedInputTokens)} ¬∑ out ${formatTokens(step.compute.estimatedOutputTokens)}</div>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });

            const totals = calculateTotals(process.steps || []);
            const footer = document.createElement('div');
            footer.className = 'mt-3 pt-3 border-t border-secondary-200 flex items-center justify-between';
            footer.innerHTML = `
                <div class="text-sm text-secondary-700">Assumptions: ${(process.assumptions || []).slice(0,3).join(' ‚Ä¢ ')}</div>
                <div class="text-right">
                    <div class="text-sm text-secondary-600">Total Time</div>
                    <div class="text-base font-extrabold text-secondary-900">${formatTime(totals.minutes)}</div>
                </div>
            `;

            container.appendChild(heading);
            container.appendChild(list);
            container.appendChild(footer);
            col.appendChild(container);
            return col;
        }

        function calculateTotals(steps) {
            const totals = steps.reduce((acc, s) => {
                acc.minutes += Number(s.estimatedTimeMinutes || 0);
                return acc;
            }, { minutes: 0 });
            return totals;
        }

        function calculateComputeTotals(steps) {
            let totalCost = 0;
            const byModel = {};
            (steps || []).forEach(s => {
                if (s && s.compute && s.compute.modelId) {
                    const { modelId, estimatedInputTokens, estimatedOutputTokens } = s.compute;
                    const cost = computeCostForModel(modelId, estimatedInputTokens, estimatedOutputTokens);
                    totalCost += cost;
                    byModel[modelId] = (byModel[modelId] || 0) + cost;
                }
            });
            const breakdownLabel = Object.keys(byModel).length
                ? Object.entries(byModel).map(([m, c]) => `${m}: ${formatCurrency(c)}`).join(' ‚Ä¢ ')
                : '';
            return { totalCost, breakdownLabel };
        }

        function formatTime(minutes) {
            const m = Math.round(minutes || 0);
            if (m < 60) return `${m} min`;
            const h = Math.floor(m / 60);
            const rem = m % 60;
            return rem ? `${h}h ${rem}m` : `${h}h`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(Number(amount || 0));
        }

        function formatTokens(toks) {
            const n = Number(toks || 0);
            if (n < 1000) return `${n} tok`;
            if (n < 1_000_000) return `${Math.round(n/100)/10}k`;
            return `${Math.round(n/100000)/10}M`;
        }

        function slugify(str) {
            return (str || '').toLowerCase().replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-');
        }

        function generateConsultantHtml(data, workflowName) {
            const { currentProcess, futureProcess } = data;
            const totalsCurrent = calculateTotals(currentProcess.steps || []);
            const totalsFuture = calculateTotals(futureProcess.steps || []);
            const savingsMinutes = Math.max(0, totalsCurrent.minutes - totalsFuture.minutes);
            const generatedDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const escape = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

            const formatText = (text) => {
                if (!text) return '';
                return String(text)
                    .replace(/\n\n+/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
            };

            const buildCoverPage = () => {
                return `
        <div class="cover-page">
            <div class="cover-content">
                <h1 class="cover-title">${escape(workflowName || 'Work Chart Analysis')}</h1>
                <p class="cover-subtitle">Current vs Future Process Comparison</p>
                <div class="cover-meta">
                    <p>Generated on ${generatedDate}</p>
                    <p>Work Chart</p>
                </div>
            </div>
        </div>`;
            };

            const buildTableOfContents = () => {
                return `
        <div class="toc-section" id="toc">
            <h2 class="toc-title">Table of Contents</h2>
            <a href="#summary" class="toc-item">
                <span class="toc-number">1</span>
                <span class="toc-title-text">Executive Summary</span>
            </a>
            <a href="#current-process" class="toc-item">
                <span class="toc-number">2</span>
                <span class="toc-title-text">Current Process ‚Äî Human Only</span>
            </a>
            <a href="#future-process" class="toc-item">
                <span class="toc-number">3</span>
                <span class="toc-title-text">Future Process ‚Äî AI-Assisted</span>
            </a>
            ${futureProcess.steps && futureProcess.steps.some(s => (s.owner === 'Agent' || s.owner === 'Hybrid') && s.compute) ? `
            <a href="#ai-tools" class="toc-item">
                <span class="toc-number">4</span>
                <span class="toc-title-text">AI Agents & Tools Required</span>
            </a>
            ` : ''}
        </div>`;
            };

            const buildSummarySection = () => {
                return `
        <div class="content-section" id="summary">
            <div class="section-header">
                <h1 class="section-title">Executive Summary</h1>
            </div>
            
            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-label">Current Total Time</div>
                    <div class="summary-value">${formatTime(totalsCurrent.minutes)}</div>
                </div>
                <div class="summary-box">
                    <div class="summary-label">Future Total Time</div>
                    <div class="summary-value">${formatTime(totalsFuture.minutes)}</div>
                </div>
                <div class="summary-box highlight">
                    <div class="summary-label">Estimated Time Savings</div>
                    <div class="summary-value highlight-value">${formatTime(savingsMinutes)}</div>
                </div>
            </div>
            
            <div class="content-block">
                <p>This analysis compares the current human-only workflow with a future AI-assisted implementation. The analysis identifies ${currentProcess.steps?.length || 0} steps in the current process and ${futureProcess.steps?.length || 0} steps in the optimized future process.</p>
            </div>
            
            <div class="section-navigation">
                <a href="#toc" class="back-to-top-link">‚Üë Back to Table of Contents</a>
            </div>
            
            <div class="page-break"></div>
        </div>`;
            };

            const renderSteps = (steps) => steps.map((s, idx) => {
                const ownerClass = s.owner === 'Human' ? 'owner-human' : s.owner === 'Agent' ? 'owner-agent' : 'owner-hybrid';
                return `
                <div class="step-box">
                    <div class="step-header">
                        <span class="owner-badge ${ownerClass}">${escape(s.owner)}</span>
                        <span class="step-name">${escape(s.step)}</span>
                        <span class="step-time">${formatTime(s.estimatedTimeMinutes || 0)}</span>
                    </div>
                    <div class="step-task">${escape(s.task)}</div>
                    <div class="step-details">
                        <div class="step-detail-item">
                            <strong>Target:</strong> ${escape(s.successTarget)}
                        </div>
                        <div class="step-detail-item">
                            <strong>Rule:</strong> ${escape(s.rule)}
                        </div>
                        ${s.compute ? `
                        <div class="step-compute">
                            <strong>AI Model:</strong> ${escape(s.compute.modelId)}<br>
                            ${s.compute.notes ? `<em>${escape(s.compute.notes)}</em>` : ''}
                            ${s.compute.tools && s.compute.tools.length > 0 ? `
                            <div class="step-tools">
                                <strong>Tools:</strong> ${s.compute.tools.map(t => escape(t)).join(', ')}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');

            const buildCurrentProcessSection = () => {
                return `
        <div class="content-section" id="current-process">
            <div class="section-header">
                <h1 class="section-title">Current Process ‚Äî Human Only</h1>
                ${currentProcess.name ? `<p class="section-subtitle">${escape(currentProcess.name)}</p>` : ''}
            </div>
            
            <div class="process-steps">
                ${renderSteps(currentProcess.steps || [])}
            </div>
            
            ${currentProcess.assumptions && currentProcess.assumptions.length > 0 ? `
            <div class="content-block">
                <h2>Assumptions</h2>
                <ul class="assumptions-list">
                    ${currentProcess.assumptions.map(a => `<li>${escape(a)}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            
            <div class="section-navigation">
                <a href="#toc" class="back-to-top-link">‚Üë Back to Table of Contents</a>
            </div>
            
            <div class="page-break"></div>
        </div>`;
            };

            const buildFutureProcessSection = () => {
                return `
        <div class="content-section" id="future-process">
            <div class="section-header">
                <h1 class="section-title">Future Process ‚Äî AI-Assisted</h1>
                ${futureProcess.name ? `<p class="section-subtitle">${escape(futureProcess.name)}</p>` : ''}
            </div>
            
            <div class="process-steps">
                ${renderSteps(futureProcess.steps || [])}
            </div>
            
            ${futureProcess.assumptions && futureProcess.assumptions.length > 0 ? `
            <div class="content-block">
                <h2>Assumptions</h2>
                <ul class="assumptions-list">
                    ${futureProcess.assumptions.map(a => `<li>${escape(a)}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            
            <div class="section-navigation">
                <a href="#toc" class="back-to-top-link">‚Üë Back to Table of Contents</a>
            </div>
            
            ${futureProcess.steps && futureProcess.steps.some(s => (s.owner === 'Agent' || s.owner === 'Hybrid') && s.compute) ? '<div class="page-break"></div>' : ''}
        </div>`;
            };

            const buildAIToolsSection = () => {
                const agentSteps = [];
                const toolsMap = new Map();
                
                (futureProcess.steps || []).forEach(step => {
                    if ((step.owner === 'Agent' || step.owner === 'Hybrid') && step.compute) {
                        agentSteps.push({
                            step: step.step,
                            owner: step.owner,
                            modelId: step.compute.modelId,
                            notes: step.compute.notes,
                            tools: step.compute.tools || []
                        });
                        
                        if (step.compute.tools && Array.isArray(step.compute.tools)) {
                            step.compute.tools.forEach(tool => {
                                if (!toolsMap.has(tool)) {
                                    toolsMap.set(tool, []);
                                }
                                toolsMap.get(tool).push(step.step);
                            });
                        }
                    }
                });
                
                if (agentSteps.length === 0) return '';
                
                return `
        <div class="content-section" id="ai-tools">
            <div class="section-header">
                <h1 class="section-title">AI Agents & Tools Required</h1>
                <p class="section-subtitle">AI capabilities needed for the AI-assisted workflow</p>
            </div>
            
            <div class="content-block">
                ${agentSteps.map(item => {
                    const ownerClass = item.owner === 'Agent' ? 'owner-agent' : 'owner-hybrid';
                    return `
                    <div class="tool-box">
                        <div class="tool-header">
                            <span class="owner-badge ${ownerClass}">${escape(item.owner)}</span>
                            <span class="tool-step-name">${escape(item.step)}</span>
                        </div>
                        <div class="tool-details">
                            <div><strong>Model:</strong> ${escape(item.modelId)}</div>
                            ${item.notes ? `<div class="tool-notes">${escape(item.notes)}</div>` : ''}
                            ${item.tools.length > 0 ? `
                            <div class="tool-capabilities">
                                <strong>Required Capabilities:</strong>
                                <div class="capability-tags">
                                    ${item.tools.map(t => `<span class="capability-tag">${escape(t)}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>`;
                }).join('')}
            </div>
            
            ${toolsMap.size > 0 ? `
            <div class="content-block">
                <h2>Capability Summary</h2>
                <ul class="capability-summary">
                    ${Array.from(toolsMap.entries()).map(([tool, steps]) => `
                    <li><strong>${escape(tool)}</strong> ‚Äî used in ${steps.length} step${steps.length > 1 ? 's' : ''}</li>
                    `).join('')}
                </ul>
            </div>
            ` : ''}
            
            <div class="section-navigation">
                <a href="#toc" class="back-to-top-link">‚Üë Back to Table of Contents</a>
            </div>
        </div>`;
            };

            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${escape(workflowName || 'Work Chart Analysis')}</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html { scroll-behavior: smooth; }
    
    body {
      font-family: 'Montserrat', sans-serif;
      line-height: 1.7;
      color: #1a1a1a;
      background: #ffffff;
      font-size: 14px;
    }
    
    .document-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 50px;
      background: white;
    }
    
    /* Cover Page */
    .cover-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 40px;
    }
    
    .cover-content {
      text-align: center;
    }
    
    .cover-title {
      font-size: 42px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 16px;
    }
    
    .cover-subtitle {
      font-size: 20px;
      color: #4a4a4a;
      margin-bottom: 40px;
    }
    
    .cover-meta {
      font-size: 14px;
      color: #666;
      margin-top: 60px;
    }
    
    .cover-meta p {
      margin: 8px 0;
    }
    
    /* Table of Contents */
    .toc-section {
      margin: 60px 0;
      padding: 40px 0;
      border-top: 1px solid #e0e0e0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .toc-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 30px;
    }
    
    .toc-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      text-decoration: none;
      color: inherit;
      transition: background-color 0.2s ease;
    }
    
    .toc-item:hover {
      background-color: #f8f9fa;
      padding-left: 8px;
      padding-right: 8px;
      margin-left: -8px;
      margin-right: -8px;
    }
    
    .toc-number {
      font-weight: 600;
      color: #666;
      margin-right: 12px;
      min-width: 24px;
    }
    
    .toc-title-text {
      flex: 1;
    }
    
    /* Content Sections */
    .content-section {
      margin: 80px 0;
    }
    
    .section-header {
      border-bottom: 2px solid #1a1a1a;
      padding-bottom: 20px;
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 12px;
    }
    
    .section-subtitle {
      font-size: 16px;
      color: #4a4a4a;
      font-weight: 400;
    }
    
    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 40px 0;
    }
    
    .summary-box {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      padding: 24px;
      text-align: center;
    }
    
    .summary-box.highlight {
      background: #e8f5e9;
      border-color: #4caf50;
    }
    
    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .summary-value.highlight-value {
      color: #2e7d32;
    }
    
    /* Content Blocks */
    .content-block {
      margin: 30px 0;
    }
    
    .content-block h2 {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
    }
    
    .content-block p {
      margin: 12px 0;
      line-height: 1.8;
    }
    
    /* Step Boxes */
    .process-steps {
      margin: 30px 0;
    }
    
    .step-box {
      border: 1px solid #e0e0e0;
      border-left: 4px solid #1a1a1a;
      padding: 20px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .owner-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .owner-human {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #90caf9;
    }
    
    .owner-agent {
      background: #f3e5f5;
      color: #7b1fa2;
      border: 1px solid #ce93d8;
    }
    
    .owner-hybrid {
      background: #e8f5e9;
      color: #388e3c;
      border: 1px solid #81c784;
    }
    
    .step-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      flex: 1;
    }
    
    .step-time {
      font-size: 14px;
      font-weight: 600;
      color: #4a4a4a;
    }
    
    .step-task {
      font-size: 14px;
      color: #4a4a4a;
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    .step-details {
      font-size: 13px;
      color: #666;
    }
    
    .step-detail-item {
      margin: 8px 0;
    }
    
    .step-compute {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .step-tools {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
    }
    
    /* Tool Boxes */
    .tool-box {
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    
    .tool-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .tool-step-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .tool-details {
      font-size: 14px;
      color: #4a4a4a;
    }
    
    .tool-notes {
      margin: 8px 0;
      font-style: italic;
      color: #666;
    }
    
    .tool-capabilities {
      margin-top: 12px;
    }
    
    .capability-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .capability-tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .capability-summary {
      list-style: none;
      padding: 0;
    }
    
    .capability-summary li {
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    /* Assumptions */
    .assumptions-list {
      list-style: disc;
      padding-left: 24px;
      color: #4a4a4a;
    }
    
    .assumptions-list li {
      margin: 8px 0;
      line-height: 1.6;
    }
    
    /* Navigation */
    .section-navigation {
      margin-top: 60px;
      padding-top: 30px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
    }
    
    .back-to-top-link {
      display: inline-block;
      padding: 12px 24px;
      background: #f8f9fa;
      color: #1a1a1a;
      text-decoration: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      border: 1px solid #e0e0e0;
    }
    
    .back-to-top-link:hover {
      background: #1a1a1a;
      color: #ffffff;
      border-color: #1a1a1a;
    }
    
    /* Floating Home Button */
    .floating-home {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: #1a1a1a;
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .floating-home:hover {
      background: #4a4a4a;
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    /* Page Break */
    .page-break {
      page-break-before: always;
      margin: 60px 0;
    }
    
    /* Print Styles */
    @media print {
      .floating-home {
        display: none;
      }
      .page-break {
        page-break-before: always;
      }
      body {
        background: white;
      }
      .cover-page {
        min-height: auto;
        page-break-after: always;
      }
    }
  </style>
  <meta name="description" content="Work Chart Analysis - Current vs Future Process Comparison" />
  <meta name="robots" content="noindex" />
</head>
<body>
  <div class="document-container">
    ${buildCoverPage()}
    ${buildTableOfContents()}
    ${buildSummarySection()}
    ${buildCurrentProcessSection()}
    ${buildFutureProcessSection()}
    ${buildAIToolsSection()}
  </div>
  
  <a href="#toc" class="floating-home" title="Back to Table of Contents">‚åÇ</a>
</body>
</html>`;
        }

        function renderQuestions(questions) {
            questionsContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <label for="question-${index}" class="block text-lg font-semibold text-secondary-800 mb-3">${q}</label>
                    <input type="text" id="question-${index}" class="w-full p-4 border-2 border-secondary-200 rounded-xl focus:ring-4 focus:ring-primary-200 focus:border-primary-500 transition-all duration-300 text-lg">
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }
        
        function renderAITools(futureProcess) {
            if (!futureProcess || !futureProcess.steps) return;
            
            const toolsMap = new Map();
            const agentSteps = [];
            
            futureProcess.steps.forEach(step => {
                if ((step.owner === 'Agent' || step.owner === 'Hybrid') && step.compute) {
                    agentSteps.push({
                        step: step.step,
                        owner: step.owner,
                        modelId: step.compute.modelId,
                        notes: step.compute.notes,
                        tools: step.compute.tools || []
                    });
                    
                    // Collect unique tools
                    if (step.compute.tools && Array.isArray(step.compute.tools)) {
                        step.compute.tools.forEach(tool => {
                            if (!toolsMap.has(tool)) {
                                toolsMap.set(tool, []);
                            }
                            toolsMap.get(tool).push(step.step);
                        });
                    }
                }
            });
            
            if (agentSteps.length === 0) {
                aiToolsSection.classList.add('hidden');
                return;
            }
            
            aiToolsSection.classList.remove('hidden');
            aiToolsContainer.innerHTML = '';
            
            // Render by step
            agentSteps.forEach(item => {
                const ownerColor = item.owner === 'Agent' ? 'bg-purple-500' : 'bg-emerald-500';
                const card = document.createElement('div');
                card.className = 'bg-white border-2 border-secondary-200 rounded-2xl p-6 shadow-lg';
                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-12 h-12 ${ownerColor} rounded-xl flex items-center justify-center text-white font-bold text-xl">
                                ${item.owner === 'Agent' ? 'ü§ñ' : 'ü§ù'}
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-sm font-semibold px-3 py-1 rounded-full border ${ownerColor} text-white">${item.owner}</span>
                                <span class="font-bold text-lg text-secondary-900">${item.step}</span>
                            </div>
                            <div class="text-base text-secondary-700 mb-3">
                                <strong class="text-secondary-900">Model:</strong> ${item.modelId}
                            </div>
                            ${item.notes ? `<div class="text-base text-secondary-600 mb-3">${item.notes}</div>` : ''}
                            ${item.tools.length > 0 ? `
                                <div class="mt-3">
                                    <div class="text-sm font-semibold text-secondary-800 mb-2">Required Capabilities:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.tools.map(tool => `<span class="text-sm px-3 py-1.5 bg-primary-100 border border-primary-300 rounded-lg text-primary-900 font-medium">${tool}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                aiToolsContainer.appendChild(card);
            });
            
            // Render summary if multiple tools
            if (toolsMap.size > 0) {
                const summary = document.createElement('div');
                summary.className = 'bg-gradient-to-r from-primary-50 to-emerald-50 border-2 border-primary-200 rounded-2xl p-6 mt-4 shadow-lg';
                summary.innerHTML = `
                    <h4 class="font-bold text-xl text-secondary-900 mb-4">üìã Capability Summary</h4>
                    <div class="space-y-3 text-base">
                        ${Array.from(toolsMap.entries()).map(([tool, steps]) => `
                            <div class="flex items-start">
                                <span class="font-medium text-secondary-900 mr-2">‚Ä¢</span>
                                <div>
                                    <span class="font-semibold text-secondary-900">${tool}</span>
                                    <span class="text-secondary-600"> ‚Äî used in ${steps.length} step${steps.length > 1 ? 's' : ''}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                aiToolsContainer.appendChild(summary);
            }
        }
        
        function setLoadingState(button, loader, textElement, isLoading) {
            if (isLoading) {
                button.disabled = true;
                textElement.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                button.disabled = false;
                textElement.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            errorBox.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }

        function manageApiKey() {
            const currentKey = localStorage.getItem('venice_api_key') || '';
            const display = currentKey ? `${currentKey.substring(0, 8)}...${currentKey.substring(currentKey.length - 4)} (${currentKey.length} chars)` : 'Not set';

            const action = prompt(`Venice API Key Management\n\nCurrent key: ${display}\n\nOptions:\n- Enter new API key to update\n- Type "clear" to remove stored key\n- Leave blank to keep current:`);

            if (action !== null) {
                if (action.trim().toLowerCase() === 'clear') {
                    localStorage.removeItem('venice_api_key');
                    API_KEY = '';
                    alert('API key cleared. You will be prompted for a new key on next request.');
                } else if (action.trim()) {
                    API_KEY = action.trim();
                    localStorage.setItem('venice_api_key', API_KEY);
                    alert(`API key updated successfully! (${API_KEY.length} characters)`);
                } else if (action === '') {
                    if (currentKey) {
                        alert('API key unchanged.');
                    }
                }
            }
        }

    </script>
</body>
</html>