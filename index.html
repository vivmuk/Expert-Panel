<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expert Panel - Synthesis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* New Color Palette & Modern Look Variables */
            --primary-color: #205072; /* Dark Teal - Primary */
            --primary-darker: #103A52; /* Darker shade of primary */
            --secondary-color: #329D9C; /* Medium Teal - Secondary/Accent */
            --accent-orange: #F9A03F;   /* Accent Orange */
            --accent-coral: #ED553B;    /* Accent Coral/Red */
            --accent-yellow: #FFCB05;   /* Accent Yellow (from image) */
            --light-green-bg: #E0F2F1; /* Light Teal/Greenish - for subtle backgrounds */

            --text-color: #263238; /* Dark Slate Grey - for better contrast */
            --light-text-color: #546E7A; /* Lighter Slate Grey */
            --bg-color: #F8F9FA; /* Light Grey - General page background */
            --panel-bg: #FFFFFF;         /* White - For content panels */
            --border-color: #CFD8DC;     /* Lighter Grey Blue - for borders */
            
            --hover-bg-color: #B2DFDB; /* Light teal for general hovers */
            --active-nav-bg: var(--accent-coral);
            --active-nav-text: #FFFFFF;

            /* Left Panel Specifics for Pronounced Look */
            --left-panel-bg: #205072; /* Dark Teal background for left panel */
            --left-panel-text: #E0F2F1; /* Very light teal/white for text on dark panel */
            --left-panel-header-text: #C4E8C2; /* Light Green for "Navigation" header */
            --left-panel-nav-item-hover-bg: #329D9C; /* Medium Teal for nav item hover */
            --left-panel-nav-item-hover-text: #FFFFFF;
            --left-panel-nav-item-active-bg: var(--accent-orange); /* Orange for active nav items in left panel */
            --left-panel-nav-item-active-text: #000000; /* Black text on orange for contrast */
            --left-panel-border-color: #103A52; /* Darker border for left panel */

            --shadow-sm: 0 2px 5px rgba(0,0,0,0.07);
            --shadow-md: 0 5px 12px rgba(0,0,0,0.09);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
            --font-family: 'Roboto', sans-serif;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 15px;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background: var(--panel-bg);
            color: var(--primary-color);
            padding: 20px 40px; /* Increased padding */
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .header h1 {
            margin: 0;
            font-size: 2.4em; /* Slightly larger */
            font-weight: 500;
        }

        .main-content-wrapper {
            display: flex;
            flex-grow: 1;
            max-width: 1800px; /* Wider */
            width: 100%;
            margin: 30px auto; /* Increased margin */
            gap: 30px; /* Increased gap */
        }

        #left-panel-nav {
            width: 280px; /* Wider left panel */
            background-color: var(--left-panel-bg); /* Pronounced background */
            color: var(--left-panel-text); /* Text color for the panel */
            padding: 20px;
            border-right: 1px solid var(--left-panel-border-color);
            box-shadow: var(--shadow-lg); /* More pronounced shadow */
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius-md);
            transition: box-shadow 0.3s ease;
        }
        #left-panel-nav:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); /* Enhanced hover shadow */
        }

        #left-panel-nav h3 {
            color: var(--left-panel-header-text); /* Contrasting header text */
            border-bottom: 1px solid var(--secondary-color); /* Use secondary for border */
            padding-bottom: 15px;
            margin-top: 0; /* Adjusted margin */
            margin-bottom: 20px;
            font-size: 1.25em; /* Larger font */
            font-weight: 700; /* Bolder */
            padding-left: 5px;
        }
        #left-panel-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }
        #left-panel-nav li a {
            display: flex; 
            align-items: center; 
            padding: 12px 15px; /* Increased padding */
            text-decoration: none;
            color: var(--left-panel-text); /* Text color for nav items */
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px; /* Increased margin */
            transition: background-color 0.25s ease, color 0.25s ease, transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.95em; 
            font-weight: 500; /* Slightly bolder */
        }
        #left-panel-nav li a .nav-icon {
            margin-right: 12px; /* Increased margin */
            font-size: 1.2em; 
            width: 20px; 
            text-align: center;
            opacity: 0.8; /* Slightly more visible */
            transition: opacity 0.25s ease;
        }

        #left-panel-nav li a:hover {
            background-color: var(--left-panel-nav-item-hover-bg); /* Hover background */
            color: var(--left-panel-nav-item-hover-text); /* Hover text */
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        #left-panel-nav li a:hover .nav-icon {
            opacity: 1;
        }

        #left-panel-nav li a.active,
        #left-panel-nav li a.processing-nav-item {
            background-color: var(--left-panel-nav-item-active-bg); /* Active background */
            color: var(--left-panel-nav-item-active-text); /* Active text */
            font-weight: 700; /* Bolder for active */
            box-shadow: var(--shadow-md);
        }
        #left-panel-nav li a.active .nav-icon, 
        #left-panel-nav li a.processing-nav-item .nav-icon {
             opacity: 1;
             color: var(--left-panel-nav-item-active-text); /* Ensure icon color matches */
        }

        #left-panel-nav li a.processing-nav-item {
            animation: navPulse 1.3s infinite ease-in-out;
        }
        @keyframes navPulse { /* Pulse with panel's active colors */
            0% { background-color: var(--left-panel-nav-item-active-bg); opacity: 1; }
            50% { background-color: color-mix(in srgb, var(--left-panel-nav-item-active-bg) 80%, black); opacity: 0.85; }
            100% { background-color: var(--left-panel-nav-item-active-bg); opacity: 1; }
        }

        .container { 
            flex-grow: 1;
            padding: 0; 
            background: transparent; 
            overflow-y: auto;
        }

        .input-section {
            background-color: var(--panel-bg);
            padding: 25px 30px; /* Increased padding */
            border-radius: var(--border-radius-md); /* Rounded edges */
            margin-bottom: 30px; /* Increased margin */
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
         .input-section p {
            font-size: 1em; /* Slightly larger */
            color: var(--light-text-color);
            margin-bottom: 18px;
        }

        textarea {
            width: calc(100% - 24px); /* Adjusted for padding */
            min-height: 120px; /* Taller */
            padding: 12px;
            margin-bottom: 18px;
            border-radius: var(--border-radius-sm); /* Rounded edges */
            border: 1px solid var(--border-color);
            background-color: #fff;
            color: var(--text-color);
            font-size: 1em;
            font-family: var(--font-family);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        textarea:focus {
            border-color: var(--secondary-color); /* Use secondary for focus */
            outline: 0;
            box-shadow: 0 0 0 0.25rem color-mix(in srgb, var(--secondary-color) 25%, transparent); /* Modern focus ring */
        }

        button {
            display: inline-block;
            padding: 12px 25px; /* Larger buttons */
            background-color: var(--secondary-color); /* Use secondary for default buttons */
            color: white;
            border: none;
            border-radius: var(--border-radius-sm); /* Rounded edges */
            font-size: 1em; /* Larger font */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease;
            margin-right: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }
        button:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 85%, black); /* Darken secondary */
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        button:disabled {
            background-color: #B0BEC5; /* Muted color for disabled */
            color: #78909C;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }

        .progress-container {
            display: none;
            margin-top: auto; 
            padding: 18px 12px; /* Increased padding */
            background-color: var(--left-panel-bg); /* Match panel background */
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md); /* Rounded bottom corners */
            border-top: 1px solid var(--left-panel-border-color); /* Match panel border */
        }
        .progress-bar {
            width: 100%;
            background-color: color-mix(in srgb, var(--left-panel-text) 20%, transparent); /* Lighter bar background */
            border-radius: var(--border-radius-sm);
            padding: 3px; /* Increased padding */
        }
        .progress-bar-inner {
            display: block;
            height: 20px; /* Taller bar */
            width: 0%;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow)); /* Use accent gradient */
            border-radius: var(--border-radius-sm); /* Match outer radius */
            text-align: center;
            line-height: 20px;
            color: var(--text-color); /* Darker text for visibility on yellow/orange */
            font-weight: 600; /* Bolder */
            font-size: 0.85em;
            transition: width 0.4s ease-in-out;
        }
        #statusMessage {
            font-style: italic;
            color: var(--left-panel-text); /* Match panel text */
            margin-top: 12px;
            text-align: center;
            font-size: 0.9em;
        }

        #results-content .content-section {
            display: none;
            background-color: var(--panel-bg);
            padding: 30px 35px; /* Increased padding */
            border-radius: var(--border-radius-md); /* Rounded edges */
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(15px); /* Slightly more pronounced animation */
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        #results-content .content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0px);
        }

        #results-content h2, #results-content h3, #results-content h4 {
            color: var(--primary-color); /* Use primary for headers */
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 500;
        }
        #results-content h2 { font-size: 1.8em; } /* Larger */
        #results-content h3 { font-size: 1.5em; } /* Larger */
        #results-content h4 { font-size: 1.2em; margin-bottom: 15px; border-bottom: none; color: var(--text-color); } /* Larger */

        .error {
            color: #b71c1c; /* Darker red */
            font-weight: 500;
            padding: 18px; /* Increased padding */
            background-color: #FFEBEE; /* Lighter red background */
            border: 1px solid #FFCDD2; /* Lighter red border */
            border-left: 6px solid var(--accent-coral); /* Coral accent border */
            border-radius: var(--border-radius-sm);
            margin-bottom:25px;
        }
        .error strong { color: #c62828; } /* Slightly darker red for strong text */

        .icon-placeholder {
            font-size: 1.5em; /* Larger */
            float: right;
            color: var(--secondary-color); /* Use secondary for icons */
            margin-left: 15px;
            opacity: 0.9;
        }

        .persona-definition p, .search-persona-intro p {
            font-size: 0.95em;
            color: var(--light-text-color);
            margin-bottom: 10px;
        }
        .persona-definition hr, .search-persona-intro hr {
             border: 0;
             border-top: 1px solid color-mix(in srgb, var(--primary-color) 15%, transparent); /* Subtle hr */
             margin: 25px 0;
        }

        .insight-block, .key-finding-block {
            border-left: 5px solid; /* Thicker border */
            padding: 18px 20px; /* Increased padding */
            margin-bottom: 22px;
            background-color: #FDFEFE; /* Very light, almost white */
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
            box-shadow: var(--shadow-sm);
        }
        .insight-block { border-left-color: var(--accent-orange); } 
        .key-finding-block { border-left-color: var(--secondary-color); } /* Using secondary for this */

        .insight-block p, .key-finding-block p {
            margin: 8px 0;
            font-size: 0.95em;
            color: var(--light-text-color);
        }
        .insight-block p:first-of-type, .key-finding-block p:first-of-type {
            margin-top: 0;
        }
        .insight-block strong, .key-finding-block strong {
             color: var(--text-color);
             font-weight: 600; /* Bolder */
        }
         .insight-block p strong:first-child, .key-finding-block p strong:first-child {
            color: var(--primary-darker);
         }

        .action-step {
            background-color: var(--light-green-bg); /* Use light green from palette */
            padding: 15px 18px;
            margin-bottom: 15px;
            border-radius: var(--border-radius-sm);
            border: 1px solid color-mix(in srgb, var(--secondary-color) 50%, transparent); /* Border from secondary */
            box-shadow: var(--shadow-sm);
        }
        .action-step p { font-size: 0.95em; }

        .priority-High { color: var(--accent-coral); font-weight: 700; } /* Use coral */
        .priority-Medium { color: var(--accent-orange); font-weight: 700; } /* Use orange */
        .priority-Low { color: var(--secondary-color); font-weight: 700; } /* Use secondary/teal */

        ul { list-style-type: none; padding-left: 0; }
        #results-content ul li {
            background-color: var(--bg-color); /* Consistent with page bg */
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            font-size: 0.95em;
        }

        button#downloadPdfButton {
            background-color: var(--accent-orange); /* Use accent orange */
        }
        button#downloadPdfButton:hover {
            background-color: color-mix(in srgb, var(--accent-orange) 85%, black); /* Darken orange */
        }

        .original-problem-display {
            font-size: 1em;
            margin-bottom: 25px;
            padding: 15px 18px;
            background-color: var(--light-green-bg); /* Use light green */
            border-radius: var(--border-radius-sm);
            border-left: 5px solid var(--secondary-color); /* Use secondary */
            color: var(--text-color); /* Darker text for readability */
        }
        .original-problem-display strong { color: var(--primary-color); font-weight:600; }

        /* Styles for Processing Notification - Less Intrusive */
        #processing-overlay {
            position: fixed; 
            top: 20px;
            right: 20px;
            width: 350px;
            max-width: 90vw;
            background-color: var(--panel-bg);
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            padding: 20px;
            z-index: 10000; 
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        #processing-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        #processing-overlay h2 {
            color: var(--primary-darker);
            font-size: 1.2em;
            margin-bottom: 15px;
            margin-top: 0;
        }
        #processing-overlay p {
            margin: 10px 0 0 0;
            font-size: 0.9em;
            color: var(--light-text-color);
        }
        /* Simple Spinner - updated colors */
        .spinner {
            border: 4px solid var(--hover-bg-color);
            border-top: 4px solid var(--accent-orange);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Close button for processing notification */
        .processing-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--light-text-color);
            padding: 0;
            margin: 0;
            width: auto;
            height: auto;
            box-shadow: none;
        }
        .processing-close:hover {
            color: var(--accent-coral);
            transform: none;
            background: none;
            box-shadow: none;
        }

    </style>
</head>
<body>
    <header class="header">
        <h1>AI Expert Panel</h1>
    </header>

    <div class="main-content-wrapper">
        <nav id="left-panel-nav">
            <h3>Navigation</h3>
            <ul id="navigationList">
                <!-- Navigation items will be populated dynamically -->
            </ul>
             <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <span class="progress-bar-inner" id="progressBarInner">0%</span>
                </div>
                <div id="statusMessage">Initializing...</div>
            </div>
        </nav>

        <main class="container" id="right-panel-container">
            <div class="input-section">
                <p>Enter your business problem. The system will orchestrate AI experts for insights and an action plan.</p>
                <textarea id="businessProblem" placeholder="Describe your business problem here..."></textarea>
                <button id="submitButton" onclick="submitProblem()">Get Expert Insights</button>
                <button id="downloadPdfButton" onclick="downloadPDF()" style="display:none;">Download PDF</button>
            </div>
            
            <div id="results-content">
                <!-- Content sections will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <div id="processing-overlay">
        <button class="processing-close" onclick="hideProcessingNotification()" title="Close">&times;</button>
        <h2>Generating Report...</h2>
        <div class="spinner"></div>
        <p>AI experts are analyzing your problem.</p>
    </div>

    <script>
        // Configuration for backend URL
        const BACKEND_URL = window.location.hostname === 'localhost' ? 
            'http://127.0.0.1:5000' : 
            'https://expert-panel.onrender.com';

        const STAGE_IDLE = -1;
        const STAGE_INIT = 0;
        const STAGE_PERSONA_GENERATION_START = 1;
        const STAGE_PERSONA_GENERATION_COMPLETE = 2;
        const STAGE_BACKEND_PROCESSING_COMPLETE = 3;
        const STAGE_PERSONA_INSIGHT_COLLECTION_START = 4; 
        const MAX_EXPECTED_PERSONAS_FOR_PROGRESS = 10;
        const STAGE_SEARCH_ASSISTANT_START = STAGE_PERSONA_INSIGHT_COLLECTION_START + MAX_EXPECTED_PERSONAS_FOR_PROGRESS;
        const STAGE_SEARCH_ASSISTANT_COMPLETE = STAGE_SEARCH_ASSISTANT_START + 1;
        const STAGE_SYNTHESIS_START = STAGE_SEARCH_ASSISTANT_COMPLETE + 1;
        const STAGE_SYNTHESIS_COMPLETE = STAGE_SYNTHESIS_START + 1;
        const STAGE_DISPLAY_RESULTS = STAGE_SYNTHESIS_COMPLETE + 1;
        const STAGE_ALL_COMPLETE = STAGE_DISPLAY_RESULTS + 1;
        const TOTAL_PROGRESS_STAGES = STAGE_ALL_COMPLETE;

        let currentProgressNumericStage = STAGE_IDLE;
        let globalReportData = null;
        let activeContentId = null;
        let allProcessedItemNames = [];

        function hideProcessingNotification() {
            const processingOverlay = document.getElementById('processing-overlay');
            if (processingOverlay) {
                processingOverlay.classList.remove('visible');
            }
        }

        function getNavIcon(itemName) {
            itemName = itemName.toLowerCase();
            if (itemName.includes('report')) return '&#128221;'; // Document
            if (itemName.includes('search') || itemName.includes('research')) return '&#128269;'; // Magnifying glass
            if (itemName.includes('analyst')) return '&#128202;'; // Chart
            if (itemName.includes('strategist')) return '&#127919;'; // Target
            if (itemName.includes('technologist') || itemName.includes('tech')) return '&#128187;'; // Laptop
            if (itemName.includes('customer') || itemName.includes('user')) return '&#128101;'; // Group of users
            if (itemName.includes('risk')) return '&#9888;&#65039;'; // Warning
            if (itemName.includes('ethicist')) return '&#9878;&#65039;'; // Scales
            if (itemName.includes('futurist')) return '&#128302;'; // Crystal ball
            if (itemName.includes('financial') || itemName.includes('finance')) return '&#128176;'; // Money bag
            if (itemName.includes('legal')) return '&#128206;'; // Books/ledger
            if (itemName.includes('marketing')) return '&#128227;'; // Loudspeaker
            return '&#128100;'; // Default user icon
        }

        function updateProgress(message, numericStage) {
            currentProgressNumericStage = numericStage;
            const progressBarInner = document.getElementById('progressBarInner');
            const statusMessage = document.getElementById('statusMessage');
            const percentage = Math.min(100, Math.round((currentProgressNumericStage / TOTAL_PROGRESS_STAGES) * 100));
            
            if (progressBarInner) {
                 progressBarInner.style.width = percentage + '%';
                 progressBarInner.textContent = percentage + '%';
            }
            if (statusMessage) statusMessage.textContent = message;

            document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
            
            let currentProcessingItemName = null;
            if (numericStage >= STAGE_PERSONA_INSIGHT_COLLECTION_START && numericStage < STAGE_SEARCH_ASSISTANT_START) {
                const personaIndex = numericStage - STAGE_PERSONA_INSIGHT_COLLECTION_START;
                currentProcessingItemName = allProcessedItemNames.find(name => 
                    globalReportData && globalReportData.expert_insights && 
                    globalReportData.expert_insights[personaIndex] && 
                    name === globalReportData.expert_insights[personaIndex].persona_name
                );
            } else if (numericStage === STAGE_SEARCH_ASSISTANT_START && globalReportData && globalReportData.search_findings) {
                currentProcessingItemName = globalReportData.search_findings.persona_name;
            } else if (numericStage === STAGE_SYNTHESIS_START) {
                currentProcessingItemName = "Synthesis Report";
            }

            if (currentProcessingItemName) {
                const navItemId = `nav-${currentProcessingItemName.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                const activeNavItem = document.getElementById(navItemId);
                if (activeNavItem) {
                    activeNavItem.classList.add('processing-nav-item');
                    statusMessage.textContent = `Processing: ${currentProcessingItemName}...`;
                    activeNavItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        async function submitProblem() {
            const problemText = document.getElementById('businessProblem').value;
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            const progressContainer = document.getElementById('progressContainer');
            const submitButton = document.getElementById('submitButton');
            const downloadButton = document.getElementById('downloadPdfButton');
            const processingOverlay = document.getElementById('processing-overlay');

            globalReportData = null;
            allProcessedItemNames = []; 
            if (!problemText.trim()) {
                resultsContentDiv.innerHTML = '<div class="error content-section active">Please enter a business problem.</div>';
                return;
            }

            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 
            submitButton.disabled = true;
            downloadButton.style.display = 'none';
            if (processingOverlay) processingOverlay.classList.add('visible');
            progressContainer.style.display = 'block';
            updateProgress('Initializing...', STAGE_IDLE);

            try {
                // First test backend connectivity
                console.log('Testing backend connectivity...');
                const healthResponse = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!healthResponse.ok) {
                    throw new Error(`Backend health check failed: ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                console.log('Backend health check passed:', healthData);

                await new Promise(resolve => setTimeout(resolve, 300));
                updateProgress('Generating Expert Personas...', STAGE_PERSONA_GENERATION_START);
                
                const response = await fetch(`${BACKEND_URL}/process_problem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ business_problem: problemText }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "Failed to parse error from server." }));
                    throw new Error(`HTTP error! Status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                
                const data = await response.json();
                globalReportData = data;

                updateProgress('Main processing complete. Visualizing insights...', STAGE_BACKEND_PROCESSING_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                // Prepare names for navigation highlighting
                if (data.expert_insights) {
                    allProcessedItemNames = [...allProcessedItemNames, ...data.expert_insights.map(p => p.persona_name)];
                }
                if (data.search_findings && data.search_findings.persona_name) {
                    allProcessedItemNames.push(data.search_findings.persona_name);
                }
                if (data.synthesis_report) {
                    allProcessedItemNames.push("Synthesis Report");
                }
                
                updateProgress(`Personas generated. Collecting insights...`, STAGE_PERSONA_GENERATION_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                if (data.expert_insights) {
                    for (let i = 0; i < data.expert_insights.length; i++) {
                        updateProgress(`Insights: ${data.expert_insights[i].persona_name}...`, STAGE_PERSONA_INSIGHT_COLLECTION_START + i);
                        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));
                    }
                }
                
                if (data.search_findings) {
                    updateProgress(`Processing: ${data.search_findings.persona_name}...`, STAGE_SEARCH_ASSISTANT_START);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                updateProgress('Synthesizing report...', STAGE_SYNTHESIS_START);
                await new Promise(resolve => setTimeout(resolve, 1200)); 

                updateProgress('Finalizing results...', STAGE_DISPLAY_RESULTS);
                displayResults(data);

                if (data.synthesis_report || data.expert_insights || data.search_findings) {
                    downloadButton.style.display = 'inline-block';
                }

                updateProgress("Processing complete!", STAGE_ALL_COMPLETE);

            } catch (error) {
                console.error('Error submitting problem:', error);
                resultsContentDiv.innerHTML = `<div class="error content-section active" id="global-error-content"><strong>Error:</strong> ${error.message}<br>Please ensure the backend server is running and responding correctly.</div>`;
                switchContent('global-error-content');
                updateProgress('Error occurred.', STAGE_ALL_COMPLETE);
            } finally {
                submitButton.disabled = false;
                if (processingOverlay) processingOverlay.classList.remove('visible');
                
                setTimeout(() => {
                    document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
                    setTimeout(() => {
                        if(progressContainer.style.display === 'block' && !submitButton.disabled) { 
                           // progressContainer.style.display = 'none';
                        }
                    }, 5000);
                }, 300);
            }
        }

        function switchContent(targetId) {
            document.querySelectorAll('#results-content .content-section.active').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                setTimeout(() => { 
                    targetElement.classList.add('active'); 
                }, 10); 
            } else {
                const firstSection = document.querySelector('#results-content .content-section');
                if (firstSection) {
                    setTimeout(() => { firstSection.classList.add('active'); }, 10);
                    activeContentId = firstSection.id;
                } else {
                    document.getElementById('results-content').innerHTML = '<div class="content-section active"><p>Content not found.</p></div>';
                }
            }

            document.querySelectorAll('#navigationList li a').forEach(navLink => {
                navLink.classList.remove('active');
                if(navLink.id === `nav-${targetId.replace('-content','').replace(/[^a-zA-Z0-9_]/g, '-')}` ){
                    navLink.classList.add('active');
                }
            });
            activeContentId = targetId;
        }

        function displayResults(data) {
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 

            let firstItemIdToDisplay = null;
            const navOrder = [];

            // 1. Synthesis Report
            if (data.synthesis_report) {
                const itemName = "Synthesis Report";
                const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                const contentId = `${safeName}-content`;
                navOrder.push({name: itemName, id: contentId, type: 'report'});

                if (data.synthesis_report.error) {
                     resultsContentDiv.innerHTML += `<div class="content-section error" id="${contentId}"><h3>Synthesis Report Error</h3><p>${data.synthesis_report.error}</p></div>`;
                } else {
                    const synthesis = data.synthesis_report;
                    let actionsHTML = '';
                    if (synthesis.actionable_next_steps && synthesis.actionable_next_steps.length > 0) {
                        synthesis.actionable_next_steps.forEach(action => {
                            actionsHTML += `
                                <div class="action-step">
                                    <p><strong>Step:</strong> ${action.step_description}</p>
                                    <p><strong>Priority:</strong> <span class="priority-${action.priority || 'Medium'}">${action.priority || 'Medium'}</span></p>
                                    ${action.suggested_rationale ? `<p><strong>Rationale:</strong> ${action.suggested_rationale}</p>` : ''}
                                </div>`;
                        });
                    } else { actionsHTML = '<p>No specific actionable steps provided.</p>'; }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <h2><span class="icon-placeholder">${getNavIcon(itemName)}</span> ${itemName}</h2>
                            <div class="original-problem-display">
                                <p><strong>Original Problem:</strong> ${data.original_problem || 'N/A'}</p>
                            </div>
                            <h3>Cohesive Summary:</h3>
                            <p>${synthesis.cohesive_summary || 'Not available.'}</p>
                            <h3>Key Themes:</h3>
                            <ul>${(synthesis.key_themes || []).map(theme => `<li>${theme}</li>`).join('') || '<li>Not available.</li>'}</ul>
                            <h3>Potential Blind Spots:</h3>
                            <ul>${(synthesis.potential_blind_spots || []).map(spot => `<li>${spot}</li>`).join('') || '<li>Not available.</li>'}</ul>
                            <h3>Actionable Next Steps:</h3>
                            ${actionsHTML}
                        </div>`;
                }
            }
            
            // 2. Search Findings Panel
            if (data.search_findings) {
                const searchData = data.search_findings;
                const itemName = searchData.persona_name || "Research Assistant";
                const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                const contentId = `search-${safeName}-content`;
                navOrder.push({name: itemName, id: contentId, type: 'search'});

                let findingsHTML = '';
                if (searchData.error) {
                    findingsHTML = `<div class="error"><p><strong>Error during search:</strong> ${searchData.error}</p></div>`;
                } else if (searchData.findings && searchData.findings.length > 0) {
                    searchData.findings.forEach(item => {
                        findingsHTML += `
                            <div class="search-result-item">
                                ${item.link ? `<h4><a href="${item.link}" target="_blank">${item.title || 'Untitled Finding'}</a></h4>` : `<h4>${item.title || 'Untitled Finding'}</h4>`}
                                <p>${item.snippet || 'No snippet available.'}</p>
                            </div>`;
                    });
                } else {
                    findingsHTML = "<p>No key findings were returned from the search.</p>";
                }

                resultsContentDiv.innerHTML += `
                    <div class="content-section" id="${contentId}">
                        <h2><span class="icon-placeholder">${getNavIcon(itemName)}</span> ${itemName}</h2>
                        <div class="search-persona-intro">
                             <p>Automated research findings related to the business problem.</p>
                             <hr>
                        </div>
                        ${findingsHTML}
                    </div>`;
            }

            // 3. Expert Personas
            if (data.expert_insights && data.expert_insights.length > 0) {
                data.expert_insights.forEach(personaPackage => {
                    const itemName = personaPackage.persona_name || 'Unnamed Persona';
                    const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                    const contentId = `persona-${safeName}-content`;
                    navOrder.push({name: itemName, id: contentId, type: 'persona'});
                    
                    let personaDefinitionHTML = '';
                    if(data.persona_definitions) {
                        const definition = data.persona_definitions.find(p => p.name === itemName);
                        if(definition) {
                            personaDefinitionHTML = `
                                <div class="persona-definition">
                                    <p><strong>Role:</strong> ${definition.description || 'N/A'}</p>
                                    <p><strong>Focus:</strong> ${(definition.focus_areas || []).join(', ') || 'N/A'}</p>
                                    <hr>
                                </div>`;
                        }
                    }

                    let insightsContentHTML = '';
                    if (personaPackage.error) {
                         insightsContentHTML += `<div class="error"><p><strong>Error:</strong> ${personaPackage.error}</p></div>`;
                    } else {
                        if (personaPackage.insights_and_analysis && personaPackage.insights_and_analysis.length > 0) {
                            personaPackage.insights_and_analysis.forEach(item => {
                                insightsContentHTML += `
                                    <div class="insight-block">
                                        <p><strong>Insight:</strong> ${item.insight}</p>
                                        <p><strong>Reasoning:</strong> ${item.supporting_reasoning || 'N/A'}</p>
                                        <p><strong>Confidence:</strong> ${item.confidence_level || 'N/A'}</p>
                                        ${item.identified_risks && item.identified_risks.length > 0 ? `<p><strong>Risks:</strong> <span style="color: #D9534F;">${item.identified_risks.join(', ')}</span></p>` : ''}
                                        ${item.identified_opportunities && item.identified_opportunities.length > 0 ? `<p><strong>Opportunities:</strong> <span style="color: #5CB85C;">${item.identified_opportunities.join(', ')}</span></p>` : ''}
                                    </div>`;
                            });
                        } else {
                            insightsContentHTML += '<p>No specific insights provided by this persona.</p>';
                        }
                    }
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <h2><span class="icon-placeholder">${getNavIcon(itemName)}</span> ${itemName}</h2>
                            ${personaDefinitionHTML}
                            ${insightsContentHTML}
                        </div>`;
                });
            }
            
            // Populate Navigation List based on navOrder
            navOrder.forEach(item => {
                 const navItemId = `nav-${item.name.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                 navigationList.innerHTML += `<li><a href="#" id="${navItemId}" onclick="switchContent('${item.id}'); return false;"><span class="nav-icon">${getNavIcon(item.name)}</span> ${item.name}</a></li>`;
                 if (!firstItemIdToDisplay) firstItemIdToDisplay = item.id;
            });

            if (!firstItemIdToDisplay && data.error) { 
                 const errorContentId = 'global-error-content-final';
                 resultsContentDiv.innerHTML += `<div class="content-section error active" id="${errorContentId}"><strong>Backend Error:</strong> ${data.error} ${data.details ? '<br>Details: '+JSON.stringify(data.details) : ''}</div>`;
                 firstItemIdToDisplay = errorContentId;
            } else if (!firstItemIdToDisplay) {
                 const noResultsId = 'no-results-content-final';
                 resultsContentDiv.innerHTML += `<div class="content-section active" id="${noResultsId}"><p>No results to display. Please submit a problem.</p></div>`;
                 firstItemIdToDisplay = noResultsId;
            }

            if (firstItemIdToDisplay) {
                switchContent(firstItemIdToDisplay);
            }
        }

        function downloadPDF() {
            if (!globalReportData) {
                alert("No report data available to download.");
                return;
            }

            const data = globalReportData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

            let yPosition = 40;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            const usableWidth = pageWidth - (2 * margin);
            
            function addFormattedText(text, x, y, options = {}) {
                const { fontSize = 10, fontStyle = 'normal', color = '#333333', maxWidth = usableWidth, lineHeightFactor = 1.4, isTitle = false } = options;
                doc.setFontSize(fontSize);
                doc.setFont("helvetica", fontStyle);
                doc.setTextColor(color.startsWith('#') ? color.substring(1) : color);

                const lines = doc.splitTextToSize(text, maxWidth);
                let localY = y;
                lines.forEach((line, index) => {
                    if (index > 0) localY += fontSize * lineHeightFactor;
                    localY = checkAndAddPage(localY, fontSize * lineHeightFactor);
                    doc.text(line, x, localY);
                });
                return localY + ( (lines.length > 0 && !isTitle) ? (fontSize * lineHeightFactor * 0.5) : 0);
            }

            function checkAndAddPage(currentY, spaceNeeded = 20) {
                if (currentY + spaceNeeded > pageHeight - margin) {
                    doc.addPage();
                    return margin;
                }
                return currentY;
            }

            // Title Page
            yPosition = addFormattedText("AI Expert Panel Report", pageWidth / 2, yPosition, { fontSize: 20, fontStyle: 'bold', color: '#0056b3', align: 'center', isTitle: true });
            yPosition += 20;
            
            // Original Problem
            yPosition = checkAndAddPage(yPosition, 40);
            yPosition = addFormattedText("Original Business Problem:", margin, yPosition, { fontSize: 14, fontStyle: 'bold', color: '#007bff', isTitle: true });
            yPosition = addFormattedText(data.original_problem || 'N/A', margin, yPosition, { fontSize: 10, lineHeightFactor: 1.5 });
            yPosition += 15;

            // Synthesis Report
            if (data.synthesis_report && !data.synthesis_report.error) {
                const synthesis = data.synthesis_report;
                yPosition = checkAndAddPage(yPosition, 50);
                yPosition = addFormattedText("Synthesis Report & Action Plan", margin, yPosition, { fontSize: 16, fontStyle: 'bold', color: '#0056b3', isTitle: true });
                
                yPosition = addFormattedText("Cohesive Summary:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                yPosition = addFormattedText(synthesis.cohesive_summary || 'N/A', margin, yPosition, { fontSize: 10 });

                yPosition = addFormattedText("Key Themes:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                (synthesis.key_themes || []).forEach(theme => {
                    yPosition = addFormattedText("• " + theme, margin + 10, yPosition, { fontSize: 10 });
                });
                yPosition += 5;

                yPosition = addFormattedText("Potential Blind Spots:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                (synthesis.potential_blind_spots || []).forEach(spot => {
                    yPosition = addFormattedText("• " + spot, margin + 10, yPosition, { fontSize: 10 });
                });
                yPosition += 5;

                yPosition = addFormattedText("Actionable Next Steps:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                (synthesis.actionable_next_steps || []).forEach(action => {
                    yPosition = checkAndAddPage(yPosition, 40);
                    yPosition = addFormattedText(`Step: ${action.step_description}`, margin + 10, yPosition, { fontSize: 10, fontStyle: 'bold'});
                    yPosition = addFormattedText(`Priority: ${action.priority}`, margin + 20, yPosition, { fontSize: 10 });
                    if (action.suggested_rationale) {
                        yPosition = addFormattedText(`Rationale: ${action.suggested_rationale}`, margin + 20, yPosition, { fontSize: 10, maxWidth: usableWidth - 30 });
                    }
                    yPosition += 5;
                });
                 yPosition += 10;
            }
            
            // Search Findings
            if (data.search_findings && !data.search_findings.error && data.search_findings.findings && data.search_findings.findings.length > 0) {
                doc.addPage();
                yPosition = margin;
                const searchData = data.search_findings;
                yPosition = addFormattedText(`${searchData.persona_name || "Research Assistant"} - Key Findings`, margin, yPosition, { fontSize: 16, fontStyle: 'bold', color: '#0056b3', isTitle: true });

                (searchData.findings || []).forEach(item => {
                    yPosition = checkAndAddPage(yPosition, 40);
                    yPosition = addFormattedText(item.title || "Untitled Finding", margin, yPosition, { fontSize: 11, fontStyle: 'bold', color: '#007bff' });
                    if (item.link) {
                         yPosition = addFormattedText(`Source: ${item.link}`, margin, yPosition, { fontSize: 9, color: '#007bff' });
                    }
                    yPosition = addFormattedText(item.snippet || 'N/A', margin, yPosition, { fontSize: 10, maxWidth: usableWidth });
                    yPosition += 10;
                });
            }

            // Detailed Expert Insights
            if (data.expert_insights && data.expert_insights.length > 0) {
                data.expert_insights.forEach(personaPackage => {
                    doc.addPage();
                    yPosition = margin;
                    yPosition = addFormattedText(`Expert Persona: ${personaPackage.persona_name || 'Unknown Persona'}`, margin, yPosition, { fontSize: 16, fontStyle: 'bold', color: '#0056b3', isTitle: true });
                    
                    const definition = (data.persona_definitions || []).find(p => p.name === personaPackage.persona_name);
                    if (definition) {
                        yPosition = addFormattedText("Role & Focus:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                        yPosition = addFormattedText(`${definition.description || 'N/A'}. Focus areas: ${(definition.focus_areas || []).join(', ') || 'N/A'}`, margin, yPosition, { fontSize: 10 });
                        yPosition += 5;
                    }

                    if (personaPackage.error) {
                        yPosition = addFormattedText(`Error: ${personaPackage.error}`, margin, yPosition, { fontSize: 10, color: '#D9534F', fontStyle:'bold' });
                    } else {
                        yPosition = addFormattedText("Detailed Analysis & Insights:", margin, yPosition, { fontSize: 12, fontStyle: 'bold' });
                        (personaPackage.insights_and_analysis || []).forEach(item => {
                            yPosition = checkAndAddPage(yPosition, 50); 
                            yPosition = addFormattedText(`Insight: ${item.insight || 'N/A'}`, margin + 10, yPosition, { fontSize: 10, fontStyle:'bold' });
                            yPosition = addFormattedText(`Reasoning: ${item.supporting_reasoning || 'N/A'}`, margin + 10, yPosition, { fontSize: 10, maxWidth: usableWidth - 20 });
                            yPosition = addFormattedText(`Confidence: ${item.confidence_level || 'N/A'}`, margin + 10, yPosition, { fontSize: 10 });
                            if (item.identified_risks && item.identified_risks.length > 0) {
                                yPosition = addFormattedText(`Risks: ${item.identified_risks.join(', ')}`, margin + 10, yPosition, { fontSize: 10, color: '#D9534F' });
                            }
                            if (item.identified_opportunities && item.identified_opportunities.length > 0) {
                                yPosition = addFormattedText(`Opportunities: ${item.identified_opportunities.join(', ')}`, margin + 10, yPosition, { fontSize: 10, color: '#5CB85C' });
                            }
                            yPosition += 10; 
                        });
                    }
                });
            }
            doc.save('AI_Expert_Panel_Report.pdf');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            const resultsContentDiv = document.getElementById('results-content');
            if (!resultsContentDiv.innerHTML.trim()) {
                 resultsContentDiv.innerHTML = `<div class="content-section active" id="initial-message"><p>Please enter your business problem and click "Get Expert Insights" to begin.</p></div>`;
            }
            
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) progressContainer.style.display = 'none';
        });

    </script>
</body>
</html>