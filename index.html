<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expert Panel - Synthesis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* New Color Palette & Modern Look Variables */
            --primary-color: #1e40af; /* Modern Blue */
            --primary-darker: #1e3a8a; 
            --secondary-color: #06b6d4; /* Cyan */
            --accent-orange: #f59e0b;   
            --accent-coral: #ef4444;    
            --accent-yellow: #eab308;   
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --light-green-bg: #f0fdf4;

            --text-color: #1f2937; 
            --light-text-color: #6b7280; 
            --bg-color: #f8fafc; 
            --panel-bg: #ffffff;         
            --border-color: #e5e7eb;     
            
            --hover-bg-color: #e0f2fe;
            --active-nav-bg: var(--accent-coral);
            --active-nav-text: #FFFFFF;

            /* Left Panel Specifics for Pronounced Look */
            --left-panel-bg: #205072; /* Dark Teal background for left panel */
            --left-panel-text: #E0F2F1; /* Very light teal/white for text on dark panel */
            --left-panel-header-text: #C4E8C2; /* Light Green for "Navigation" header */
            --left-panel-nav-item-hover-bg: #329D9C; /* Medium Teal for nav item hover */
            --left-panel-nav-item-hover-text: #FFFFFF;
            --left-panel-nav-item-active-bg: var(--accent-orange); /* Orange for active nav items in left panel */
            --left-panel-nav-item-active-text: #000000; /* Black text on orange for contrast */
            --left-panel-border-color: #103A52; /* Darker border for left panel */

            --shadow-sm: 0 2px 5px rgba(0,0,0,0.07);
            --shadow-md: 0 5px 12px rgba(0,0,0,0.09);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
            --font-family: 'Inter', sans-serif;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 15px;
            --border-radius-xl: 20px;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background: var(--panel-bg);
            color: var(--primary-color);
            padding: 20px 40px; /* Increased padding */
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .header h1 {
            margin: 0;
            font-size: 2.4em; /* Slightly larger */
            font-weight: 500;
        }

        .main-content-wrapper {
            display: flex;
            flex-grow: 1;
            max-width: 1400px; /* Reduced from 1800px to prevent overflow */
            width: 100%;
            margin: 30px auto;
            margin-left: 20px; /* Reduced from 40px */
            margin-right: 20px; /* Add right margin to balance */
            gap: 25px; /* Reduced gap */
            padding: 0 15px; /* Reduced padding */
        }

        #left-panel-nav {
            width: 280px; /* Reduced from 320px */
            background: linear-gradient(135deg, var(--left-panel-bg) 0%, var(--primary-darker) 100%);
            color: var(--left-panel-text);
            padding: 25px;
            border-right: 1px solid var(--left-panel-border-color);
            box-shadow: 0 8px 32px rgba(32, 80, 114, 0.3);
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius-lg);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        /* Add subtle pattern overlay */
        #left-panel-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        #left-panel-nav > * {
            position: relative;
            z-index: 1;
        }
        
        #left-panel-nav:hover {
            box-shadow: 0 12px 40px rgba(32, 80, 114, 0.4); /* Enhanced hover shadow */
            transform: translateY(-2px); /* Subtle lift effect */
        }

        #left-panel-nav h3 {
            color: var(--left-panel-header-text); /* Contrasting header text */
            border-bottom: 2px solid var(--secondary-color); /* Thicker border */
            padding-bottom: 18px; /* Increased padding */
            margin-top: 0; /* Adjusted margin */
            margin-bottom: 25px; /* Increased margin */
            font-size: 1.35em; /* Larger font */
            font-weight: 700; /* Bolder */
            padding-left: 5px;
            text-transform: uppercase; /* Modern uppercase styling */
            letter-spacing: 1px; /* Letter spacing for sophistication */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Subtle text shadow */
        }
        #left-panel-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) transparent;
        }
        
        #left-panel-nav ul::-webkit-scrollbar {
            width: 6px;
        }
        
        #left-panel-nav ul::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #left-panel-nav ul::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 3px;
        }
        
        #left-panel-nav li a {
            display: flex;
            align-items: center;
            padding: 15px 18px; /* Increased padding */
            text-decoration: none;
            color: var(--left-panel-text); /* Text color for nav items */
            border-radius: 12px; /* More rounded corners */
            margin: 6px 8px; /* Increased margin */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth easing */
            word-wrap: break-word;
            line-height: 1.4; /* Better line height */
            min-height: 50px; /* Increased min height */
            position: relative;
            backdrop-filter: blur(5px);
            border: 1px solid transparent; /* For smooth border transitions */
        }
        
        /* Add subtle glow effect */
        #left-panel-nav li a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        #left-panel-nav li a .nav-icon {
            margin-right: 15px; /* Increased margin */
            font-size: 1.3em; /* Larger icons */
            width: 24px; /* Increased width */
            text-align: center;
            opacity: 0.9; /* Slightly more visible */
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        #left-panel-nav li a:hover {
            background: linear-gradient(135deg, var(--left-panel-nav-item-hover-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-hover-bg) 85%, white) 100%); /* Gradient hover */
            color: var(--left-panel-nav-item-hover-text); /* Hover text */
            transform: translateX(6px) scale(1.02); /* Enhanced transform */
            box-shadow: 0 6px 20px rgba(50, 157, 156, 0.4); /* Color-coordinated shadow */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
        }
        
        #left-panel-nav li a:hover::before {
            opacity: 1;
        }
        
        #left-panel-nav li a:hover .nav-icon {
            opacity: 1;
            transform: scale(1.1); /* Icon scale effect */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        #left-panel-nav li a.active,
        #left-panel-nav li a.processing-nav-item {
            background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%); /* Gradient active */
            color: var(--left-panel-nav-item-active-text); /* Active text */
            font-weight: 700; /* Bolder for active */
            box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5); /* Orange shadow for active */
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateX(4px) scale(1.02);
        }
        
        #left-panel-nav li a.active::before,
        #left-panel-nav li a.processing-nav-item::before {
            opacity: 1;
        }
        
        #left-panel-nav li a.active .nav-icon, 
        #left-panel-nav li a.processing-nav-item .nav-icon {
             opacity: 1;
             color: var(--left-panel-nav-item-active-text); /* Ensure icon color matches */
             transform: scale(1.1);
             filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        #left-panel-nav li a.processing-nav-item {
            animation: navPulse 1.5s infinite ease-in-out; /* Slower, smoother animation */
        }
        @keyframes navPulse { /* Enhanced pulse animation */
            0% { 
                background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%);
                box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5);
                transform: translateX(4px) scale(1.02);
            }
            50% { 
                background: linear-gradient(135deg, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 80%, black) 0%, var(--left-panel-nav-item-active-bg) 100%);
                box-shadow: 0 12px 35px rgba(249, 160, 63, 0.7);
                transform: translateX(6px) scale(1.05);
            }
            100% { 
                background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%);
                box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5);
                transform: translateX(4px) scale(1.02);
            }
        }

        .container { 
            flex-grow: 1;
            flex-shrink: 1; /* Allow shrinking if needed */
            min-width: 0; /* Important for flex child to shrink */
            padding: 0; 
            background: transparent; 
            overflow-y: auto;
            max-width: calc(100vw - 350px); /* Ensure it doesn't exceed viewport */
        }

        .input-section {
            background: linear-gradient(135deg, var(--panel-bg) 0%, color-mix(in srgb, var(--panel-bg) 98%, var(--secondary-color)) 100%);
            padding: 30px 35px; /* Reduced padding */
            border-radius: var(--border-radius-lg);
            margin-bottom: 35px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 1px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            max-width: 100%; /* Ensure it doesn't exceed container */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        /* Add subtle pattern to input section */
        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 80% 20%, rgba(50, 157, 156, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .input-section > * {
            position: relative;
            z-index: 1;
        }
        
         .input-section p {
            font-size: 1.1em; /* Larger font */
            color: var(--light-text-color);
            margin-bottom: 22px; /* Increased margin */
            font-weight: 400;
            line-height: 1.6;
        }

        textarea {
            width: 100%; /* Fixed width to stay within container */
            min-height: 140px; /* Taller */
            padding: 20px; /* Increased padding */
            margin-bottom: 25px; /* Increased margin */
            border-radius: var(--border-radius-md); /* Larger radius */
            border: 2px solid var(--border-color); /* Thicker border */
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 98%, var(--light-green-bg)) 100%);
            color: var(--text-color);
            font-size: 1.05em; /* Slightly larger */
            font-family: var(--font-family);
            transition: all 0.3s ease;
            resize: vertical; /* Allow vertical resize */
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.05); /* Enhanced shadows */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        textarea:focus {
            border-color: var(--secondary-color); /* Use secondary for focus */
            outline: 0;
            box-shadow: 0 0 0 0.3rem color-mix(in srgb, var(--secondary-color) 20%, transparent), inset 0 2px 8px rgba(0, 0, 0, 0.06), 0 4px 15px rgba(50, 157, 156, 0.15); /* Enhanced focus ring */
            transform: translateY(-2px); /* Subtle lift on focus */
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 95%, var(--secondary-color)) 100%);
        }

        button {
            display: inline-block;
            padding: 15px 30px; /* Larger buttons */
            background: linear-gradient(135deg, var(--secondary-color) 0%, color-mix(in srgb, var(--secondary-color) 85%, var(--primary-color)) 100%); /* Gradient background */
            color: white;
            border: none;
            border-radius: var(--border-radius-md); /* Larger radius */
            font-size: 1.05em; /* Larger font */
            font-weight: 600; /* Bolder */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth easing */
            margin-right: 15px; /* Increased margin */
            margin-bottom: 15px; /* Increased margin */
            box-shadow: 0 4px 15px rgba(50, 157, 156, 0.3); /* Color-coordinated shadow */
            position: relative;
            overflow: hidden;
        }
        
        /* Button shine effect */
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--secondary-color) 90%, black) 0%, var(--secondary-color) 100%); /* Enhanced gradient */
            transform: translateY(-3px) scale(1.02); /* Enhanced transform */
            box-shadow: 0 8px 25px rgba(50, 157, 156, 0.4); /* Enhanced shadow */
        }
        button:disabled {
            background: linear-gradient(135deg, #B0BEC5 0%, #90A4AE 100%); /* Gradient for disabled */
            color: #78909C;
            cursor: not-allowed;
            transform: translateY(0) scale(1);
            box-shadow: none;
        }
        button:disabled::before {
            display: none;
        }

        .progress-container {
            display: none;
            margin-top: auto; 
            padding: 18px 12px; /* Increased padding */
            background-color: var(--left-panel-bg); /* Match panel background */
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md); /* Rounded bottom corners */
            border-top: 1px solid var(--left-panel-border-color); /* Match panel border */
        }
        .progress-bar {
            width: 100%;
            background-color: color-mix(in srgb, var(--left-panel-text) 20%, transparent); /* Lighter bar background */
            border-radius: var(--border-radius-sm);
            padding: 3px; /* Increased padding */
        }
        .progress-bar-inner {
            display: block;
            height: 20px; /* Taller bar */
            width: 0%;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow)); /* Use accent gradient */
            border-radius: var(--border-radius-sm); /* Match outer radius */
            text-align: center;
            line-height: 20px;
            color: var(--text-color); /* Darker text for visibility on yellow/orange */
            font-weight: 600; /* Bolder */
            font-size: 0.85em;
            transition: width 0.4s ease-in-out;
        }
        #statusMessage {
            font-style: italic;
            color: var(--left-panel-text); /* Match panel text */
            margin-top: 12px;
            text-align: center;
            font-size: 0.9em;
        }

        #results-content .content-section {
            display: none;
            background: linear-gradient(135deg, var(--panel-bg) 0%, color-mix(in srgb, var(--panel-bg) 99%, var(--light-green-bg)) 100%);
            padding: 0;
            border-radius: var(--border-radius-lg);
            margin-bottom: 35px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08), 0 2px 10px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            max-width: 100%; /* Ensure content doesn't exceed container */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        /* Modern Card Header */
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-darker) 100%);
            color: white;
            padding: 25px 30px;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }
        
        .card-header .header-icon {
            font-size: 2em;
            opacity: 0.9;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .card-header .expert-badge {
            background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-coral) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-left: auto;
        }
        
        /* Card Content */
        .card-content {
            padding: 25px 30px; /* Reduced padding */
            position: relative;
            z-index: 1;
            word-wrap: break-word; /* Ensure long text wraps */
            overflow-wrap: break-word; /* Modern alternative */
        }
        
        /* Enhanced Insight Blocks */
        .insight-block, .key-finding-block {
            border: none;
            padding: 25px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 97%, var(--light-green-bg)) 100%);
            border-radius: var(--border-radius-md);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08), 0 1px 6px rgba(0, 0, 0, 0.04);
            position: relative;
            transition: all 0.3s ease;
            border-left: 5px solid;
        }
        
        .insight-block {
            border-left-color: var(--accent-orange);
        }
        
        .key-finding-block {
            border-left-color: var(--secondary-color);
        }
        
        .insight-block::before,
        .key-finding-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-orange), var(--accent-coral));
            border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
        }
        
        .key-finding-block::before {
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-yellow));
        }
        
        .insight-block:hover, .key-finding-block:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12), 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* Modern Action Steps */
        .action-step {
            background: linear-gradient(135deg, var(--light-green-bg) 0%, color-mix(in srgb, var(--light-green-bg) 90%, white) 100%);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-md);
            border: 2px solid color-mix(in srgb, var(--secondary-color) 30%, transparent);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .action-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-orange));
        }
        
        .action-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        
        .action-step .step-number {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-orange) 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Priority Badges */
        .priority-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            margin-left: 10px;
        }
        
        .priority-High {
            background: linear-gradient(135deg, var(--accent-coral) 0%, #e53e3e 100%);
            color: white;
        }
        
        .priority-Medium {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #f6ad55 100%);
            color: white;
        }
        
        .priority-Low {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #68d391 100%);
            color: white;
        }
        
        /* Modern Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid color-mix(in srgb, var(--primary-color) 20%, transparent);
            position: relative;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-orange));
            border-radius: 2px;
        }
        
        .section-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .section-header .section-icon {
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        
        /* Expert Info Card */
        .expert-info {
            background: linear-gradient(135deg, color-mix(in srgb, var(--secondary-color) 10%, transparent) 0%, transparent 100%);
            border: 1px solid color-mix(in srgb, var(--secondary-color) 30%, transparent);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .expert-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-orange));
            border-radius: 2px 0 0 2px;
        }
        
        .expert-role {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .expert-focus {
            font-size: 0.9em;
            color: var(--light-text-color);
            font-style: italic;
        }

        /* Responsive Design Improvements */
        @media (max-width: 1400px) {
            .main-content-wrapper {
                margin-left: 15px;
                margin-right: 15px;
                max-width: 100%;
                gap: 20px;
                padding: 0 10px;
            }
            
            #left-panel-nav {
                width: 260px;
            }
            
            .container {
                max-width: calc(100vw - 320px);
            }
        }
        
        @media (max-width: 1200px) {
            .main-content-wrapper {
                margin-left: 10px;
                margin-right: 10px;
                max-width: 95%;
                gap: 15px;
                padding: 0 5px;
            }
            
            #left-panel-nav {
                width: 240px;
            }
            
            .container {
                max-width: calc(100vw - 280px);
            }
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                flex-direction: column;
                margin-left: 10px;
                margin-right: 10px;
                padding: 0 5px;
                gap: 20px;
            }
            
            #left-panel-nav {
                width: 100%;
                order: 2; /* Move navigation below content on mobile */
            }
            
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .input-section {
                padding: 20px 25px;
            }
            
            #results-content .content-section {
                padding: 0;
            }
            
            .card-content {
                padding: 20px 25px;
            }
            
            textarea {
                min-height: 100px;
            }
            
            button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            button#downloadPdfButton {
                width: auto;
                display: inline-block;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content-wrapper {
                margin: 15px 5px;
                padding: 0;
            }
            
            .input-section, .card-content {
                padding: 15px 20px;
            }
            
            #results-content h2 {
                font-size: 1.6em;
            }
            
            #results-content h3 {
                font-size: 1.4em;
            }
        }

        /* Enhanced Focus States for Accessibility */
        button:focus-visible, 
        textarea:focus-visible,
        #left-panel-nav li a:focus-visible {
            outline: 3px solid var(--accent-orange);
            outline-offset: 2px;
        }
        
        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection styling */
        ::selection {
            background-color: color-mix(in srgb, var(--secondary-color) 30%, transparent);
            color: var(--primary-darker);
        }

        #results-content .content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0px);
        }

        /* Additional missing styles */
        button#downloadPdfButton {
            background: linear-gradient(135deg, var(--accent-orange) 0%, color-mix(in srgb, var(--accent-orange) 90%, var(--accent-coral)) 100%);
            font-size: 1.1em;
            padding: 18px 35px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(249, 160, 63, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button#downloadPdfButton:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--accent-orange) 90%, black) 0%, var(--accent-orange) 100%);
            box-shadow: 0 10px 35px rgba(249, 160, 63, 0.6);
            transform: translateY(-4px) scale(1.03);
        }

        .error {
            color: #b71c1c;
            font-weight: 500;
            padding: 0;
            background: none;
            border: none;
            margin-bottom: 25px;
        }

        /* Modern Loading States */
        .content-section.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .content-section.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Enhanced Modern Spinner */
        .modern-spinner {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            position: relative;
        }

        .modern-spinner::before,
        .modern-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            animation: modernSpin 2s linear infinite;
        }

        .modern-spinner::before {
            width: 60px;
            height: 60px;
            border: 4px solid transparent;
            border-top: 4px solid var(--secondary-color);
            border-right: 4px solid var(--accent-orange);
        }

        .modern-spinner::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border: 3px solid transparent;
            border-bottom: 3px solid var(--accent-purple);
            border-left: 3px solid var(--accent-green);
            animation: modernSpin 1.5s linear infinite reverse;
        }

        @keyframes modernSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Processing Notification */
        .processing-notification {
            display: none;
            background: linear-gradient(135deg, var(--panel-bg) 0%, #f0f9ff 100%);
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius-xl);
            padding: 30px;
            margin-top: 25px;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .processing-notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .processing-notification.visible {
            display: block;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .processing-notification h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .processing-notification h3 span {
            font-size: 1.5em;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .venice-footer {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-darker) 100%);
            color: #ffffff;
            padding: 20px 0;
            text-align: center;
            margin-top: auto;
            box-shadow: 0 -4px 20px rgba(30, 64, 175, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .venice-footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .venice-footer p {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .venice-link {
            color: #ffffff;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .venice-link:hover {
            color: var(--secondary-color);
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .venice-link:active {
            transform: translateY(0);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .venice-footer {
                padding: 15px 0;
            }
            
            .venice-footer p {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>AI Expert Panel</h1>
    </header>

    <div class="main-content-wrapper">
        <nav id="left-panel-nav">
            <h3>Navigation</h3>
            <ul id="navigationList">
                <!-- Navigation items will be populated dynamically -->
            </ul>
             <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <span class="progress-bar-inner" id="progressBarInner">0%</span>
                </div>
                <div id="statusMessage">Initializing...</div>
            </div>
        </nav>

        <main class="container" id="right-panel-container">
            <div class="input-section">
                <p>Enter your business problem. The system will orchestrate AI experts for insights and an action plan.</p>
                <textarea id="businessProblem" placeholder="Describe your business problem here..."></textarea>
                <button id="submitButton" onclick="submitProblem()">Get Expert Insights</button>
                <button id="downloadPdfButton" onclick="downloadPDF()" style="display:none;">Download PDF</button>
                
                <!-- Modern Processing Notification -->
                <div class="processing-notification" id="processingNotification">
                    <h3>
                        <span>ðŸ§ </span>
                        Generating Expert Analysis
                    </h3>
                    <div class="modern-spinner"></div>
                    <p id="processingStatus">AI experts are analyzing your problem...</p>
                    
                    <div class="progress-info">
                        <div class="progress-bar-modern">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0% Complete</div>
                    </div>
                </div>
            </div>
            
            <div id="results-content">
                <!-- Content sections will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <script>
        // Configuration for backend URL
        const BACKEND_URL = window.location.hostname === 'localhost' ? 
            'http://127.0.0.1:5000' : 
            'https://expert-panel.onrender.com';

        const STAGE_IDLE = -1;
        const STAGE_INIT = 0;
        const STAGE_PERSONA_GENERATION_START = 1;
        const STAGE_PERSONA_GENERATION_COMPLETE = 2;
        const STAGE_BACKEND_PROCESSING_COMPLETE = 3;
        const STAGE_PERSONA_INSIGHT_COLLECTION_START = 4; 
        const MAX_EXPECTED_PERSONAS_FOR_PROGRESS = 10;
        const STAGE_SEARCH_ASSISTANT_START = STAGE_PERSONA_INSIGHT_COLLECTION_START + MAX_EXPECTED_PERSONAS_FOR_PROGRESS;
        const STAGE_SEARCH_ASSISTANT_COMPLETE = STAGE_SEARCH_ASSISTANT_START + 1;
        const STAGE_SYNTHESIS_START = STAGE_SEARCH_ASSISTANT_COMPLETE + 1;
        const STAGE_SYNTHESIS_COMPLETE = STAGE_SYNTHESIS_START + 1;
        const STAGE_DISPLAY_RESULTS = STAGE_SYNTHESIS_COMPLETE + 1;
        const STAGE_ALL_COMPLETE = STAGE_DISPLAY_RESULTS + 1;
        const TOTAL_PROGRESS_STAGES = STAGE_ALL_COMPLETE;

        let currentProgressNumericStage = STAGE_IDLE;
        let globalReportData = null;
        let activeContentId = null;
        let allProcessedItemNames = [];

        function hideProcessingNotification() {
            const processingNotification = document.getElementById('processingNotification');
            if (processingNotification) {
                processingNotification.classList.remove('visible');
            }
        }

        function showProcessingNotification() {
            const processingNotification = document.getElementById('processingNotification');
            if (processingNotification) {
                processingNotification.classList.add('visible');
            }
        }

        function getNavIcon(itemName) {
            itemName = itemName.toLowerCase();
            if (itemName.includes('report')) return '&#128221;'; // Document
            if (itemName.includes('search') || itemName.includes('research')) return '&#128269;'; // Magnifying glass
            if (itemName.includes('analyst')) return '&#128202;'; // Chart
            if (itemName.includes('strategist')) return '&#127919;'; // Target
            if (itemName.includes('technologist') || itemName.includes('tech')) return '&#128187;'; // Laptop
            if (itemName.includes('customer') || itemName.includes('user')) return '&#128101;'; // Group of users
            if (itemName.includes('risk')) return '&#9888;&#65039;'; // Warning
            if (itemName.includes('ethicist')) return '&#9878;&#65039;'; // Scales
            if (itemName.includes('futurist')) return '&#128302;'; // Crystal ball
            if (itemName.includes('financial') || itemName.includes('finance')) return '&#128176;'; // Money bag
            if (itemName.includes('legal')) return '&#128206;'; // Books/ledger
            if (itemName.includes('marketing')) return '&#128227;'; // Loudspeaker
            return '&#128100;'; // Default user icon
        }

        function updateProgress(message, numericStage) {
            currentProgressNumericStage = numericStage;
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const processingStatus = document.getElementById('processingStatus');
            const progressContainer = document.getElementById('progressContainer');
            const progressBarInner = document.getElementById('progressBarInner');
            const statusMessage = document.getElementById('statusMessage');
            
            const percentage = Math.min(100, Math.round((currentProgressNumericStage / TOTAL_PROGRESS_STAGES) * 100));
            
            // Update main processing notification
            if (progressBarFill) {
                progressBarFill.style.width = percentage + '%';
            }
            if (progressText) {
                progressText.textContent = percentage + '% Complete';
            }
            if (processingStatus) {
                processingStatus.textContent = message;
            }

            // Update left panel progress
            if (progressBarInner) {
                progressBarInner.style.width = percentage + '%';
                progressBarInner.textContent = percentage + '%';
            }
            if (statusMessage) {
                statusMessage.textContent = message;
            }

            // Hide progress container when complete
            if (percentage >= 100 && progressContainer) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }

            // Update navigation processing states
            document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
            
            let currentProcessingItemName = null;
            if (numericStage >= STAGE_PERSONA_INSIGHT_COLLECTION_START && numericStage < STAGE_SEARCH_ASSISTANT_START) {
                const personaIndex = numericStage - STAGE_PERSONA_INSIGHT_COLLECTION_START;
                currentProcessingItemName = allProcessedItemNames.find(name => 
                    globalReportData && globalReportData.expert_insights && 
                    globalReportData.expert_insights[personaIndex] && 
                    name === globalReportData.expert_insights[personaIndex].persona_name
                );
            } else if (numericStage === STAGE_SEARCH_ASSISTANT_START && globalReportData && globalReportData.search_findings) {
                currentProcessingItemName = globalReportData.search_findings.persona_name;
            } else if (numericStage === STAGE_SYNTHESIS_START) {
                currentProcessingItemName = "Synthesis Report";
            }

            if (currentProcessingItemName) {
                const navItemId = `nav-${currentProcessingItemName.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                const activeNavItem = document.getElementById(navItemId);
                if (activeNavItem) {
                    activeNavItem.classList.add('processing-nav-item');
                    if (processingStatus) {
                        processingStatus.textContent = `Processing: ${currentProcessingItemName}...`;
                    }
                    if (statusMessage) {
                        statusMessage.textContent = `Processing: ${currentProcessingItemName}...`;
                    }
                    activeNavItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        async function submitProblem() {
            const problemText = document.getElementById('businessProblem').value;
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            const progressContainer = document.getElementById('progressContainer');
            const submitButton = document.getElementById('submitButton');
            const downloadButton = document.getElementById('downloadPdfButton');

            globalReportData = null;
            allProcessedItemNames = []; 
            if (!problemText.trim()) {
                resultsContentDiv.innerHTML = '<div class="error content-section active">Please enter a business problem.</div>';
                return;
            }

            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 
            submitButton.disabled = true;
            downloadButton.style.display = 'none';
            showProcessingNotification();
            if (progressContainer) progressContainer.style.display = 'block';
            updateProgress('Initializing...', STAGE_IDLE);

            try {
                // First test backend connectivity
                console.log('Testing backend connectivity...');
                const healthResponse = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!healthResponse.ok) {
                    throw new Error(`Backend health check failed: ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                console.log('Backend health check passed:', healthData);

                await new Promise(resolve => setTimeout(resolve, 300));
                updateProgress('Generating Expert Personas...', STAGE_PERSONA_GENERATION_START);
                
                const response = await fetch(`${BACKEND_URL}/process_problem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ business_problem: problemText }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "Failed to parse error from server." }));
                    throw new Error(`HTTP error! Status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                
                const data = await response.json();
                globalReportData = data;

                updateProgress('Main processing complete. Visualizing insights...', STAGE_BACKEND_PROCESSING_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                // Prepare names for navigation highlighting
                if (data.expert_insights) {
                    allProcessedItemNames = [...allProcessedItemNames, ...data.expert_insights.map(p => p.persona_name)];
                }
                if (data.search_findings && data.search_findings.persona_name) {
                    allProcessedItemNames.push(data.search_findings.persona_name);
                }
                if (data.synthesis_report) {
                    allProcessedItemNames.push("Synthesis Report");
                }
                
                updateProgress(`Personas generated. Collecting insights...`, STAGE_PERSONA_GENERATION_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                if (data.expert_insights) {
                    for (let i = 0; i < data.expert_insights.length; i++) {
                        updateProgress(`Insights: ${data.expert_insights[i].persona_name}...`, STAGE_PERSONA_INSIGHT_COLLECTION_START + i);
                        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 500));
                    }
                }
                
                if (data.search_findings) {
                    updateProgress(`Processing: ${data.search_findings.persona_name}...`, STAGE_SEARCH_ASSISTANT_START);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                updateProgress('Synthesizing report...', STAGE_SYNTHESIS_START);
                await new Promise(resolve => setTimeout(resolve, 1200)); 

                updateProgress('Finalizing results...', STAGE_DISPLAY_RESULTS);
                displayResults(data);

                if (data.synthesis_report || data.expert_insights || data.search_findings) {
                    downloadButton.style.display = 'inline-block';
                }

                updateProgress("Processing complete!", STAGE_ALL_COMPLETE);

            } catch (error) {
                console.error('Error submitting problem:', error);
                resultsContentDiv.innerHTML = `<div class="error content-section active" id="global-error-content"><strong>Error:</strong> ${error.message}<br>Please ensure the backend server is running and responding correctly.</div>`;
                switchContent('global-error-content');
                updateProgress('Error occurred.', STAGE_ALL_COMPLETE);
            } finally {
                submitButton.disabled = false;
                hideProcessingNotification();
                
                setTimeout(() => {
                    document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
                }, 300);
            }
        }

        function switchContent(targetId) {
            document.querySelectorAll('#results-content .content-section.active').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                setTimeout(() => { 
                    targetElement.classList.add('active'); 
                }, 10); 
            } else {
                const firstSection = document.querySelector('#results-content .content-section');
                if (firstSection) {
                    setTimeout(() => { firstSection.classList.add('active'); }, 10);
                    activeContentId = firstSection.id;
                } else {
                    document.getElementById('results-content').innerHTML = '<div class="content-section active"><p>Content not found.</p></div>';
                }
            }

            document.querySelectorAll('#navigationList li a').forEach(navLink => {
                navLink.classList.remove('active');
                if(navLink.id === `nav-${targetId.replace('-content','').replace(/[^a-zA-Z0-9_]/g, '-')}` ){
                    navLink.classList.add('active');
                }
            });
            activeContentId = targetId;
        }

        function displayResults(data) {
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 

            let firstItemIdToDisplay = null;
            const navOrder = [];

            // 1. Synthesis Report with modern card design
            if (data.synthesis_report) {
                const itemName = "Synthesis Report";
                const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                const contentId = `${safeName}-content`;
                navOrder.push({name: itemName, id: contentId, type: 'report'});

                if (data.synthesis_report.error) {
                     resultsContentDiv.innerHTML += `
                        <div class="content-section error" id="${contentId}">
                            <div class="card-header">
                                <h2><span class="header-icon">âš ï¸</span> Synthesis Report Error</h2>
                            </div>
                            <div class="card-content">
                                <p>${data.synthesis_report.error}</p>
                            </div>
                        </div>`;
                } else {
                    const synthesis = data.synthesis_report;
                    
                    let actionsHTML = '';
                    if (synthesis.actionable_next_steps && synthesis.actionable_next_steps.length > 0) {
                        synthesis.actionable_next_steps.forEach((action, index) => {
                            actionsHTML += `
                                <div class="action-step">
                                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                                        <span class="step-number">${index + 1}</span>
                                        <div style="flex: 1;">
                                            <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 1.1em;">${action.step_description}</p>
                                            <p style="margin: 0 0 8px 0;">
                                                <strong>Priority:</strong> 
                                                <span class="priority-badge priority-${action.priority || 'Medium'}">${action.priority || 'Medium'}</span>
                                            </p>
                                            ${action.suggested_rationale ? `<p style="margin: 0; font-style: italic; color: var(--light-text-color);">${action.suggested_rationale}</p>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        });
                    } else { 
                        actionsHTML = '<p>No specific actionable steps provided.</p>'; 
                    }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <div class="card-header">
                                <h2>
                                    <span class="header-icon">ðŸ“Š</span> 
                                    ${itemName}
                                    <span class="expert-badge">Executive Summary</span>
                                </h2>
                            </div>
                            <div class="card-content">
                                <div class="expert-info" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent-orange) 10%, transparent) 0%, transparent 100%); border-color: var(--accent-orange);">
                                    <div class="expert-role">Original Problem</div>
                                    <div style="font-size: 1.05em; line-height: 1.6;">${data.original_problem || 'N/A'}</div>
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸ’¡</span>
                                    <h3>Executive Summary</h3>
                                </div>
                                <p style="font-size: 1.1em; line-height: 1.7; margin-bottom: 25px;">${synthesis.cohesive_summary || 'Not available.'}</p>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸŽ¯</span>
                                    <h3>Key Themes</h3>
                                </div>
                                <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                                    ${(synthesis.key_themes || []).map(theme => `
                                        <div style="background: linear-gradient(135deg, var(--light-green-bg) 0%, white 100%); 
                                                    padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--secondary-color);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <span style="font-weight: 500;">${theme}</span>
                                        </div>
                                    `).join('') || '<p>Not available.</p>'}
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸ‘ï¸</span>
                                    <h3>Potential Blind Spots</h3>
                                </div>
                                <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                                    ${(synthesis.potential_blind_spots || []).map(spot => `
                                        <div style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent-coral) 10%, transparent) 0%, white 100%); 
                                                    padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--accent-coral);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <span style="font-weight: 500;">${spot}</span>
                                        </div>
                                    `).join('') || '<p>Not available.</p>'}
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸš€</span>
                                    <h3>Actionable Next Steps</h3>
                                </div>
                                ${actionsHTML}
                            </div>
                        </div>`;
                }
            }
            
            // 2. Expert Personas with enhanced design
            if (data.expert_insights && data.expert_insights.length > 0) {
                data.expert_insights.forEach(personaPackage => {
                    const itemName = personaPackage.persona_name || 'Unnamed Persona';
                    const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                    const contentId = `persona-${safeName}-content`;
                    navOrder.push({name: itemName, id: contentId, type: 'persona'});
                    
                    let personaDefinitionHTML = '';
                    if(data.persona_definitions) {
                        const definition = data.persona_definitions.find(p => p.name === itemName);
                        if(definition) {
                            personaDefinitionHTML = `
                                <div class="expert-info">
                                    <div class="expert-role">${definition.description || 'N/A'}</div>
                                    <div class="expert-focus"><strong>Focus Areas:</strong> ${(definition.focus_areas || []).join(', ') || 'N/A'}</div>
                                </div>`;
                        }
                    }

                    let insightsContentHTML = '';
                    if (personaPackage.error) {
                         insightsContentHTML += `
                            <div style="background: linear-gradient(135deg, #ffebee 0%, white 100%); 
                                        padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-coral);
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <strong style="color: var(--accent-coral);">Error:</strong> ${personaPackage.error}
                            </div>`;
                    } else {
                        if (personaPackage.insights_and_analysis && personaPackage.insights_and_analysis.length > 0) {
                            personaPackage.insights_and_analysis.forEach((item, index) => {
                                insightsContentHTML += `
                                    <div class="insight-block">
                                        <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                                            <div style="background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-coral) 100%);
                                                        color: white; width: 32px; height: 32px; border-radius: 50%;
                                                        display: flex; align-items: center; justify-content: center;
                                                        font-weight: 700; font-size: 0.9em; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                                ${index + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <h4 style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 1.1em;">
                                                    ${item.insight}
                                                </h4>
                                                <p style="margin: 0 0 10px 0; line-height: 1.6;">
                                                    <strong style="color: var(--primary-darker);">Reasoning:</strong> 
                                                    ${item.supporting_reasoning || 'N/A'}
                                                </p>
                                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                                    <span style="background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-yellow) 100%);
                                                                 color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                                        Confidence: ${item.confidence_level || 'N/A'}
                                                    </span>
                                                </div>
                                                ${item.identified_risks && item.identified_risks.length > 0 ? `
                                                    <div style="margin: 10px 0;">
                                                        <strong style="color: var(--accent-coral);">âš ï¸ Risks:</strong> 
                                                        <span style="color: var(--accent-coral);">${item.identified_risks.join(', ')}</span>
                                                    </div>` : ''}
                                                ${item.identified_opportunities && item.identified_opportunities.length > 0 ? `
                                                    <div style="margin: 10px 0;">
                                                        <strong style="color: var(--secondary-color);">ðŸŒŸ Opportunities:</strong> 
                                                        <span style="color: var(--secondary-color);">${item.identified_opportunities.join(', ')}</span>
                                                    </div>` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            });
                        } else {
                            insightsContentHTML += '<p>No specific insights provided by this expert.</p>';
                        }
                    }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <div class="card-header">
                                <h2>
                                    <span class="header-icon">${getNavIcon(itemName)}</span> 
                                    ${itemName}
                                    <span class="expert-badge">Expert Analysis</span>
                                </h2>
                            </div>
                            <div class="card-content">
                                ${personaDefinitionHTML}
                                <div class="section-header">
                                    <span class="section-icon">ðŸ”</span>
                                    <h3>Analysis & Insights</h3>
                                </div>
                                ${insightsContentHTML}
                            </div>
                        </div>`;
                });
            }
            
            // Populate Navigation List with enhanced styling
            navOrder.forEach(item => {
                 const navItemId = `nav-${item.name.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                 navigationList.innerHTML += `
                    <li>
                        <a href="#" id="${navItemId}" onclick="switchContent('${item.id}'); return false;">
                            <span class="nav-icon">${getNavIcon(item.name)}</span> 
                            ${item.name}
                        </a>
                    </li>`;
                 if (!firstItemIdToDisplay) firstItemIdToDisplay = item.id;
            });

            if (!firstItemIdToDisplay && data.error) { 
                 const errorContentId = 'global-error-content-final';
                 resultsContentDiv.innerHTML += `
                    <div class="content-section error active" id="${errorContentId}">
                        <div class="card-header">
                            <h2><span class="header-icon">âš ï¸</span> System Error</h2>
                        </div>
                        <div class="card-content">
                            <strong>Backend Error:</strong> ${data.error} 
                            ${data.details ? '<br><strong>Details:</strong> '+JSON.stringify(data.details) : ''}
                        </div>
                    </div>`;
                 firstItemIdToDisplay = errorContentId;
            } else if (!firstItemIdToDisplay) {
                 const noResultsId = 'no-results-content-final';
                 resultsContentDiv.innerHTML += `
                    <div class="content-section active" id="${noResultsId}">
                        <div class="card-header">
                            <h2><span class="header-icon">ðŸ“</span> No Results</h2>
                        </div>
                        <div class="card-content">
                            <p>No results to display. Please submit a problem to begin analysis.</p>
                        </div>
                    </div>`;
                 firstItemIdToDisplay = noResultsId;
            }

            if (firstItemIdToDisplay) {
                switchContent(firstItemIdToDisplay);
            }
        }

        function downloadPDF() {
            if (!globalReportData) {
                alert("No report data available to download.");
                return;
            }

            const data = globalReportData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

            let yPosition = 50;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const leftMargin = 60;
            const rightMargin = 50;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            
            function addFormattedText(text, x, y, options = {}) {
                const { 
                    fontSize = 11, 
                    fontStyle = 'normal', 
                    color = '#333333', 
                    maxWidth = usableWidth, 
                    lineHeightFactor = 1.8, 
                    isTitle = false,
                    indent = 0,
                    align = 'left'
                } = options;
                
                doc.setFontSize(fontSize);
                doc.setFont("helvetica", fontStyle);
                doc.setTextColor(color.startsWith('#') ? color.substring(1) : color);

                const effectiveWidth = Math.min(maxWidth - indent, usableWidth - indent);
                const lines = doc.splitTextToSize(text, effectiveWidth);
                let localY = y;
                
                lines.forEach((line, index) => {
                    if (index > 0) {
                        localY += fontSize * lineHeightFactor;
                    }
                    localY = checkAndAddPage(localY, fontSize * lineHeightFactor + 15);
                    
                    let xPos = x + indent;
                    if (align === 'center') {
                        const lineWidth = doc.getTextWidth(line);
                        xPos = (pageWidth - lineWidth) / 2;
                    }
                    
                    doc.text(line, xPos, localY);
                });
                
                return localY + (fontSize * lineHeightFactor * 0.8);
            }

            function checkAndAddPage(currentY, spaceNeeded = 40) {
                if (currentY + spaceNeeded > pageHeight - 100) {
                    doc.addPage();
                    return 80;
                }
                return currentY;
            }

            function addSection(title, content, options = {}) {
                yPosition = checkAndAddPage(yPosition, 80);
                
                // Add section title with background
                const titleHeight = 40;
                doc.setFillColor('#f8fafc');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, titleHeight, 'F');
                doc.setDrawColor('#e5e7eb');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, titleHeight, 'S');
                
                yPosition = addFormattedText(title, leftMargin, yPosition + 20, { 
                    fontSize: 16, 
                    fontStyle: 'bold', 
                    color: '#1e40af', 
                    isTitle: true 
                });
                yPosition += 30;
                
                if (typeof content === 'string') {
                    yPosition = addFormattedText(content, leftMargin, yPosition, { 
                        fontSize: 12, 
                        lineHeightFactor: 1.8,
                        ...options 
                    });
                } else if (Array.isArray(content)) {
                    content.forEach((item, index) => {
                        yPosition = checkAndAddPage(yPosition, 35);
                        yPosition = addFormattedText(`${index + 1}. ${item}`, leftMargin, yPosition, { 
                            fontSize: 11, 
                            indent: 0,
                            lineHeightFactor: 1.8,
                            ...options 
                        });
                        yPosition += 15;
                    });
                }
                yPosition += 35;
                return yPosition;
            }

            // Enhanced Title Page
            doc.setFillColor('#1e40af');
            doc.rect(0, 0, pageWidth, 140, 'F');
            
            yPosition = addFormattedText("AI Expert Panel Report", 0, 80, { 
                fontSize: 32, 
                fontStyle: 'bold', 
                color: '#ffffff',
                align: 'center'
            });
            
            yPosition = addFormattedText("Comprehensive Business Analysis & Strategic Recommendations", 0, yPosition + 25, { 
                fontSize: 14, 
                color: '#e0f2fe',
                align: 'center'
            });
            
            yPosition = 200;
            
            // Date and metadata
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            doc.setFillColor('#f8fafc');
            doc.rect(leftMargin, yPosition, usableWidth, 80, 'F');
            doc.setDrawColor('#e5e7eb');
            doc.rect(leftMargin, yPosition, usableWidth, 80, 'S');
            
            yPosition = addFormattedText(`Report Generated: ${currentDate}`, leftMargin + 20, yPosition + 30, { 
                fontSize: 12, 
                fontStyle: 'bold',
                color: '#374151'
            });
            
            yPosition = addFormattedText(`Analysis Type: Multi-Expert AI Consultation`, leftMargin + 20, yPosition + 10, { 
                fontSize: 11, 
                color: '#6b7280'
            });
            
            yPosition += 80;
            
            // Original Problem with enhanced formatting
            yPosition = checkAndAddPage(yPosition, 120);
            
            const problemText = data.original_problem || 'N/A';
            const problemLines = doc.splitTextToSize(problemText, usableWidth - 40);
            const problemHeight = Math.max(80, problemLines.length * 16 + 60);
            
            doc.setFillColor('#fef3c7');
            doc.rect(leftMargin, yPosition, usableWidth, problemHeight, 'F');
            doc.setDrawColor('#f59e0b');
            doc.setLineWidth(3);
            doc.rect(leftMargin, yPosition, usableWidth, problemHeight, 'S');
            
            yPosition = addFormattedText("BUSINESS PROBLEM STATEMENT", leftMargin + 20, yPosition + 30, { 
                fontSize: 14, 
                fontStyle: 'bold', 
                color: '#92400e'
            });
            
            yPosition = addFormattedText(problemText, leftMargin + 20, yPosition + 15, { 
                fontSize: 12, 
                lineHeightFactor: 1.8, 
                maxWidth: usableWidth - 40,
                color: '#451a03'
            });
            
            yPosition += problemHeight - 30;

            // Synthesis Report with enhanced formatting
            if (data.synthesis_report && !data.synthesis_report.error) {
                const synthesis = data.synthesis_report;
                
                // Executive Summary
                yPosition = addSection("EXECUTIVE SUMMARY", synthesis.cohesive_summary || 'N/A', {
                    fontSize: 12,
                    color: '#374151'
                });
                
                // Key Themes
                yPosition = addSection("KEY STRATEGIC THEMES", synthesis.key_themes || [], {
                    fontSize: 11,
                    color: '#374151'
                });
                
                // Blind Spots
                yPosition = addSection("POTENTIAL BLIND SPOTS & RISKS", synthesis.potential_blind_spots || [], {
                    fontSize: 11,
                    color: '#dc2626'
                });
                
                // Action Steps with enhanced formatting
                yPosition = checkAndAddPage(yPosition, 100);
                
                doc.setFillColor('#f0fdf4');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, 40, 'F');
                doc.setDrawColor('#10b981');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, 40, 'S');
                
                yPosition = addFormattedText("ACTIONABLE NEXT STEPS", leftMargin, yPosition + 20, { 
                    fontSize: 16, 
                    fontStyle: 'bold', 
                    color: '#166534'
                });
                yPosition += 40;
                
                (synthesis.actionable_next_steps || []).forEach((action, index) => {
                    yPosition = checkAndAddPage(yPosition, 120);
                    
                    // Step container
                    const stepHeight = 100;
                    doc.setFillColor('#f9fafb');
                    doc.rect(leftMargin, yPosition, usableWidth, stepHeight, 'F');
                    doc.setDrawColor('#d1d5db');
                    doc.rect(leftMargin, yPosition, usableWidth, stepHeight, 'S');
                    
                    // Step number circle
                    doc.setFillColor('#1e40af');
                    doc.circle(leftMargin + 25, yPosition + 30, 15, 'F');
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor('#ffffff');
                    doc.text(`${index + 1}`, leftMargin + 20, yPosition + 36);
                    
                    // Step content
                    yPosition = addFormattedText(`${action.step_description}`, leftMargin + 55, yPosition + 25, { 
                        fontSize: 12, 
                        fontStyle: 'bold',
                        maxWidth: usableWidth - 70,
                        color: '#1f2937',
                        lineHeightFactor: 1.6
                    });
                    
                    // Priority badge
                    const priorityColor = action.priority === 'High' ? '#dc2626' : 
                                        action.priority === 'Medium' ? '#ea580c' : '#059669';
                    yPosition = addFormattedText(`Priority: ${action.priority}`, leftMargin + 55, yPosition + 10, { 
                        fontSize: 10,
                        fontStyle: 'bold',
                        color: priorityColor
                    });
                    
                    // Rationale
                    if (action.suggested_rationale) {
                        yPosition = addFormattedText(`${action.suggested_rationale}`, leftMargin + 55, yPosition + 10, { 
                            fontSize: 10, 
                            maxWidth: usableWidth - 70,
                            lineHeightFactor: 1.6,
                            color: '#6b7280'
                        });
                    }
                    
                    yPosition += stepHeight - 50;
                });
            }

            // Expert Analysis Details
            if (data.expert_insights && data.expert_insights.length > 0) {
                doc.addPage();
                yPosition = 80;
                
                // Section header
                doc.setFillColor('#1e40af');
                doc.rect(0, yPosition - 20, pageWidth, 60, 'F');
                
                yPosition = addFormattedText("DETAILED EXPERT ANALYSIS", 0, yPosition + 20, { 
                    fontSize: 20, 
                    fontStyle: 'bold', 
                    color: '#ffffff',
                    align: 'center'
                });
                
                yPosition += 60;
                
                data.expert_insights.forEach((personaPackage, personaIndex) => {
                    if (personaIndex > 0) {
                        doc.addPage();
                        yPosition = 80;
                    }
                    
                    const expertName = personaPackage.persona_name || 'Unknown Expert';
                    
                    // Expert header with enhanced design
                    doc.setFillColor('#e0f2fe');
                    doc.rect(leftMargin, yPosition, usableWidth, 60, 'F');
                    doc.setDrawColor('#0891b2');
                    doc.setLineWidth(2);
                    doc.rect(leftMargin, yPosition, usableWidth, 60, 'S');
                    
                    yPosition = addFormattedText(`EXPERT: ${expertName.toUpperCase()}`, leftMargin + 20, yPosition + 35, { 
                        fontSize: 16, 
                        fontStyle: 'bold', 
                        color: '#0c4a6e'
                    });
                    
                    yPosition += 45;
                    
                    // Expert description
                    const definition = (data.persona_definitions || []).find(p => p.name === expertName);
                    if (definition) {
                        yPosition = addFormattedText(`Expertise: ${definition.description || 'N/A'}`, leftMargin, yPosition + 15, { 
                            fontSize: 11,
                            maxWidth: usableWidth,
                            color: '#374151',
                            lineHeightFactor: 1.6
                        });
                        
                        if (definition.focus_areas && definition.focus_areas.length > 0) {
                            yPosition = addFormattedText(`Focus Areas: ${definition.focus_areas.join(', ')}`, leftMargin, yPosition + 10, { 
                                fontSize: 10,
                                color: '#6b7280',
                                maxWidth: usableWidth,
                                fontStyle: 'italic',
                                lineHeightFactor: 1.6
                            });
                        }
                        yPosition += 25;
                    }

                    // Insights with better formatting
                    if (personaPackage.error) {
                        doc.setFillColor('#fef2f2');
                        doc.rect(leftMargin, yPosition, usableWidth, 40, 'F');
                        yPosition = addFormattedText(`Error: ${personaPackage.error}`, leftMargin + 10, yPosition + 25, { 
                            fontSize: 11, 
                            color: '#dc2626', 
                            fontStyle: 'bold'
                        });
                        yPosition += 30;
                    } else if (personaPackage.insights_and_analysis && personaPackage.insights_and_analysis.length > 0) {
                        personaPackage.insights_and_analysis.forEach((item, index) => {
                            yPosition = checkAndAddPage(yPosition, 140);
                            
                            // Insight container
                            const insightHeight = 120;
                            doc.setFillColor('#f8fafc');
                            doc.rect(leftMargin + 10, yPosition, usableWidth - 20, insightHeight, 'F');
                            doc.setDrawColor('#cbd5e1');
                            doc.rect(leftMargin + 10, yPosition, usableWidth - 20, insightHeight, 'S');
                            
                            // Insight number
                            doc.setFillColor('#f59e0b');
                            doc.circle(leftMargin + 30, yPosition + 25, 12, 'F');
                            doc.setFontSize(12);
                            doc.setFont("helvetica", "bold");
                            doc.setTextColor('#ffffff');
                            doc.text(`${index + 1}`, leftMargin + 26, yPosition + 31);
                            
                            yPosition = addFormattedText(`${item.insight || 'N/A'}`, leftMargin + 55, yPosition + 20, { 
                                fontSize: 11, 
                                fontStyle: 'bold', 
                                maxWidth: usableWidth - 70,
                                color: '#1f2937',
                                lineHeightFactor: 1.6
                            });
                            
                            yPosition = addFormattedText(`Reasoning: ${item.supporting_reasoning || 'N/A'}`, leftMargin + 55, yPosition + 10, { 
                                fontSize: 10, 
                                maxWidth: usableWidth - 70,
                                lineHeightFactor: 1.6,
                                color: '#374151'
                            });
                            
                            yPosition = addFormattedText(`Confidence: ${item.confidence_level || 'N/A'}`, leftMargin + 55, yPosition + 10, { 
                                fontSize: 10,
                                color: '#059669',
                                fontStyle: 'bold'
                            });
                            
                            if (item.identified_risks && item.identified_risks.length > 0) {
                                yPosition = addFormattedText(`âš  Risks: ${item.identified_risks.join(', ')}`, leftMargin + 55, yPosition + 8, { 
                                    fontSize: 9, 
                                    color: '#dc2626', 
                                    maxWidth: usableWidth - 70,
                                    fontStyle: 'italic',
                                    lineHeightFactor: 1.5
                                });
                            }
                            
                            if (item.identified_opportunities && item.identified_opportunities.length > 0) {
                                yPosition = addFormattedText(`â˜… Opportunities: ${item.identified_opportunities.join(', ')}`, leftMargin + 55, yPosition + 8, { 
                                    fontSize: 9, 
                                    color: '#059669', 
                                    maxWidth: usableWidth - 70,
                                    fontStyle: 'italic',
                                    lineHeightFactor: 1.5
                                });
                            }
                            
                            yPosition += insightHeight - 60;
                        });
                    }
                });
            }
            
            // Enhanced footer with page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Footer line
                doc.setDrawColor('#e5e7eb');
                doc.setLineWidth(1);
                doc.line(leftMargin, pageHeight - 50, pageWidth - rightMargin, pageHeight - 50);
                
                // Page number
                doc.setFontSize(10);
                doc.setTextColor('#6b7280');
                doc.text(`Page ${i} of ${pageCount}`, pageWidth - rightMargin - 70, pageHeight - 30);
                
                // Footer text
                doc.text('AI Expert Panel Report - Confidential', leftMargin, pageHeight - 30);
            }
            
            doc.save('AI_Expert_Panel_Report.pdf');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            const resultsContentDiv = document.getElementById('results-content');
            if (!resultsContentDiv.innerHTML.trim()) {
                 resultsContentDiv.innerHTML = `<div class="content-section active" id="initial-message"><p>Please enter your business problem and click "Get Expert Insights" to begin.</p></div>`;
            }
            
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) progressContainer.style.display = 'none';
        });

    </script>
    
    <!-- Venice.ai Footer -->
    <footer class="venice-footer">
        <div class="venice-footer-content">
            <p>Powered by <a href="https://venice.ai" target="_blank" rel="noopener noreferrer" class="venice-link">Venice.ai</a></p>
        </div>
    </footer>
</body>
</html>