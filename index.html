<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The AI Partner - Strategic Business Consulting</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* Clean Black & White Color Palette */
            --primary-color: #000000; /* Pure Black */
            --primary-darker: #1a1a1a; 
            --secondary-color: #333333; /* Dark Gray */
            --accent-orange: #ff6b35;   
            --accent-coral: #ff4757;    
            --accent-yellow: #ffa502;   
            --accent-green: #2ed573;
            --accent-purple: #5f27cd;
            --light-green-bg: #f8f9fa;

            --text-color: #000000; 
            --light-text-color: #666666; 
            --bg-color: #ffffff; 
            --panel-bg: #ffffff;         
            --border-color: #e0e0e0;     
            
            --hover-bg-color: #f8f9fa;
            --active-nav-bg: #000000;
            --active-nav-text: #ffffff;

                    /* Left Panel - Light Grey */
        --left-panel-bg: #f8f9fa; /* Light light grey, almost white */
        --left-panel-text: #000000; /* Black text */
        --left-panel-header-text: #000000; /* Black header text */
        --left-panel-nav-item-hover-bg: #e9ecef; /* Slightly darker grey hover */
        --left-panel-nav-item-hover-text: #000000;
        --left-panel-nav-item-active-bg: #000000; /* Black active background */
        --left-panel-nav-item-active-text: #ffffff; /* White text on black */
        --left-panel-border-color: #dee2e6; /* Light grey border */

            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.2);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --border-radius-sm: 0px; /* Sharp edges */
            --border-radius-md: 0px; /* Sharp edges */
            --border-radius-lg: 0px; /* Sharp edges */
            --border-radius-xl: 0px; /* Sharp edges */
            
            /* Market Intelligence - Clean Black */
            --market-intel-primary: #000000; /* Black primary */
            --market-intel-secondary: #333333; /* Dark gray secondary */
            --market-intel-bg: #f8f9fa; /* Light gray background */
            --market-intel-border: #e0e0e0; /* Light gray border */
            --market-intel-accent: #000000; /* Black accent */
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5; /* Reduced for crispness */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 14px; /* Base font size reduced */
        }
        .header {
            background: var(--panel-bg);
            color: var(--primary-color);
            padding: 30px 40px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .header .subtitle {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-top: 8px;
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        .main-content-wrapper {
            display: flex;
            flex-grow: 1;
            max-width: 1500px; /* Slightly increased for better content space */
            width: 100%;
            margin: 20px auto; /* Reduced top/bottom margin */
            margin-left: 16px;
            margin-right: 16px;
            gap: 20px; /* Reduced gap for tighter layout */
            padding: 0 12px; /* Reduced padding */
        }

        #left-panel-nav {
            width: 280px;
            background: var(--left-panel-bg);
            color: var(--left-panel-text);
            padding: 30px;
            border-right: 2px solid var(--left-panel-border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        #left-panel-nav:hover {
            box-shadow: var(--shadow-lg);
        }

        #left-panel-nav h3 {
            color: var(--left-panel-header-text); /* Contrasting header text */
            border-bottom: 2px solid var(--secondary-color); /* Thicker border */
            padding-bottom: 18px; /* Increased padding */
            margin-top: 0; /* Adjusted margin */
            margin-bottom: 25px; /* Increased margin */
            font-size: 1.35em; /* Larger font */
            font-weight: 700; /* Bolder */
            padding-left: 5px;
            text-transform: uppercase; /* Modern uppercase styling */
            letter-spacing: 1px; /* Letter spacing for sophistication */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Subtle text shadow */
        }
        #left-panel-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) transparent;
        }
        
        #left-panel-nav ul::-webkit-scrollbar {
            width: 6px;
        }
        
        #left-panel-nav ul::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #left-panel-nav ul::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 3px;
        }
        
        #left-panel-nav li a {
            display: flex;
            align-items: center;
            padding: 15px 18px; /* Increased padding */
            text-decoration: none;
            color: var(--left-panel-text); /* Text color for nav items */
            border-radius: 12px; /* More rounded corners */
            margin: 6px 8px; /* Increased margin */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth easing */
            word-wrap: break-word;
            line-height: 1.4; /* Better line height */
            min-height: 50px; /* Increased min height */
            position: relative;
            backdrop-filter: blur(5px);
            border: 1px solid transparent; /* For smooth border transitions */
        }
        
        /* Add subtle glow effect */
        #left-panel-nav li a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        #left-panel-nav li a .nav-icon {
            margin-right: 15px; /* Increased margin */
            font-size: 1.3em; /* Larger icons */
            width: 24px; /* Increased width */
            text-align: center;
            opacity: 0.9; /* Slightly more visible */
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        #left-panel-nav li a:hover {
            background: linear-gradient(135deg, var(--left-panel-nav-item-hover-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-hover-bg) 85%, white) 100%); /* Gradient hover */
            color: var(--left-panel-nav-item-hover-text); /* Hover text */
            transform: translateX(6px) scale(1.02); /* Enhanced transform */
            box-shadow: 0 6px 20px rgba(50, 157, 156, 0.4); /* Color-coordinated shadow */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
        }
        
        #left-panel-nav li a:hover::before {
            opacity: 1;
        }
        
        #left-panel-nav li a:hover .nav-icon {
            opacity: 1;
            transform: scale(1.1); /* Icon scale effect */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
        }

        #left-panel-nav li a.active,
        #left-panel-nav li a.processing-nav-item {
            background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%); /* Gradient active */
            color: var(--left-panel-nav-item-active-text); /* Active text */
            font-weight: 700; /* Bolder for active */
            box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5); /* Orange shadow for active */
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateX(4px) scale(1.02);
        }
        
        #left-panel-nav li a.active::before,
        #left-panel-nav li a.processing-nav-item::before {
            opacity: 1;
        }
        
        #left-panel-nav li a.active .nav-icon, 
        #left-panel-nav li a.processing-nav-item .nav-icon {
             opacity: 1;
             color: var(--left-panel-nav-item-active-text); /* Ensure icon color matches */
             transform: scale(1.1);
             filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        #left-panel-nav li a.processing-nav-item {
            animation: navPulse 1.5s infinite ease-in-out; /* Slower, smoother animation */
        }
        @keyframes navPulse { /* Enhanced pulse animation */
            0% { 
                background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%);
                box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5);
                transform: translateX(4px) scale(1.02);
            }
            50% { 
                background: linear-gradient(135deg, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 80%, black) 0%, var(--left-panel-nav-item-active-bg) 100%);
                box-shadow: 0 12px 35px rgba(249, 160, 63, 0.7);
                transform: translateX(6px) scale(1.05);
            }
            100% { 
                background: linear-gradient(135deg, var(--left-panel-nav-item-active-bg) 0%, color-mix(in srgb, var(--left-panel-nav-item-active-bg) 90%, yellow) 100%);
                box-shadow: 0 8px 25px rgba(249, 160, 63, 0.5);
                transform: translateX(4px) scale(1.02);
            }
        }

        .container { 
            flex-grow: 1;
            flex-shrink: 1; /* Allow shrinking if needed */
            min-width: 0; /* Important for flex child to shrink */
            padding: 0; 
            background: transparent; 
            overflow-y: auto;
            max-width: calc(100vw - 350px); /* Ensure it doesn't exceed viewport */
        }

        .input-section {
            background: linear-gradient(135deg, var(--panel-bg) 0%, color-mix(in srgb, var(--panel-bg) 98%, var(--secondary-color)) 100%);
            padding: 30px 35px; /* Reduced padding */
            border-radius: var(--border-radius-lg);
            margin-bottom: 35px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 1px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            max-width: 100%; /* Ensure it doesn't exceed container */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        /* Add subtle pattern to input section */
        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 80% 20%, rgba(50, 157, 156, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Landing overlay */
        .landing-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0ea5e9 0%, #1f2937 40%, #000000 100%);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .landing-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border-radius: 0px;
            max-width: 900px;
            padding: 40px 36px;
        }
        .landing-title {
            margin: 0 0 12px 0;
            font-size: 2.4em;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        .landing-subtitle {
            margin: 0 0 24px 0;
            font-size: 1.1em;
            color: #e5e7eb;
        }
        .landing-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
            margin: 16px 0 28px 0;
            color: #e5e7eb;
        }
        .landing-enter {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 14px 22px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }
        .landing-enter:hover { transform: translateY(-1px); background: #111827; }
        
        .input-section > * {
            position: relative;
            z-index: 1;
        }
        
         .input-section p {
            font-size: 1.1em; /* Larger font */
            color: var(--light-text-color);
            margin-bottom: 22px; /* Increased margin */
            font-weight: 400;
            line-height: 1.6;
        }

        textarea {
            width: 100%; /* Fixed width to stay within container */
            min-height: 140px; /* Taller */
            padding: 20px; /* Increased padding */
            margin-bottom: 25px; /* Increased margin */
            border-radius: var(--border-radius-md); /* Larger radius */
            border: 2px solid var(--border-color); /* Thicker border */
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 98%, var(--light-green-bg)) 100%);
            color: var(--text-color);
            font-size: 1.05em; /* Slightly larger */
            font-family: var(--font-family);
            transition: all 0.3s ease;
            resize: vertical; /* Allow vertical resize */
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.05); /* Enhanced shadows */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        textarea:focus {
            border-color: var(--secondary-color); /* Use secondary for focus */
            outline: 0;
            box-shadow: 0 0 0 0.3rem color-mix(in srgb, var(--secondary-color) 20%, transparent), inset 0 2px 8px rgba(0, 0, 0, 0.06), 0 4px 15px rgba(50, 157, 156, 0.15); /* Enhanced focus ring */
            transform: translateY(-2px); /* Subtle lift on focus */
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 95%, var(--secondary-color)) 100%);
        }

        button {
            display: inline-block;
            padding: 15px 30px; /* Larger buttons */
            background: linear-gradient(135deg, var(--secondary-color) 0%, color-mix(in srgb, var(--secondary-color) 85%, var(--primary-color)) 100%); /* Gradient background */
            color: white;
            border: none;
            border-radius: var(--border-radius-md); /* Larger radius */
            font-size: 1.05em; /* Larger font */
            font-weight: 600; /* Bolder */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth easing */
            margin-right: 15px; /* Increased margin */
            margin-bottom: 15px; /* Increased margin */
            box-shadow: 0 4px 15px rgba(50, 157, 156, 0.3); /* Color-coordinated shadow */
            position: relative;
            overflow: hidden;
        }
        
        /* Button shine effect */
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--secondary-color) 90%, black) 0%, var(--secondary-color) 100%); /* Enhanced gradient */
            transform: translateY(-3px) scale(1.02); /* Enhanced transform */
            box-shadow: 0 8px 25px rgba(50, 157, 156, 0.4); /* Enhanced shadow */
        }
        button:disabled {
            background: linear-gradient(135deg, #B0BEC5 0%, #90A4AE 100%); /* Gradient for disabled */
            color: #78909C;
            cursor: not-allowed;
            transform: translateY(0) scale(1);
            box-shadow: none;
        }
        button:disabled::before {
            display: none;
        }

        .progress-container {
            display: none;
            margin-top: auto; 
            padding: 18px 12px; /* Increased padding */
            background-color: var(--left-panel-bg); /* Match panel background */
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md); /* Rounded bottom corners */
            border-top: 1px solid var(--left-panel-border-color); /* Match panel border */
        }
        .progress-bar {
            width: 100%;
            background-color: color-mix(in srgb, var(--left-panel-text) 20%, transparent); /* Lighter bar background */
            border-radius: var(--border-radius-sm);
            padding: 3px; /* Increased padding */
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar-inner {
            display: block;
            height: 20px; /* Taller bar */
            width: 0%;
            background: linear-gradient(90deg, 
                var(--accent-green) 0%, 
                var(--accent-purple) 25%, 
                var(--accent-orange) 50%, 
                var(--accent-yellow) 75%, 
                var(--accent-green) 100%);
            border-radius: var(--border-radius-sm); /* Match outer radius */
            text-align: center;
            line-height: 20px;
            color: var(--text-color); /* Darker text for visibility on yellow/orange */
            font-weight: 600; /* Bolder */
            font-size: 0.85em;
            transition: width 0.8s ease;
            position: relative;
            animation: progressShimmer 2s linear infinite;
        }

        @keyframes progressShimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .progress-bar-inner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        #statusMessage {
            font-style: italic;
            color: var(--left-panel-text); /* Match panel text */
            margin-top: 12px;
            text-align: center;
            font-size: 0.9em;
        }

        #results-content .content-section {
            display: none;
            background: linear-gradient(135deg, var(--panel-bg) 0%, color-mix(in srgb, var(--panel-bg) 99%, var(--light-green-bg)) 100%);
            padding: 0;
            border-radius: var(--border-radius-lg);
            margin-bottom: 35px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08), 0 2px 10px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            max-width: 100%; /* Ensure content doesn't exceed container */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        /* Modern Card Header */
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-darker) 100%);
            color: white;
            padding: 25px 30px;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }
        
        .card-header .header-icon {
            font-size: 2em;
            opacity: 0.9;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .card-header .expert-badge {
            background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-coral) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-left: auto;
        }
        
        /* Card Content */
        .card-content {
            padding: 25px 30px; /* Reduced padding */
            position: relative;
            z-index: 1;
            word-wrap: break-word; /* Ensure long text wraps */
            overflow-wrap: break-word; /* Modern alternative */
        }
        
        /* Enhanced Insight Blocks */
        .insight-block, .key-finding-block {
            border: none;
            padding: 25px;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #fff 0%, color-mix(in srgb, #fff 97%, var(--light-green-bg)) 100%);
            border-radius: var(--border-radius-md);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08), 0 1px 6px rgba(0, 0, 0, 0.04);
            position: relative;
            transition: all 0.3s ease;
            border-left: 5px solid;
        }
        
        .insight-block {
            border-left-color: var(--accent-orange);
        }
        
        .key-finding-block {
            border-left-color: var(--secondary-color);
        }
        
        .insight-block::before,
        .key-finding-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-orange), var(--accent-coral));
            border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
        }
        
        .key-finding-block::before {
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-yellow));
        }
        
        .insight-block:hover, .key-finding-block:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12), 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* Modern Action Steps */
        .action-step {
            background: linear-gradient(135deg, var(--light-green-bg) 0%, color-mix(in srgb, var(--light-green-bg) 90%, white) 100%);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-md);
            border: 2px solid color-mix(in srgb, var(--secondary-color) 30%, transparent);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .action-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-orange));
        }
        
        .action-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        
        .action-step .step-number {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-orange) 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Priority Badges */
        .priority-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            margin-left: 10px;
        }
        
        .priority-High {
            background: linear-gradient(135deg, var(--accent-coral) 0%, #e53e3e 100%);
            color: white;
        }
        
        .priority-Medium {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #f6ad55 100%);
            color: white;
        }
        
        .priority-Low {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #68d391 100%);
            color: white;
        }
        
        /* Modern Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid color-mix(in srgb, var(--primary-color) 20%, transparent);
            position: relative;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-orange));
            border-radius: 2px;
        }
        
        .section-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .section-header .section-icon {
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        
        /* Expert Info Card */
        .expert-info {
            background: linear-gradient(135deg, color-mix(in srgb, var(--secondary-color) 10%, transparent) 0%, transparent 100%);
            border: 1px solid color-mix(in srgb, var(--secondary-color) 30%, transparent);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .expert-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--secondary-color), var(--accent-orange));
            border-radius: 2px 0 0 2px;
        }
        
        .expert-role {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .expert-focus {
            font-size: 0.9em;
            color: var(--light-text-color);
            font-style: italic;
        }

        /* Responsive Design Improvements */
        @media (max-width: 1400px) {
            .main-content-wrapper {
                margin-left: 15px;
                margin-right: 15px;
                max-width: 100%;
                gap: 20px;
                padding: 0 10px;
            }
            
            #left-panel-nav {
                width: 260px;
            }
            
            .container {
                max-width: calc(100vw - 320px);
            }
        }
        
        @media (max-width: 1200px) {
            .main-content-wrapper {
                margin-left: 10px;
                margin-right: 10px;
                max-width: 95%;
                gap: 15px;
                padding: 0 5px;
            }
            
            #left-panel-nav {
                width: 240px;
            }
            
            .container {
                max-width: calc(100vw - 280px);
            }
        }
        
        @media (max-width: 768px) {
            .main-content-wrapper {
                flex-direction: column;
                margin-left: 10px;
                margin-right: 10px;
                padding: 0 5px;
                gap: 20px;
            }
            
            #left-panel-nav {
                width: 100%;
                order: 2; /* Move navigation below content on mobile */
            }
            
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .input-section {
                padding: 20px 25px;
            }
            
            #results-content .content-section {
                padding: 0;
            }
            
            .card-content {
                padding: 20px 25px;
            }
            
            textarea {
                min-height: 100px;
            }
            
            button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            button#downloadPdfButton {
                width: auto;
                display: inline-block;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content-wrapper {
                margin: 15px 5px;
                padding: 0;
            }
            
            .input-section, .card-content {
                padding: 15px 20px;
            }
            
            #results-content h2 {
                font-size: 1.6em;
            }
            
            #results-content h3 {
                font-size: 1.4em;
            }
        }

        /* Enhanced Focus States for Accessibility */
        button:focus-visible, 
        textarea:focus-visible,
        #left-panel-nav li a:focus-visible {
            outline: 3px solid var(--accent-orange);
            outline-offset: 2px;
        }
        
        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection styling */
        ::selection {
            background-color: color-mix(in srgb, var(--secondary-color) 30%, transparent);
            color: var(--primary-darker);
        }

        #results-content .content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0px);
        }

        /* Additional missing styles */
        button#downloadPdfButton {
            background: linear-gradient(135deg, var(--accent-orange) 0%, color-mix(in srgb, var(--accent-orange) 90%, var(--accent-coral)) 100%);
            font-size: 1.1em;
            padding: 18px 35px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(249, 160, 63, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button#downloadPdfButton:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--accent-orange) 90%, black) 0%, var(--accent-orange) 100%);
            box-shadow: 0 10px 35px rgba(249, 160, 63, 0.6);
            transform: translateY(-4px) scale(1.03);
        }

        .error {
            color: #b71c1c;
            font-weight: 500;
            padding: 0;
            background: none;
            border: none;
            margin-bottom: 25px;
        }

        /* Modern Loading States */
        .content-section.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .content-section.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Enhanced Modern Spinner */
        .modern-spinner {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            position: relative;
        }

        .modern-spinner::before,
        .modern-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            animation: modernSpin 2s linear infinite;
        }

        .modern-spinner::before {
            width: 60px;
            height: 60px;
            border: 4px solid transparent;
            border-top: 4px solid var(--secondary-color);
            border-right: 4px solid var(--accent-orange);
        }

        .modern-spinner::after {
            width: 40px;
            height: 40px;
            top: 10px;
            left: 10px;
            border: 3px solid transparent;
            border-bottom: 3px solid var(--accent-purple);
            border-left: 3px solid var(--accent-green);
            animation: modernSpin 1.5s linear infinite reverse;
        }

        @keyframes modernSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Processing Notification */
        .processing-notification {
            display: none;
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            padding: 30px;
            margin-top: 25px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            animation: processingPulse 2s ease-in-out infinite;
        }

        @keyframes processingPulse {
            0%, 100% { 
                box-shadow: var(--shadow-lg);
                transform: scale(1);
            }
            50% { 
                box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 123, 255, 0.3);
                transform: scale(1.01);
            }
        }
        
        /* Persona Generation Styles */
        .persona-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInPersona 0.5s ease forwards;
        }
        
        .persona-item.generating {
            border-color: var(--accent-orange);
            background: linear-gradient(90deg, var(--bg-color) 0%, rgba(255, 107, 53, 0.1) 100%);
        }
        
        .persona-item.complete {
            border-color: var(--accent-green);
            background: linear-gradient(90deg, var(--bg-color) 0%, rgba(46, 213, 115, 0.1) 100%);
        }
        
        .persona-icon {
            font-size: 1.5em;
            margin-right: 16px;
            min-width: 24px;
            text-align: center;
        }
        
        .persona-info {
            flex: 1;
            text-align: left;
        }
        
        .persona-name {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-color);
            margin: 0 0 4px 0;
        }
        
        .persona-role {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin: 0;
        }
        
        .persona-status {
            font-size: 0.8em;
            font-weight: 500;
            margin-left: 12px;
        }
        
        .persona-status.generating {
            color: var(--accent-orange);
        }
        
        .persona-status.complete {
            color: var(--accent-green);
        }
        
        @keyframes slideInPersona {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .processing-notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .processing-notification.visible {
            display: block;
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .processing-notification h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .processing-notification h3 span {
            font-size: 1.5em;
            animation: spin 2s linear infinite;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            position: relative;
        }

        .processing-spinner::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 4px solid transparent;
            border-top: 4px solid var(--accent-purple);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Market Intelligence Specific Styles */
        .content-section[id*="market-"] {
            border-left: 5px solid var(--market-intel-primary) !important;
            background: linear-gradient(135deg, var(--market-intel-bg) 0%, #ffffff 100%) !important;
        }
        
        .content-section[id*="market-"] .card-header {
            background: linear-gradient(135deg, var(--market-intel-primary) 0%, var(--market-intel-secondary) 100%) !important;
            color: white !important;
        }
        
        .content-section[id*="market-"] .expert-badge {
            background: var(--market-intel-accent) !important;
            color: white !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .content-section[id*="market-"] .expert-info {
            background: linear-gradient(135deg, color-mix(in srgb, var(--market-intel-secondary) 15%, transparent) 0%, transparent 100%) !important;
            border-color: var(--market-intel-border) !important;
        }
        
                 #left-panel-nav li a[onclick*="market-"] {
             background: linear-gradient(135deg, var(--market-intel-bg) 0%, transparent 100%);
             border-left: 3px solid var(--market-intel-border);
         }
         
         #left-panel-nav li a[onclick*="market-"]:hover {
             background: linear-gradient(135deg, var(--market-intel-primary) 0%, var(--market-intel-secondary) 100%) !important;
             color: white !important;
         }
        
        /* Crisp Typography Improvements */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.01em;
        }
        
        .card-header h2 {
            font-size: 1.3em; /* Reduced for better fit */
            margin: 0;
        }
        
        .section-header h3 {
            font-size: 1.1em; /* Reduced for better fit */
            margin: 0;
        }
        
        .expert-info .expert-role {
            font-size: 0.9em; /* Smaller for crisper look */
            margin-bottom: 8px;
        }
        
        .expert-badge {
            font-size: 0.75em; /* Smaller badge text */
            padding: 4px 10px;
            font-weight: 600;
        }
        
        /* Compact spacing improvements */
        .card-content {
            padding: 18px 22px; /* Reduced padding */
        }
        
        .section-header {
            margin: 20px 0 12px 0; /* Reduced margins */
        }
        
        .expert-info {
            margin-bottom: 18px; /* Reduced margin */
            padding: 16px 18px; /* Reduced padding */
        }
        
        /* Better button styles */
        .example-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Improved input section */
        .input-section p {
            font-size: 0.95em;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        #businessProblem {
            font-size: 0.9em;
            line-height: 1.4;
            padding: 14px 16px;
        }

        .venice-footer {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-darker) 100%);
            color: #ffffff;
            padding: 20px 0;
            text-align: center;
            margin-top: auto;
            box-shadow: 0 -4px 20px rgba(30, 64, 175, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .venice-footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .venice-footer p {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .venice-link {
            color: #ffffff;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .venice-link:hover {
            color: var(--secondary-color);
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .venice-link:active {
            transform: translateY(0);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .venice-footer {
                padding: 15px 0;
            }
            
            .venice-footer p {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Minimal landing overlay (one button to enter) -->
    <div id="landingOverlay" class="landing-overlay">
        <div class="landing-card">
            <div class="landing-title">The AI Partner</div>
            <div class="landing-subtitle">We bring a panel of expert AI personas to analyze your business challenge, synthesize their perspectives, and present a boardroom-ready reportâ€”fast.</div>
            <div style="border-top: 1px solid rgba(255,255,255,0.25); margin: 12px 0 18px 0;"></div>
            <div style="font-weight:700; margin-bottom: 6px;">What weâ€™re building</div>
            <div class="landing-list">
                <div>â€¢ Multi-expert analysis across strategy, finance, GTM, and ops</div>
                <div>â€¢ Clean, client-ready deliverables (PDF and HTML)</div>
                <div>â€¢ Market intelligence addâ€‘ons when helpful</div>
                <div>â€¢ Optional Work Chart to redesign workflows with Humans + AI</div>
            </div>
            <div class="landing-cta-row" style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="#main" onclick="document.getElementById('landingOverlay').style.display='none'" 
                   class="landing-enter landing-enter-link" 
                   style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 240px;">
                    Explore Expert Panel
                </a>
                <a href="Work Chart.html" target="_blank" rel="noopener" 
                   class="landing-enter landing-enter-link" 
                   style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 240px;">
                    Open Work Chart
                </a>
            </div>
        </div>
    </div>

    <header class="header">
        <h1>The AI Partner</h1>
        <div class="subtitle">Strategic consulting for small businesses. Get partner-level insights without the partner-level price tag.</div>
    </header>

    <!-- AI Partner overview and value proposition -->
    <section id="ai-partner-info" style="max-width: 1100px; margin: 24px auto 0 auto; padding: 20px 16px;">
        <div style="background: var(--panel-bg); border: 2px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 22px;">
            <h2 style="margin: 0 0 8px 0; font-size: 1.6em; letter-spacing: -0.01em;">Meet your AI Partner</h2>
            <p style="margin: 6px 0 16px 0; color: var(--light-text-color); font-size: 1.05em; line-height: 1.65;">
                Our AI Partner brings a panel of specialized AI personas to analyze your challenge from multiple anglesâ€”strategy, finance, operations, GTM, and more. 
                It compresses what traditionally takes weeks and six figures into minutes and dollars, <strong>revolutionizing and democratizing</strong> access to topâ€‘tier strategy.
            </p>

            <!-- Comparison table: Traditional vs AI-powered -->
            <div style="overflow-x: auto; margin: 14px 0 18px 0;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color);">Dimension</th>
                            <th style="text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color);">Traditional Consulting</th>
                            <th style="text-align: left; padding: 12px; border-bottom: 2px solid var(--border-color);">AIâ€‘Powered (The AI Partner)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Cost</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">$50,000â€“$250,000+ per engagement</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);"><strong>$</strong> payâ€‘asâ€‘youâ€‘go (tokens)</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Speed</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Weeks to months</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Minutes to hours</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Availability</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Business hours, limited bandwidth</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">24/7, parallelized experts</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Perspective</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Small team, single POV</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Multiâ€‘expert synthesis</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Transparency</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Opaque staffing & billable hours</td>
                            <td style="padding: 10px; border-bottom: 1px solid var(--border-color);">Tokenâ€‘level cost visibility</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Deliverables</td>
                            <td style="padding: 10px;">Slides + narrative after weeks</td>
                            <td style="padding: 10px;">Instant report + exportable PDF/HTML</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Benefits list -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
                <div style="background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;">âœ… Partnerâ€‘level thinking for small businesses</div>
                <div style="background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;">âœ… Multiâ€‘angle analysis reduces blind spots</div>
                <div style="background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;">âœ… Clear, clientâ€‘ready deliverables</div>
                <div style="background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;">âœ… Realâ€‘time token cost tracking</div>
                <div style="background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;">âœ… Scales with your needsâ€”no long contracts</div>
            </div>
        </div>
    </section>

    <div class="main-content-wrapper">
        <nav id="left-panel-nav">
            <h3>Navigation</h3>
            <div class="quick-links" style="margin: 8px 8px 4px 8px;">
                <a href="Work Chart.html" target="_blank" rel="noopener" 
                   style="display: flex; align-items: center; padding: 15px 18px; text-decoration: none; color: var(--left-panel-text); border-radius: 12px; margin: 6px 0; border: 1px solid var(--left-panel-border-color);">
                    <span class="nav-icon" style="margin-right: 12px;">ðŸ“ˆ</span>
                    Work Chart
                </a>
            </div>
            <ul id="navigationList">
                <!-- Navigation items will be populated dynamically -->
            </ul>
            
            <!-- Example Problems Section -->
            <div class="examples-section-nav" style="margin-top: 30px;">
                <h4 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 1.1em; font-weight: 600;">ðŸ’¡ Example Problems:</h4>
                <div class="example-buttons-nav" style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="example-btn-nav" onclick="setExampleProblem('startup-marketing')" style="padding: 10px 12px; background: var(--text-color); color: white; border: none; cursor: pointer; font-size: 0.85em; transition: all 0.3s ease; font-weight: 500; text-align: left;">
                        ðŸš€ Startup Marketing Strategy
                    </button>
                    <button class="example-btn-nav" onclick="setExampleProblem('digital-transformation')" style="padding: 10px 12px; background: var(--text-color); color: white; border: none; cursor: pointer; font-size: 0.85em; transition: all 0.3s ease; font-weight: 500; text-align: left;">
                        ðŸ’» Digital Transformation
                    </button>
                    <button class="example-btn-nav" onclick="setExampleProblem('supply-chain')" style="padding: 10px 12px; background: var(--text-color); color: white; border: none; cursor: pointer; font-size: 0.85em; transition: all 0.3s ease; font-weight: 500; text-align: left;">
                        ðŸ“¦ Supply Chain Optimization
                    </button>
                    <button class="example-btn-nav" onclick="setExampleProblem('customer-retention')" style="padding: 10px 12px; background: var(--text-color); color: white; border: none; cursor: pointer; font-size: 0.85em; transition: all 0.3s ease; font-weight: 500; text-align: left;">
                        ðŸ¤ Customer Retention Crisis
                    </button>
                    <button class="example-btn-nav" onclick="setExampleProblem('ai-implementation')" style="padding: 10px 12px; background: var(--text-color); color: white; border: none; cursor: pointer; font-size: 0.85em; transition: all 0.3s ease; font-weight: 500; text-align: left;">
                        ðŸ¤– AI Implementation Strategy
                    </button>
                </div>
            </div>
        </nav>

        <main class="container" id="right-panel-container">
            <div class="input-section">
                <p>Describe your business challenge. Our AI partners will analyze your problem from every angle and deliver strategic insights that would cost $50,000+ from traditional consulting firms.</p>
                

                <div class="time-notice" style="background: var(--bg-color); 
                                                border: 2px solid var(--border-color); padding: 15px 20px; 
                                                margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.2em;">â±ï¸</span>
                    <div>
                        <strong style="color: var(--text-color); font-size: 0.95em;">Processing Time:</strong>
                        <span style="color: var(--light-text-color); font-size: 0.9em; margin-left: 8px;">Analysis may take up to 10 minutes to complete</span>
                    </div>
                </div>
                <textarea id="businessProblem" placeholder="Describe your business problem here..."></textarea>
                <button id="submitButton" onclick="submitProblem()">Get Expert Insights</button>
                <button id="downloadPdfButton" onclick="downloadPDF()" style="display:none;">Download PDF</button>
                <button id="downloadHtmlButton" onclick="downloadHTML()" style="display:none; margin-left:8px;">Download HTML</button>
                
                <!-- Modern Processing Notification -->
                <div class="processing-notification" id="processingNotification">
                    <div class="processing-spinner"></div>
                    <h3>
                        <span>ðŸŽ¯</span>
                        Your AI Partners at Work
                    </h3>
                    <p id="processingStatus">Your AI partners are analyzing your business challenge...</p>
                    
                    <div class="progress-info">
                        <div class="progress-bar-modern">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0% Complete</div>
                    </div>
                    
                    <!-- Animated Persona Generation Section -->
                    <div class="persona-generation-section" id="personaGenerationSection" style="display: none;">
                        <h4 style="margin: 0 0 20px 0; color: var(--text-color); font-size: 1.2em; font-weight: 600;">
                            ðŸŽ¯ Invoking AI Partners
                        </h4>
                        <div class="persona-list" id="personaList" style="display: grid; gap: 12px; max-height: 300px; overflow-y: auto;">
                            <!-- Personas will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Educational Text Section -->
                    <div class="educational-text-container" style="margin-top: 25px; padding: 20px; 
                                                                  background: var(--bg-color);
                                                                  border: 2px solid var(--border-color);
                                                                  min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        <p id="educationalText" style="margin: 0; font-size: 1.05em; line-height: 1.6; 
                                                      color: var(--text-color); text-align: center; 
                                                      font-weight: 500; transition: opacity 0.5s ease;">
                            Multiple perspectives reveal blind spots that single viewpoints often miss.
                        </p>
                    </div>
                    
                    <!-- Mobile Warning -->
                    <div id="mobileWarning" style="display: none; margin-top: 20px; padding: 15px; 
                                                  background: rgba(255, 193, 7, 0.1); 
                                                  border: 1px solid rgba(255, 193, 7, 0.3); 
                                                  border-radius: 4px;">
                        <p style="margin: 0; font-size: 0.9em; color: var(--text-color); text-align: center;">
                            ðŸ“± <strong>Mobile Users:</strong> Keep this app active and don't switch to other apps during processing to avoid connection issues.
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="results-content">
                <!-- Content sections will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <script>
        // Configuration for backend URL
        const BACKEND_URL = window.location.hostname === 'localhost' ? 
            'http://127.0.0.1:5000' : 
            'https://expert-panel.onrender.com';

        const STAGE_IDLE = -1;
        const STAGE_INIT = 0;
        const STAGE_PERSONA_GENERATION_START = 1;
        const STAGE_PERSONA_GENERATION_COMPLETE = 2;
        const STAGE_BACKEND_PROCESSING_COMPLETE = 3;
        const STAGE_PERSONA_INSIGHT_COLLECTION_START = 4; 
        const MAX_EXPECTED_PERSONAS_FOR_PROGRESS = 15;
        const STAGE_SEARCH_ASSISTANT_START = STAGE_PERSONA_INSIGHT_COLLECTION_START + MAX_EXPECTED_PERSONAS_FOR_PROGRESS;
        const STAGE_SEARCH_ASSISTANT_COMPLETE = STAGE_SEARCH_ASSISTANT_START + 1;
        const STAGE_SYNTHESIS_START = STAGE_SEARCH_ASSISTANT_COMPLETE + 1;
        const STAGE_SYNTHESIS_COMPLETE = STAGE_SYNTHESIS_START + 1;
        const STAGE_DISPLAY_RESULTS = STAGE_SYNTHESIS_COMPLETE + 1;
        const STAGE_ALL_COMPLETE = STAGE_DISPLAY_RESULTS + 1;
        const TOTAL_PROGRESS_STAGES = STAGE_ALL_COMPLETE;

        let currentProgressNumericStage = STAGE_IDLE;
        let globalReportData = null;
        let activeContentId = null;
        let allProcessedItemNames = [];
        let educationalTextInterval = null;
        
        // Cost tracking variables
        let processStartTime = null;
        let processEndTime = null;
        let costData = {
            orchestrator: { inputTokens: 0, outputTokens: 0, cost: 0 },
            personas: { inputTokens: 0, outputTokens: 0, cost: 0 },
            searchReports: { inputTokens: 0, outputTokens: 0, cost: 0 },
            synthesis: { inputTokens: 0, outputTokens: 0, cost: 0 },
            total: { inputTokens: 0, outputTokens: 0, cost: 0 }
        };
        
        // Venice AI pricing per million tokens (based on the rate card)
        const VENICE_PRICING = {
            'llama-3.1-405b': { input: 1.50, output: 6.00 }, // Venice Large
            'qwen3-235b': { input: 1.50, output: 6.00 }, // Venice Large
            'qwen-2.5-qwq-32b': { input: 0.50, output: 2.00 }, // Venice Medium
            'qwen3-4b': { input: 0.15, output: 0.60 } // Venice Small
        };

        // Educational text messages about the platform's value
        const educationalMessages = [
            "Get partner-level strategic insights without the $50,000+ consulting bill.",
            "Small businesses deserve the same strategic thinking as Fortune 500 companies.",
            "Our AI partners work 24/7 and never charge by the hour.",
            "Strategic consulting shouldn't be a luxury reserved for big corporations.",
            "Get multiple expert perspectives for the price of a coffee.",
            "Why pay $500/hour when AI partners deliver better insights?",
            "Traditional consulting firms are expensive. AI partners are effective.",
            "Strategic insights that would cost $100,000+ from large consulting firms, delivered instantly.",
            "Small business problems deserve big business thinking.",
            "Our AI partners don't have conflicts of interest - just your best interests.",
            "Get the strategic analysis that would take months and cost six figures.",
            "Why hire one expensive consultant when you can have 20 AI partners?",
            "Strategic consulting democratized for every business size.",
            "Partner-level insights without the partner-level overhead.",
            "Your business deserves strategic thinking, not just tactical advice.",
            "Bypass the traditional consulting bottleneck - get answers in minutes, not months.",
            "Level the playing field against larger competitors with AI-powered strategy.",
            "Reduce decision paralysis with clear, actionable strategic recommendations.",
            "Access to specialized expertise across multiple domains simultaneously.",
            "Real-time market analysis that adapts to changing business conditions.",
            "Cost-effective alternative to hiring expensive strategy consultants.",
            "No geographical limitations - expert insights available anywhere, anytime.",
            "Rapid prototyping of strategic initiatives before major investments.",
            "Continuous strategic monitoring without ongoing consulting fees.",
            "Democratized access to high-level strategic thinking for small businesses.",
            "Eliminate the need for multiple consultant meetings and presentations.",
            "Get strategic insights that would cost $50,000+ from large consulting firms.",
            "Transform complex business challenges into clear strategic roadmaps.",
            "Access to cutting-edge AI models that large consulting firms use internally.",
            "Rapid strategic pivots based on real-time market intelligence.",
            "Comprehensive competitive analysis without the traditional consulting overhead.",
            "Strategic planning that adapts to your business's unique constraints.",
            "Immediate access to industry best practices and strategic frameworks."
        ];

        // Background processing messages that show what's happening
        const backgroundMessages = [
            "ðŸ” Analyzing market trends and competitive landscape...",
            "ðŸ“Š Gathering industry insights and best practices...",
            "ðŸŽ¯ Evaluating strategic options and potential outcomes...",
            "ðŸŒ Researching current market conditions and opportunities...",
            "ðŸ§  Synthesizing expert perspectives and recommendations...",
            "ðŸ“‹ Compiling comprehensive strategic analysis...",
            "âš¡ Finalizing actionable recommendations...",
            "ðŸ“ˆ Preparing executive summary and implementation plan...",
            "ðŸ”¬ Conducting deep-dive market research...",
            "ðŸ’¡ Generating innovative strategic approaches...",
            "ðŸ“± Analyzing digital transformation opportunities...",
            "ðŸ’° Evaluating financial implications and ROI...",
            "ðŸš€ Identifying growth and scaling opportunities...",
            "ðŸ›¡ï¸ Assessing risks and mitigation strategies...",
            "ðŸ¤ Analyzing customer and stakeholder perspectives...",
            "âš™ï¸ Reviewing operational efficiency opportunities...",
            "ðŸ“ˆ Examining performance metrics and KPIs...",
            "ðŸŒ Researching global market trends and opportunities...",
            "ðŸ”® Forecasting future market developments...",
            "ðŸ“Š Creating data-driven strategic frameworks..."
        ];

        function startEducationalTextRotation() {
            const educationalTextElement = document.getElementById('educationalText');
            const processingStatus = document.getElementById('processingStatus');
            if (!educationalTextElement) return;

            let currentIndex = 0;
            
            educationalTextInterval = setInterval(() => {
                // Fade out
                educationalTextElement.style.opacity = '0';
                
                setTimeout(() => {
                    // Change text to random message
                    const randomIndex = Math.floor(Math.random() * educationalMessages.length);
                    educationalTextElement.textContent = educationalMessages[randomIndex];
                    
                    // Fade in
                    educationalTextElement.style.opacity = '1';
                }, 500); // Half second for fade transition
                
            }, 7000); // Change every 7 seconds

            // Also rotate background processing messages
            if (processingStatus) {
                let bgIndex = 0;
                setInterval(() => {
                    if (processingStatus.textContent.includes('Initializing') || 
                        processingStatus.textContent.includes('Processing') ||
                        processingStatus.textContent.includes('Analyzing')) {
                        processingStatus.textContent = backgroundMessages[bgIndex % backgroundMessages.length];
                        bgIndex++;
                    }
                }, 3000); // Change every 3 seconds
            }
        }

        function stopEducationalTextRotation() {
            if (educationalTextInterval) {
                clearInterval(educationalTextInterval);
                educationalTextInterval = null;
            }
        }

        function hideProcessingNotification() {
            const processingNotification = document.getElementById('processingNotification');
            if (processingNotification) {
                processingNotification.classList.remove('visible');
            }
            stopEducationalTextRotation();
        }

        function showProcessingNotification() {
            const processingNotification = document.getElementById('processingNotification');
            const mobileWarning = document.getElementById('mobileWarning');
            
            if (processingNotification) {
                processingNotification.classList.add('visible');
            }
            
            // Show mobile warning for mobile devices
            if (isMobileDevice && mobileWarning) {
                mobileWarning.style.display = 'block';
            }
            
            startEducationalTextRotation();
        }

        function getNavIcon(itemName) {
            itemName = itemName.toLowerCase();
            if (itemName.includes('report')) return '&#128221;'; // Document
            if (itemName.includes('search') || itemName.includes('research')) return '&#128269;'; // Magnifying glass
            if (itemName.includes('analyst')) return '&#128202;'; // Chart
            if (itemName.includes('strategist')) return '&#127919;'; // Target
            if (itemName.includes('technologist') || itemName.includes('tech')) return '&#128187;'; // Laptop
            if (itemName.includes('customer') || itemName.includes('user')) return '&#128101;'; // Group of users
            if (itemName.includes('risk')) return '&#9888;&#65039;'; // Warning
            if (itemName.includes('ethicist')) return '&#9878;&#65039;'; // Scales
            if (itemName.includes('futurist')) return '&#128302;'; // Crystal ball
            if (itemName.includes('financial') || itemName.includes('finance')) return '&#128176;'; // Money bag
            if (itemName.includes('legal')) return '&#128206;'; // Books/ledger
            if (itemName.includes('marketing')) return '&#128227;'; // Loudspeaker
            return '&#128100;'; // Default user icon
        }

        // Realistic progress simulation for 10-minute process
        let progressSimulationInterval = null;
        let currentSimulatedProgress = 0;
        let progressStartTime = null;

        function startRealisticProgressSimulation() {
            progressStartTime = Date.now();
            currentSimulatedProgress = 0;
            
            // Clear any existing simulation
            if (progressSimulationInterval) {
                clearInterval(progressSimulationInterval);
            }
            
            // Update progress every 100ms for smooth animation
            progressSimulationInterval = setInterval(() => {
                const elapsed = (Date.now() - progressStartTime) / 1000; // seconds
                const totalExpectedTime = 600; // 10 minutes in seconds
                
                // Realistic progress curve: slow start, faster middle, slow finish
                let progressRatio = elapsed / totalExpectedTime;
                
                // Apply easing curve for more realistic progress
                if (progressRatio < 0.1) {
                    // Slow start (0-10% in first 10% of time)
                    progressRatio = progressRatio * 0.5;
                } else if (progressRatio > 0.8) {
                    // Slow finish (80-100% in last 20% of time)
                    progressRatio = 0.8 + (progressRatio - 0.8) * 0.3;
                } else {
                    // Faster middle section
                    progressRatio = 0.05 + (progressRatio - 0.1) * 1.2;
                }
                
                currentSimulatedProgress = Math.min(95, progressRatio * 100); // Cap at 95% until real completion
                
                updateProgressDisplay(currentSimulatedProgress);
            }, 100);
        }

        function stopProgressSimulation() {
            if (progressSimulationInterval) {
                clearInterval(progressSimulationInterval);
                progressSimulationInterval = null;
            }
        }

        function updateProgressDisplay(percentage) {
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const processingStatus = document.getElementById('processingStatus');
            
            if (progressBarFill) {
                progressBarFill.style.width = percentage + '%';
            }
            if (progressText) {
                progressText.textContent = Math.round(percentage) + '% Complete';
            }
        }

        function updateProgress(message, numericStage) {
            currentProgressNumericStage = numericStage;
            const processingStatus = document.getElementById('processingStatus');
            
            if (processingStatus) {
                processingStatus.textContent = message;
            }

            // Update navigation processing states
            document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
            
            let currentProcessingItemName = null;
            if (numericStage >= STAGE_PERSONA_INSIGHT_COLLECTION_START && numericStage < STAGE_SEARCH_ASSISTANT_START) {
                const personaIndex = numericStage - STAGE_PERSONA_INSIGHT_COLLECTION_START;
                currentProcessingItemName = allProcessedItemNames.find(name => 
                    globalReportData && globalReportData.expert_insights && 
                    globalReportData.expert_insights[personaIndex] && 
                    name === globalReportData.expert_insights[personaIndex].persona_name
                );
            } else if (numericStage === STAGE_SEARCH_ASSISTANT_START && globalReportData && globalReportData.search_findings) {
                currentProcessingItemName = globalReportData.search_findings.persona_name;
            } else if (numericStage === STAGE_SYNTHESIS_START) {
                currentProcessingItemName = "Synthesis Report";
            }

            if (currentProcessingItemName) {
                const navItemId = `nav-${currentProcessingItemName.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                const activeNavItem = document.getElementById(navItemId);
                if (activeNavItem) {
                    activeNavItem.classList.add('processing-nav-item');
                    if (processingStatus) {
                        processingStatus.textContent = `Processing: ${currentProcessingItemName}...`;
                    }
                    activeNavItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        // Animated Persona Generation Functions
        function showPersonaGeneration() {
            const personaSection = document.getElementById('personaGenerationSection');
            if (personaSection) {
                personaSection.style.display = 'block';
            }
        }

        function hidePersonaGeneration() {
            const personaSection = document.getElementById('personaGenerationSection');
            if (personaSection) {
                personaSection.style.display = 'none';
            }
        }

        function addPersonaToAnimation(persona, index) {
            const personaList = document.getElementById('personaList');
            if (!personaList) return;

            const personaItem = document.createElement('div');
            personaItem.className = 'persona-item generating';
            personaItem.id = `persona-${index}`;
            
            const icon = getPersonaIcon(persona.name || persona.role || 'Expert');
            const name = persona.name || `Expert ${index + 1}`;
            const role = persona.role || persona.expertise || 'Business Expert';
            
            personaItem.innerHTML = `
                <div class="persona-icon">${icon}</div>
                <div class="persona-info">
                    <div class="persona-name">${name}</div>
                    <div class="persona-role">${role}</div>
                </div>
                <div class="persona-status generating">Initializing...</div>
            `;
            
            personaList.appendChild(personaItem);
            
            // Animate the persona item
            setTimeout(() => {
                personaItem.style.animationDelay = `${index * 0.2}s`;
            }, 100);
        }

        function updatePersonaStatus(index, status) {
            const personaItem = document.getElementById(`persona-${index}`);
            if (!personaItem) return;

            const statusElement = personaItem.querySelector('.persona-status');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = `persona-status ${status === 'Complete' ? 'complete' : 'generating'}`;
            }

            if (status === 'Complete') {
                personaItem.classList.remove('generating');
                personaItem.classList.add('complete');
            }
        }

        function getPersonaIcon(personaName) {
            const name = personaName.toLowerCase();
            if (name.includes('marketing') || name.includes('brand')) return 'ðŸ“¢';
            if (name.includes('financial') || name.includes('finance') || name.includes('accounting')) return 'ðŸ’°';
            if (name.includes('technology') || name.includes('tech') || name.includes('digital')) return 'ðŸ’»';
            if (name.includes('strategy') || name.includes('strategic')) return 'ðŸŽ¯';
            if (name.includes('customer') || name.includes('user') || name.includes('client')) return 'ðŸ‘¥';
            if (name.includes('operations') || name.includes('operational')) return 'âš™ï¸';
            if (name.includes('legal') || name.includes('compliance')) return 'âš–ï¸';
            if (name.includes('risk') || name.includes('security')) return 'ðŸ›¡ï¸';
            if (name.includes('innovation') || name.includes('research')) return 'ðŸ”¬';
            if (name.includes('sales') || name.includes('revenue')) return 'ðŸ“ˆ';
            if (name.includes('human') || name.includes('hr') || name.includes('talent')) return 'ðŸ‘¨â€ðŸ’¼';
            if (name.includes('supply') || name.includes('logistics')) return 'ðŸ“¦';
            if (name.includes('product') || name.includes('development')) return 'ðŸš€';
            if (name.includes('data') || name.includes('analytics')) return 'ðŸ“Š';
            return 'ðŸ§ ';
        }

        async function animatePersonaGeneration(personas) {
            showPersonaGeneration();
            
            // Clear existing personas
            const personaList = document.getElementById('personaList');
            if (personaList) {
                personaList.innerHTML = '';
            }
            
            // Add each persona with animation
            for (let i = 0; i < personas.length; i++) {
                addPersonaToAnimation(personas[i], i);
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 200));
            }
            
            // Keep personas visible and update their status as the process continues
            // Don't hide the persona generation section - let it stay visible
        }

        // Cost calculation functions
        function calculateCost(inputTokens, outputTokens, model) {
            const pricing = VENICE_PRICING[model] || VENICE_PRICING['llama-3.1-405b'];
            const inputCost = (inputTokens / 1000000) * pricing.input;
            const outputCost = (outputTokens / 1000000) * pricing.output;
            return inputCost + outputCost;
        }

        function updateCostData(component, inputTokens, outputTokens, model) {
            const cost = calculateCost(inputTokens, outputTokens, model);
            costData[component] = {
                inputTokens: inputTokens,
                outputTokens: outputTokens,
                cost: cost
            };
            
            // Update totals
            costData.total.inputTokens += inputTokens;
            costData.total.outputTokens += outputTokens;
            costData.total.cost += cost;
        }

        function displayCostDashboard() {
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            
            // Add navigation item for cost dashboard
            const costNavItem = document.createElement('li');
            costNavItem.innerHTML = `
                <a href="#" onclick="switchContent('cost-dashboard-content')" id="nav-cost-dashboard">
                    ðŸ’° Cost Analysis
                </a>
            `;
            navigationList.appendChild(costNavItem);
            
            // Calculate process time in minutes
            const processTimeSeconds = processEndTime ? ((processEndTime - processStartTime) / 1000) : 0;
            const processTimeMinutes = (processTimeSeconds / 60).toFixed(1);
            const processTime = processTimeSeconds > 0 ? `${processTimeMinutes} min` : 'N/A';
            
            // Create cost dashboard content
            const costDashboardHTML = `
                <div class="content-section" id="cost-dashboard-content">
                    <div class="card-header">
                        <h2>
                            <span class="header-icon">ðŸ’°</span> 
                            Cost Analysis Dashboard
                            <span class="expert-badge">Query Summary</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <div class="cost-summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div class="cost-card" style="background: var(--bg-color); border: 2px solid var(--border-color); padding: 20px;">
                                <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 1.2em;">â±ï¸ Process Time</h3>
                                <div style="font-size: 2em; font-weight: 700; color: var(--accent-green);">${processTime}s</div>
                                <div style="color: var(--light-text-color); font-size: 0.9em;">Total processing time</div>
                            </div>
                            
                            <div class="cost-card" style="background: var(--bg-color); border: 2px solid var(--border-color); padding: 20px;">
                                <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 1.2em;">ðŸ’³ Total Cost</h3>
                                <div style="font-size: 2em; font-weight: 700; color: var(--accent-orange);">$${costData.total.cost.toFixed(4)}</div>
                                <div style="color: var(--light-text-color); font-size: 0.9em;">Total query cost</div>
                            </div>
                            
                            <div class="cost-card" style="background: var(--bg-color); border: 2px solid var(--border-color); padding: 20px;">
                                <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 1.2em;">ðŸ”¢ Total Tokens</h3>
                                <div style="font-size: 2em; font-weight: 700; color: var(--accent-purple);">${(costData.total.inputTokens + costData.total.outputTokens).toLocaleString()}</div>
                                <div style="color: var(--light-text-color); font-size: 0.9em;">Input + Output tokens</div>
                            </div>
                        </div>
                        
                        <div class="cost-breakdown" style="background: var(--bg-color); border: 2px solid var(--border-color); padding: 20px;">
                            <h3 style="margin: 0 0 20px 0; color: var(--text-color); font-size: 1.3em;">ðŸ“Š Cost Breakdown by Component</h3>
                            <div style="background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); padding: 10px; border-radius: 4px; margin-bottom: 20px;">
                                <p style="margin: 0; font-size: 0.9em; color: var(--text-color);">
                                    <strong>âœ… Real Data:</strong> Token usage and costs shown are actual data from Venice AI API responses. 
                                    This reflects the real computational resources used for your analysis.
                                </p>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="component-cost">
                                    <h4 style="margin: 0 0 10px 0; color: var(--text-color);">ðŸŽ¯ Orchestrator (Llama 405B)</h4>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-orange);">$${costData.orchestrator.cost.toFixed(4)}</div>
                                    <div style="color: var(--light-text-color); font-size: 0.9em;">
                                        ${costData.orchestrator.inputTokens.toLocaleString()} input + ${costData.orchestrator.outputTokens.toLocaleString()} output tokens
                                    </div>
                                </div>
                                
                                <div class="component-cost">
                                    <h4 style="margin: 0 0 10px 0; color: var(--text-color);">ðŸ‘¥ Personas (Qwen 235B)</h4>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-orange);">$${costData.personas.cost.toFixed(4)}</div>
                                    <div style="color: var(--light-text-color); font-size: 0.9em;">
                                        ${costData.personas.inputTokens.toLocaleString()} input + ${costData.personas.outputTokens.toLocaleString()} output tokens
                                    </div>
                                </div>
                                
                                <div class="component-cost">
                                    <h4 style="margin: 0 0 10px 0; color: var(--text-color);">ðŸ” Search Reports (Llama 405B)</h4>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-orange);">$${costData.searchReports.cost.toFixed(4)}</div>
                                    <div style="color: var(--light-text-color); font-size: 0.9em;">
                                        ${costData.searchReports.inputTokens.toLocaleString()} input + ${costData.searchReports.outputTokens.toLocaleString()} output tokens
                                    </div>
                                </div>
                                
                                <div class="component-cost">
                                    <h4 style="margin: 0 0 10px 0; color: var(--text-color);">ðŸ“‹ Synthesis (Qwen 235B)</h4>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--accent-orange);">$${costData.synthesis.cost.toFixed(4)}</div>
                                    <div style="color: var(--light-text-color); font-size: 0.9em;">
                                        ${costData.synthesis.inputTokens.toLocaleString()} input + ${costData.synthesis.outputTokens.toLocaleString()} output tokens
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cost-comparison" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-purple) 100%); color: white; border-radius: 0;">
                            <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">ðŸ’¡ Cost Comparison</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: 700;">$${costData.total.cost.toFixed(4)}</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">AI Partner Cost</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: 700;">$50,000+</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Traditional Consulting</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: 700;">99.99%</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Cost Savings</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsContentDiv.innerHTML += costDashboardHTML;
        }

        // Example problems for quick testing
        function setExampleProblem(exampleType) {
            const businessProblemTextarea = document.getElementById('businessProblem');
            let exampleText = '';
            
            switch(exampleType) {
                case 'startup-marketing':
                    exampleText = "Our tech startup has developed an innovative AI-powered project management tool, but we're struggling to gain market traction. Despite having a solid product, our customer acquisition costs are high, conversion rates are low, and we're burning through our seed funding. We need a comprehensive marketing strategy to scale our user base and achieve product-market fit before our next funding round in 6 months.";
                    break;
                case 'digital-transformation':
                    exampleText = "Our traditional manufacturing company needs to undergo digital transformation to remain competitive. We're facing pressure from digitally-native competitors, our processes are outdated, and our workforce lacks digital skills. We need to modernize our operations, implement new technologies, and change our company culture while maintaining productivity and managing costs.";
                    break;
                case 'supply-chain':
                    exampleText = "Our e-commerce business is experiencing major supply chain disruptions leading to stockouts, delayed deliveries, and rising costs. Customer satisfaction is declining, and we're losing market share to competitors with more reliable fulfillment. We need to optimize our supply chain, diversify suppliers, and implement better inventory management while controlling costs.";
                    break;
                case 'customer-retention':
                    exampleText = "Our SaaS platform is experiencing a customer churn crisis with monthly churn rates reaching 8%. New customer acquisition is expensive, and our customer lifetime value is declining. We need to understand why customers are leaving, improve retention strategies, and increase customer satisfaction to achieve sustainable growth.";
                    break;
                case 'ai-implementation':
                    exampleText = "Our mid-size consulting firm wants to integrate AI into our service offerings to improve efficiency and stay competitive. However, we lack AI expertise, our staff is resistant to change, and we're unsure which AI tools would provide the best ROI. We need a strategic plan to implement AI across our operations while managing change and training our team.";
                    break;
                default:
                    exampleText = "Describe your business challenge here...";
            }
            
            businessProblemTextarea.value = exampleText;
            
            // Add visual feedback
            businessProblemTextarea.style.backgroundColor = '#f0f9ff';
            setTimeout(() => {
                businessProblemTextarea.style.backgroundColor = '';
            }, 1000);
        }

        // Mobile-friendly request handling
        let currentRequestController = null;
        let isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let isPageVisible = true;
        
        // Handle page visibility changes (when user switches apps on mobile)
        document.addEventListener('visibilitychange', function() {
            isPageVisible = !document.hidden;
            
            if (!isPageVisible && currentRequestController && isMobileDevice) {
                console.log('Page hidden - this may cause connection issues on mobile');
                // Don't abort immediately, but warn the user
                const mobileWarning = document.getElementById('mobileWarning');
                if (mobileWarning) {
                    mobileWarning.style.background = 'rgba(255, 0, 0, 0.1)';
                    mobileWarning.style.borderColor = 'rgba(255, 0, 0, 0.3)';
                    mobileWarning.querySelector('p').innerHTML = 'âš ï¸ <strong>Warning:</strong> You switched away from the app. This may cause connection issues. Return to the app immediately.';
                }
            } else if (isPageVisible && mobileWarning) {
                // Reset warning when user returns
                mobileWarning.style.background = 'rgba(255, 193, 7, 0.1)';
                mobileWarning.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                mobileWarning.querySelector('p').innerHTML = 'ðŸ“± <strong>Mobile Users:</strong> Keep this app active and don\'t switch to other apps during processing to avoid connection issues.';
            }
        });
        
        async function submitProblem() {
            const problemText = document.getElementById('businessProblem').value;
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            const submitButton = document.getElementById('submitButton');
            const downloadButton = document.getElementById('downloadPdfButton');

            globalReportData = null;
            allProcessedItemNames = []; 
            
            // Reset cost tracking
            processStartTime = Date.now();
            costData = {
                orchestrator: { inputTokens: 0, outputTokens: 0, cost: 0 },
                personas: { inputTokens: 0, outputTokens: 0, cost: 0 },
                searchReports: { inputTokens: 0, outputTokens: 0, cost: 0 },
                synthesis: { inputTokens: 0, outputTokens: 0, cost: 0 },
                total: { inputTokens: 0, outputTokens: 0, cost: 0 }
            };
            
            if (!problemText.trim()) {
                resultsContentDiv.innerHTML = '<div class="error content-section active">Please enter a business problem.</div>';
                return;
            }

            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 
            submitButton.disabled = true;
            downloadButton.style.display = 'none';
            showProcessingNotification();
            startRealisticProgressSimulation();
            updateProgress('Initializing AI Partners...', STAGE_IDLE);

            try {
                // First test backend connectivity
                console.log('Testing backend connectivity...');
                const healthResponse = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!healthResponse.ok) {
                    throw new Error(`Backend health check failed: ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                console.log('Backend health check passed:', healthData);

                await new Promise(resolve => setTimeout(resolve, 300));
                updateProgress('Generating Expert Personas...', STAGE_PERSONA_GENERATION_START);
                
                // Start persona generation animation
                const mockPersonas = [
                    { name: "AI Marketing Partner", role: "Digital Marketing Expert" },
                    { name: "AI Financial Partner", role: "Investment & Risk Specialist" },
                    { name: "AI Technology Partner", role: "Digital Transformation Expert" },
                    { name: "AI Operations Partner", role: "Process Optimization Specialist" },
                    { name: "AI Customer Partner", role: "User Experience Expert" },
                    { name: "AI Strategy Partner", role: "Business Strategy Consultant" },
                    { name: "AI Data Partner", role: "Analytics & Insights Expert" },
                    { name: "AI Legal Partner", role: "Compliance & Risk Specialist" },
                    { name: "AI Innovation Partner", role: "Product Development Expert" },
                    { name: "AI Sales Partner", role: "Revenue Growth Specialist" },
                    { name: "AI HR Partner", role: "Talent & Culture Expert" },
                    { name: "AI Supply Chain Partner", role: "Logistics & Operations" },
                    { name: "AI Product Partner", role: "Product Strategy Expert" },
                    { name: "AI Market Research Partner", role: "Industry Analysis Expert" },
                    { name: "AI Performance Partner", role: "Business Optimization" }
                ];
                
                // Start the persona animation
                animatePersonaGeneration(mockPersonas);
                
                // Cancel any existing request
                if (currentRequestController) {
                    currentRequestController.abort();
                }
                
                // Create new AbortController for this request
                currentRequestController = new AbortController();
                
                // Mobile-friendly timeout (longer for mobile devices)
                const timeoutDuration = isMobileDevice ? 900000 : 600000; // 15 min for mobile, 10 min for desktop
                const timeoutId = setTimeout(() => {
                    if (currentRequestController) {
                        currentRequestController.abort();
                    }
                }, timeoutDuration);
                
                const response = await fetch(`${BACKEND_URL}/process_problem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ business_problem: problemText }),
                    signal: currentRequestController.signal
                });
                
                // Clear timeout if request completes successfully
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "Failed to parse error from server." }));
                    throw new Error(`HTTP error! Status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                
                const data = await response.json();
                globalReportData = data;

                updateProgress('Main processing complete. Visualizing insights...', STAGE_BACKEND_PROCESSING_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                // Prepare names for navigation highlighting
                if (data.expert_insights) {
                    allProcessedItemNames = [...allProcessedItemNames, ...data.expert_insights.map(p => p.persona_name)];
                }
                
                if (data.market_intelligence) {
                    allProcessedItemNames = [...allProcessedItemNames, ...data.market_intelligence.map(intel => intel.title || 'Market Analysis')];
                }
                if (data.search_findings && data.search_findings.persona_name) {
                    allProcessedItemNames.push(data.search_findings.persona_name);
                }
                if (data.synthesis_report) {
                    allProcessedItemNames.push("Synthesis Report");
                }
                
                updateProgress(`AI Partners analyzing your problem...`, STAGE_PERSONA_GENERATION_COMPLETE);
                await new Promise(resolve => setTimeout(resolve, 300));

                // Update persona statuses to show they're working
                if (data.expert_insights) {
                    for (let i = 0; i < Math.min(data.expert_insights.length, 15); i++) {
                        updatePersonaStatus(i, 'Analyzing your challenge...');
                        await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 300));
                    }
                }
                
                // Show market intelligence gathering
                updateProgress('Gathering market intelligence...', STAGE_SEARCH_ASSISTANT_START);
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Update some personas to show market research
                for (let i = 10; i < 15; i++) {
                    updatePersonaStatus(i, 'Researching market trends...');
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                updateProgress('Synthesizing strategic insights...', STAGE_SYNTHESIS_START);
                await new Promise(resolve => setTimeout(resolve, 800)); 
                
                // Update all personas to complete
                for (let i = 0; i < 15; i++) {
                    updatePersonaStatus(i, 'Complete');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                updateProgress('Finalizing your strategic report...', STAGE_DISPLAY_RESULTS);
                displayResults(data);

                // Record end time and display cost dashboard
                processEndTime = Date.now();
                
                // Use real token data from API response if available
                if (data.token_usage) {
                    const usage = data.token_usage;
                    
                    // Orchestrator (persona generation)
                    if (usage.orchestrator) {
                        updateCostData('orchestrator', 
                            usage.orchestrator.input_tokens || 0, 
                            usage.orchestrator.output_tokens || 0, 
                            usage.orchestrator.model || 'llama-3.1-405b'
                        );
                    }
                    
                    // Personas (expert insights)
                    if (usage.personas) {
                        updateCostData('personas', 
                            usage.personas.input_tokens || 0, 
                            usage.personas.output_tokens || 0, 
                            usage.personas.model || 'qwen3-235b'
                        );
                    }
                    
                    // Search Reports (market intelligence)
                    if (usage.search_reports) {
                        updateCostData('searchReports', 
                            usage.search_reports.input_tokens || 0, 
                            usage.search_reports.output_tokens || 0, 
                            usage.search_reports.model || 'llama-3.1-405b'
                        );
                    }
                    
                    // Synthesis (final report)
                    if (usage.synthesis) {
                        updateCostData('synthesis', 
                            usage.synthesis.input_tokens || 0, 
                            usage.synthesis.output_tokens || 0, 
                            usage.synthesis.model || 'qwen3-235b'
                        );
                    }
                } else {
                    // Fallback to simulated data if no real data available
                    updateCostData('orchestrator', 3000, 2000, 'llama-3.1-405b');
                    updateCostData('personas', 15000, 25000, 'qwen3-235b');
                    updateCostData('searchReports', 5000, 8000, 'llama-3.1-405b');
                    updateCostData('synthesis', 4000, 6000, 'qwen3-235b');
                }
                
                displayCostDashboard();

                // Complete the progress simulation
                stopProgressSimulation();
                updateProgressDisplay(100);
                updateProgress("Strategic analysis complete!", STAGE_ALL_COMPLETE);

                if (data.synthesis_report || data.expert_insights || data.market_intelligence) {
                    downloadButton.style.display = 'inline-block';
                }

            } catch (error) {
                console.error('Error submitting problem:', error);
                hideProcessingNotification();
                stopProgressSimulation();
                
                let errorMessage = 'An error occurred while processing your request.';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request was cancelled or timed out. This can happen on mobile devices when the app goes to background. Please try again and keep the app active.';
                } else if (error.message.includes('Failed to fetch')) {
                    if (isMobileDevice) {
                        errorMessage = 'Connection lost. This is common on mobile devices. Please check your internet connection and try again. Keep the app active during processing.';
                    } else {
                        errorMessage = 'Failed to connect to the server. Please ensure the backend server is running and responding correctly.';
                    }
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = `Server error: ${error.message}`;
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                }
                
                resultsContentDiv.innerHTML = `
                    <div class="error content-section active" id="global-error-content">
                        <h3>âš ï¸ Processing Error</h3>
                        <p><strong>Error:</strong> ${errorMessage}</p>
                        ${isMobileDevice ? `
                            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); padding: 15px; border-radius: 4px; margin-top: 15px;">
                                <h4>ðŸ“± Mobile Tips:</h4>
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    <li>Keep the app active and don't switch to other apps</li>
                                    <li>Ensure your device doesn't go to sleep</li>
                                    <li>Use a stable WiFi connection if possible</li>
                                    <li>Try again if the connection is interrupted</li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                switchContent('global-error-content');
                updateProgress('Error occurred.', STAGE_ALL_COMPLETE);
            } finally {
                submitButton.disabled = false;
                hideProcessingNotification();
                
                setTimeout(() => {
                    document.querySelectorAll('#navigationList li a.processing-nav-item').forEach(nav => nav.classList.remove('processing-nav-item'));
                }, 300);
            }
        }

        function switchContent(targetId) {
            document.querySelectorAll('#results-content .content-section.active').forEach(section => {
                section.classList.remove('active');
            });
            
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                setTimeout(() => { 
                    targetElement.classList.add('active'); 
                }, 10); 
            } else {
                const firstSection = document.querySelector('#results-content .content-section');
                if (firstSection) {
                    setTimeout(() => { firstSection.classList.add('active'); }, 10);
                    activeContentId = firstSection.id;
                } else {
                    document.getElementById('results-content').innerHTML = '<div class="content-section active"><p>Content not found.</p></div>';
                }
            }

            document.querySelectorAll('#navigationList li a').forEach(navLink => {
                navLink.classList.remove('active');
                if(navLink.id === `nav-${targetId.replace('-content','').replace(/[^a-zA-Z0-9_]/g, '-')}` ){
                    navLink.classList.add('active');
                }
            });
            activeContentId = targetId;
        }

        function displayResults(data) {
            const resultsContentDiv = document.getElementById('results-content');
            const navigationList = document.getElementById('navigationList');
            resultsContentDiv.innerHTML = ''; 
            navigationList.innerHTML = ''; 

            let firstItemIdToDisplay = null;
            const navOrder = [];

            // 1. Synthesis Report with modern card design
            if (data.synthesis_report) {
                const itemName = "Synthesis Report";
                const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                const contentId = `${safeName}-content`;
                navOrder.push({name: itemName, id: contentId, type: 'report'});

                if (data.synthesis_report.error) {
                     resultsContentDiv.innerHTML += `
                        <div class="content-section error" id="${contentId}">
                            <div class="card-header">
                                <h2><span class="header-icon">âš ï¸</span> Synthesis Report Error</h2>
                            </div>
                            <div class="card-content">
                                <p>${data.synthesis_report.error}</p>
                            </div>
                        </div>`;
                } else {
                    const synthesis = data.synthesis_report;
                    
                    let actionsHTML = '';
                    if (synthesis.actionable_next_steps && synthesis.actionable_next_steps.length > 0) {
                        synthesis.actionable_next_steps.forEach((action, index) => {
                            actionsHTML += `
                                <div class="action-step">
                                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                                        <span class="step-number">${index + 1}</span>
                                        <div style="flex: 1;">
                                            <p style="margin: 0 0 8px 0; font-weight: 600; font-size: 1.1em;">${action.step_description}</p>
                                            <p style="margin: 0 0 8px 0;">
                                                <strong>Priority:</strong> 
                                                <span class="priority-badge priority-${action.priority || 'Medium'}">${action.priority || 'Medium'}</span>
                                            </p>
                                            ${action.suggested_rationale ? `<p style="margin: 0; font-style: italic; color: var(--light-text-color);">${action.suggested_rationale}</p>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        });
                    } else { 
                        actionsHTML = '<p>No specific actionable steps provided.</p>'; 
                    }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <div class="card-header">
                                <h2>
                                    <span class="header-icon">ðŸ“Š</span> 
                                    ${itemName}
                                    <span class="expert-badge">Executive Summary</span>
                                </h2>
                            </div>
                            <div class="card-content">
                                <div class="expert-info" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent-orange) 10%, transparent) 0%, transparent 100%); border-color: var(--accent-orange);">
                                    <div class="expert-role">Original Problem</div>
                                    <div style="font-size: 1.05em; line-height: 1.6;">${data.original_problem || 'N/A'}</div>
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸ’¡</span>
                                    <h3>Executive Summary</h3>
                                </div>
                                <p style="font-size: 1.1em; line-height: 1.7; margin-bottom: 25px;">${synthesis.cohesive_summary || 'Not available.'}</p>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸŽ¯</span>
                                    <h3>Key Themes</h3>
                                </div>
                                <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                                    ${(synthesis.key_themes || []).map(theme => `
                                        <div style="background: linear-gradient(135deg, var(--light-green-bg) 0%, white 100%); 
                                                    padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--secondary-color);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <span style="font-weight: 500;">${theme}</span>
                                        </div>
                                    `).join('') || '<p>Not available.</p>'}
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸ‘ï¸</span>
                                    <h3>Potential Blind Spots</h3>
                                </div>
                                <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                                    ${(synthesis.potential_blind_spots || []).map(spot => `
                                        <div style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent-coral) 10%, transparent) 0%, white 100%); 
                                                    padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--accent-coral);
                                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <span style="font-weight: 500;">${spot}</span>
                                        </div>
                                    `).join('') || '<p>Not available.</p>'}
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸš€</span>
                                    <h3>Actionable Next Steps</h3>
                                </div>
                                ${actionsHTML}
                            </div>
                        </div>`;
                }
            }
            
            // 2. Expert Personas with enhanced design
            if (data.expert_insights && data.expert_insights.length > 0) {
                data.expert_insights.forEach(personaPackage => {
                    const itemName = personaPackage.persona_name || 'Unnamed Persona';
                    const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                    const contentId = `persona-${safeName}-content`;
                    navOrder.push({name: itemName, id: contentId, type: 'persona'});
                    
                    let personaDefinitionHTML = '';
                    if(data.persona_definitions) {
                        const definition = data.persona_definitions.find(p => p.name === itemName);
                        if(definition) {
                            personaDefinitionHTML = `
                                <div class="expert-info">
                                    <div class="expert-role">${definition.description || 'N/A'}</div>
                                    <div class="expert-focus"><strong>Focus Areas:</strong> ${(definition.focus_areas || []).join(', ') || 'N/A'}</div>
                                </div>`;
                        }
                    }

                    let insightsContentHTML = '';
                    if (personaPackage.error) {
                         insightsContentHTML += `
                            <div style="background: linear-gradient(135deg, #ffebee 0%, white 100%); 
                                        padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-coral);
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <strong style="color: var(--accent-coral);">Error:</strong> ${personaPackage.error}
                            </div>`;
                    } else {
                        if (personaPackage.insights_and_analysis && personaPackage.insights_and_analysis.length > 0) {
                            personaPackage.insights_and_analysis.forEach((item, index) => {
                                insightsContentHTML += `
                                    <div class="insight-block">
                                        <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                                            <div style="background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-coral) 100%);
                                                        color: white; width: 32px; height: 32px; border-radius: 50%;
                                                        display: flex; align-items: center; justify-content: center;
                                                        font-weight: 700; font-size: 0.9em; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                                ${index + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <h4 style="margin: 0 0 10px 0; color: var(--primary-color); font-size: 1.1em;">
                                                    ${item.insight}
                                                </h4>
                                                <p style="margin: 0 0 10px 0; line-height: 1.6;">
                                                    <strong style="color: var(--primary-darker);">Reasoning:</strong> 
                                                    ${item.supporting_reasoning || 'N/A'}
                                                </p>
                                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                                    <span style="background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-yellow) 100%);
                                                                 color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                                        Confidence: ${item.confidence_level || 'N/A'}
                                                    </span>
                                                </div>
                                                ${item.identified_risks && item.identified_risks.length > 0 ? `
                                                    <div style="margin: 10px 0;">
                                                        <strong style="color: var(--accent-coral);">âš ï¸ Risks:</strong> 
                                                        <span style="color: var(--accent-coral);">${item.identified_risks.join(', ')}</span>
                                                    </div>` : ''}
                                                ${item.identified_opportunities && item.identified_opportunities.length > 0 ? `
                                                    <div style="margin: 10px 0;">
                                                        <strong style="color: var(--secondary-color);">ðŸŒŸ Opportunities:</strong> 
                                                        <span style="color: var(--secondary-color);">${item.identified_opportunities.join(', ')}</span>
                                                    </div>` : ''}
                                                ${item.implementation_ideas && item.implementation_ideas.length > 0 ? `
                                                    <div style="margin: 15px 0;">
                                                        <strong style="color: var(--accent-green);">ðŸ’¡ Implementation Ideas:</strong>
                                                        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                                            ${item.implementation_ideas.map(idea => `
                                                                <li style="margin-bottom: 5px; line-height: 1.5; color: var(--primary-darker);">
                                                                    ${idea}
                                                                </li>
                                                            `).join('')}
                                                        </ul>
                                                    </div>` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            });
                        } else {
                            insightsContentHTML += '<p>No specific insights provided by this expert.</p>';
                        }
                    }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <div class="card-header">
                                <h2>
                                    <span class="header-icon">${getNavIcon(itemName)}</span> 
                                    ${itemName}
                                    <span class="expert-badge">Expert Analysis</span>
                                </h2>
                            </div>
                            <div class="card-content">
                                ${personaDefinitionHTML}
                                <div class="section-header">
                                    <span class="section-icon">ðŸ”</span>
                                    <h3>Analysis & Insights</h3>
                                </div>
                                ${insightsContentHTML}
                            </div>
                        </div>`;
                });
            }
            
            // 3. Market Intelligence Section
            if (data.market_intelligence && data.market_intelligence.length > 0) {
                data.market_intelligence.forEach(intel => {
                    const itemName = intel.title || 'Market Analysis';
                    const safeName = itemName.replace(/[^a-zA-Z0-9_]/g, '-');
                    const contentId = `market-${safeName}-content`;
                    navOrder.push({name: itemName, id: contentId, type: 'market'});
                    
                    let insightsHTML = '';
                    if (intel.key_insights && intel.key_insights.length > 0) {
                        insightsHTML = intel.key_insights.map(insight => `
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, white 100%); 
                                        padding: 15px 20px; border-radius: 8px; border-left: 4px solid var(--secondary-color);
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px;">
                                <span style="font-weight: 500;">â€¢ ${insight}</span>
                            </div>
                        `).join('');
                    } else {
                        insightsHTML = '<p>No specific insights extracted.</p>';
                    }
                    
                    resultsContentDiv.innerHTML += `
                        <div class="content-section" id="${contentId}">
                            <div class="card-header">
                                <h2>
                                    <span class="header-icon">ðŸ”</span> 
                                    ${itemName}
                                                                         <span class="expert-badge market-intel-badge">Market Intelligence</span>
                                </h2>
                            </div>
                            <div class="card-content">
                                <div class="expert-info" style="background: linear-gradient(135deg, color-mix(in srgb, var(--secondary-color) 10%, transparent) 0%, transparent 100%); border-color: var(--secondary-color);">
                                    <div class="expert-role">Real-time Market Analysis</div>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                        <span style="font-size: 0.9em;">Confidence Level:</span>
                                        <span style="background: ${intel.confidence_level === 'High' ? '#10b981' : intel.confidence_level === 'Medium' ? '#f59e0b' : '#ef4444'}; 
                                                     color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                            ${intel.confidence_level || 'Medium'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸŽ¯</span>
                                    <h3>Key Insights</h3>
                                </div>
                                ${insightsHTML}
                                
                                <div class="section-header">
                                    <span class="section-icon">ðŸ“Š</span>
                                    <h3>Detailed Analysis</h3>
                                </div>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto;">
                                    <p style="line-height: 1.7; margin: 0; white-space: pre-wrap;">${intel.content || 'No detailed content available.'}</p>
                                </div>
                            </div>
                        </div>`;
                });
            }
            
            // Populate Navigation List with enhanced styling
            navOrder.forEach(item => {
                 const navItemId = `nav-${item.name.replace(/[^a-zA-Z0-9_]/g, '-')}`;
                 navigationList.innerHTML += `
                    <li>
                        <a href="#" id="${navItemId}" onclick="switchContent('${item.id}'); return false;">
                            <span class="nav-icon">${getNavIcon(item.name)}</span> 
                            ${item.name}
                        </a>
                    </li>`;
                 if (!firstItemIdToDisplay) firstItemIdToDisplay = item.id;
            });

            if (!firstItemIdToDisplay && data.error) { 
                 const errorContentId = 'global-error-content-final';
                 resultsContentDiv.innerHTML += `
                    <div class="content-section error active" id="${errorContentId}">
                        <div class="card-header">
                            <h2><span class="header-icon">âš ï¸</span> System Error</h2>
                        </div>
                        <div class="card-content">
                            <strong>Backend Error:</strong> ${data.error} 
                            ${data.details ? '<br><strong>Details:</strong> '+JSON.stringify(data.details) : ''}
                        </div>
                    </div>`;
                 firstItemIdToDisplay = errorContentId;
            } else if (!firstItemIdToDisplay) {
                 const noResultsId = 'no-results-content-final';
                 resultsContentDiv.innerHTML += `
                    <div class="content-section active" id="${noResultsId}">
                        <div class="card-header">
                            <h2><span class="header-icon">ðŸ“</span> No Results</h2>
                        </div>
                        <div class="card-content">
                            <p>No results to display. Please submit a problem to begin analysis.</p>
                        </div>
                    </div>`;
                 firstItemIdToDisplay = noResultsId;
            }

            if (firstItemIdToDisplay) {
                switchContent(firstItemIdToDisplay);
            }
            // Reveal HTML download if we have any content
            const htmlBtn = document.getElementById('downloadHtmlButton');
            if (data.synthesis_report || (data.expert_insights && data.expert_insights.length) || (data.market_intelligence && data.market_intelligence.length)) {
                htmlBtn.style.display = 'inline-block';
            } else {
                htmlBtn.style.display = 'none';
            }
        }

        function downloadPDF() {
            if (!globalReportData) {
                alert("No report data available to download.");
                return;
            }

            const data = globalReportData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

            let yPosition = 50;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const leftMargin = 60;
            const rightMargin = 50;
            const usableWidth = pageWidth - leftMargin - rightMargin;
            
            function addFormattedText(text, x, y, options = {}) {
                const { 
                    fontSize = 11, 
                    fontStyle = 'normal', 
                    color = '#333333', 
                    maxWidth = usableWidth, 
                    lineHeightFactor = 1.8, 
                    isTitle = false,
                    indent = 0,
                    align = 'left'
                } = options;
                
                doc.setFontSize(fontSize);
                doc.setFont("helvetica", fontStyle);
                doc.setTextColor(color.startsWith('#') ? color.substring(1) : color);

                const effectiveWidth = Math.min(maxWidth - indent, usableWidth - indent);
                const lines = doc.splitTextToSize(text, effectiveWidth);
                let localY = y;
                
                lines.forEach((line, index) => {
                    if (index > 0) {
                        localY += fontSize * lineHeightFactor;
                    }
                    localY = checkAndAddPage(localY, fontSize * lineHeightFactor + 15);
                    
                    let xPos = x + indent;
                    if (align === 'center') {
                        const lineWidth = doc.getTextWidth(line);
                        xPos = (pageWidth - lineWidth) / 2;
                    }
                    
                    doc.text(line, xPos, localY);
                });
                
                return localY + (fontSize * lineHeightFactor * 0.8);
            }

            function checkAndAddPage(currentY, spaceNeeded = 40) {
                if (currentY + spaceNeeded > pageHeight - 100) {
                    doc.addPage();
                    return 80;
                }
                return currentY;
            }

            function addSection(title, content, options = {}) {
                yPosition = checkAndAddPage(yPosition, 80);
                
                // Add section title with background
                const titleHeight = 40;
                doc.setFillColor('#f8fafc');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, titleHeight, 'F');
                doc.setDrawColor('#e5e7eb');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, titleHeight, 'S');
                
                yPosition = addFormattedText(title, leftMargin, yPosition + 20, { 
                    fontSize: 16, 
                    fontStyle: 'bold', 
                    color: '#1e40af', 
                    isTitle: true 
                });
                yPosition += 30;
                
                if (typeof content === 'string') {
                    yPosition = addFormattedText(content, leftMargin, yPosition, { 
                        fontSize: 12, 
                        lineHeightFactor: 1.8,
                        ...options 
                    });
                } else if (Array.isArray(content)) {
                    content.forEach((item, index) => {
                        yPosition = checkAndAddPage(yPosition, 35);
                        yPosition = addFormattedText(`${index + 1}. ${item}`, leftMargin, yPosition, { 
                            fontSize: 11, 
                            indent: 0,
                            lineHeightFactor: 1.8,
                            ...options 
                        });
                        yPosition += 15;
                    });
                }
                yPosition += 35;
                return yPosition;
            }

            // Enhanced Title Page
            doc.setFillColor('#1e40af');
            doc.rect(0, 0, pageWidth, 140, 'F');
            
            yPosition = addFormattedText("AI Expert Panel Report", 0, 80, { 
                fontSize: 32, 
                fontStyle: 'bold', 
                color: '#ffffff',
                align: 'center'
            });
            
            yPosition = addFormattedText("Comprehensive Business Analysis & Strategic Recommendations", 0, yPosition + 25, { 
                fontSize: 14, 
                color: '#e0f2fe',
                align: 'center'
            });
            
            yPosition = 200;
            
            // Date and metadata
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            doc.setFillColor('#f8fafc');
            doc.rect(leftMargin, yPosition, usableWidth, 80, 'F');
            doc.setDrawColor('#e5e7eb');
            doc.rect(leftMargin, yPosition, usableWidth, 80, 'S');
            
            yPosition = addFormattedText(`Report Generated: ${currentDate}`, leftMargin + 20, yPosition + 30, { 
                fontSize: 12, 
                fontStyle: 'bold',
                color: '#374151'
            });
            
            yPosition = addFormattedText(`Analysis Type: Multi-Expert AI Consultation`, leftMargin + 20, yPosition + 10, { 
                fontSize: 11, 
                color: '#6b7280'
            });
            
            yPosition += 80;
            
            // Original Problem with enhanced formatting
            yPosition = checkAndAddPage(yPosition, 120);
            
            const problemText = data.original_problem || 'N/A';
            const problemLines = doc.splitTextToSize(problemText, usableWidth - 40);
            const problemHeight = Math.max(80, problemLines.length * 16 + 60);
            
            doc.setFillColor('#fef3c7');
            doc.rect(leftMargin, yPosition, usableWidth, problemHeight, 'F');
            doc.setDrawColor('#f59e0b');
            doc.setLineWidth(3);
            doc.rect(leftMargin, yPosition, usableWidth, problemHeight, 'S');
            
            yPosition = addFormattedText("BUSINESS PROBLEM STATEMENT", leftMargin + 20, yPosition + 30, { 
                fontSize: 14, 
                fontStyle: 'bold', 
                color: '#92400e'
            });
            
            yPosition = addFormattedText(problemText, leftMargin + 20, yPosition + 15, { 
                fontSize: 12, 
                lineHeightFactor: 1.8, 
                maxWidth: usableWidth - 40,
                color: '#451a03'
            });
            
            yPosition += problemHeight - 30;

            // Synthesis Report with enhanced formatting
            if (data.synthesis_report && !data.synthesis_report.error) {
                const synthesis = data.synthesis_report;
                
                // Executive Summary
                yPosition = addSection("EXECUTIVE SUMMARY", synthesis.cohesive_summary || 'N/A', {
                    fontSize: 12,
                    color: '#374151'
                });
                
                // Key Themes
                yPosition = addSection("KEY STRATEGIC THEMES", synthesis.key_themes || [], {
                    fontSize: 11,
                    color: '#374151'
                });
                
                // Blind Spots
                yPosition = addSection("POTENTIAL BLIND SPOTS & RISKS", synthesis.potential_blind_spots || [], {
                    fontSize: 11,
                    color: '#dc2626'
                });
                
                // Action Steps with enhanced formatting
                yPosition = checkAndAddPage(yPosition, 100);
                
                doc.setFillColor('#f0fdf4');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, 40, 'F');
                doc.setDrawColor('#10b981');
                doc.rect(leftMargin - 10, yPosition - 10, usableWidth + 20, 40, 'S');
                
                yPosition = addFormattedText("ACTIONABLE NEXT STEPS", leftMargin, yPosition + 20, { 
                    fontSize: 16, 
                    fontStyle: 'bold', 
                    color: '#166534'
                });
                yPosition += 40;
                
                (synthesis.actionable_next_steps || []).forEach((action, index) => {
                    yPosition = checkAndAddPage(yPosition, 120);
                    
                    // Step container
                    const stepHeight = 100;
                    doc.setFillColor('#f9fafb');
                    doc.rect(leftMargin, yPosition, usableWidth, stepHeight, 'F');
                    doc.setDrawColor('#d1d5db');
                    doc.rect(leftMargin, yPosition, usableWidth, stepHeight, 'S');
                    
                    // Step number circle
                    doc.setFillColor('#1e40af');
                    doc.circle(leftMargin + 25, yPosition + 30, 15, 'F');
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor('#ffffff');
                    doc.text(`${index + 1}`, leftMargin + 20, yPosition + 36);
                    
                    // Step content
                    yPosition = addFormattedText(`${action.step_description}`, leftMargin + 55, yPosition + 25, { 
                        fontSize: 12, 
                        fontStyle: 'bold',
                        maxWidth: usableWidth - 70,
                        color: '#1f2937',
                        lineHeightFactor: 1.6
                    });
                    
                    // Priority badge
                    const priorityColor = action.priority === 'High' ? '#dc2626' : 
                                        action.priority === 'Medium' ? '#ea580c' : '#059669';
                    yPosition = addFormattedText(`Priority: ${action.priority}`, leftMargin + 55, yPosition + 10, { 
                        fontSize: 10,
                        fontStyle: 'bold',
                        color: priorityColor
                    });
                    
                    // Rationale
                    if (action.suggested_rationale) {
                        yPosition = addFormattedText(`${action.suggested_rationale}`, leftMargin + 55, yPosition + 10, { 
                            fontSize: 10, 
                            maxWidth: usableWidth - 70,
                            lineHeightFactor: 1.6,
                            color: '#6b7280'
                        });
                    }
                    
                    yPosition += stepHeight - 50;
                });
            }

            // Expert Analysis Details
            if (data.expert_insights && data.expert_insights.length > 0) {
                doc.addPage();
                yPosition = 80;
                
                // Section header
                doc.setFillColor('#1e40af');
                doc.rect(0, yPosition - 20, pageWidth, 60, 'F');
                
                yPosition = addFormattedText("DETAILED EXPERT ANALYSIS", 0, yPosition + 20, { 
                    fontSize: 20, 
                    fontStyle: 'bold', 
                    color: '#ffffff',
                    align: 'center'
                });
                
                yPosition += 60;
                
                data.expert_insights.forEach((personaPackage, personaIndex) => {
                    if (personaIndex > 0) {
                        doc.addPage();
                        yPosition = 80;
                    }
                    
                    const expertName = personaPackage.persona_name || 'Unknown Expert';
                    
                    // Expert header with enhanced design
                    doc.setFillColor('#e0f2fe');
                    doc.rect(leftMargin, yPosition, usableWidth, 60, 'F');
                    doc.setDrawColor('#0891b2');
                    doc.setLineWidth(2);
                    doc.rect(leftMargin, yPosition, usableWidth, 60, 'S');
                    
                    yPosition = addFormattedText(`EXPERT: ${expertName.toUpperCase()}`, leftMargin + 20, yPosition + 35, { 
                        fontSize: 16, 
                        fontStyle: 'bold', 
                        color: '#0c4a6e'
                    });
                    
                    yPosition += 45;
                    
                    // Expert description
                    const definition = (data.persona_definitions || []).find(p => p.name === expertName);
                    if (definition) {
                        yPosition = addFormattedText(`Expertise: ${definition.description || 'N/A'}`, leftMargin, yPosition + 15, { 
                            fontSize: 11,
                            maxWidth: usableWidth,
                            color: '#374151',
                            lineHeightFactor: 1.6
                        });
                        
                        if (definition.focus_areas && definition.focus_areas.length > 0) {
                            yPosition = addFormattedText(`Focus Areas: ${definition.focus_areas.join(', ')}`, leftMargin, yPosition + 10, { 
                                fontSize: 10,
                                color: '#6b7280',
                                maxWidth: usableWidth,
                                fontStyle: 'italic',
                                lineHeightFactor: 1.6
                            });
                        }
                        yPosition += 25;
                    }

                    // Insights with better formatting
                    if (personaPackage.error) {
                        doc.setFillColor('#fef2f2');
                        doc.rect(leftMargin, yPosition, usableWidth, 40, 'F');
                        yPosition = addFormattedText(`Error: ${personaPackage.error}`, leftMargin + 10, yPosition + 25, { 
                            fontSize: 11, 
                            color: '#dc2626', 
                            fontStyle: 'bold'
                        });
                        yPosition += 30;
                    } else if (personaPackage.insights_and_analysis && personaPackage.insights_and_analysis.length > 0) {
                        personaPackage.insights_and_analysis.forEach((item, index) => {
                            yPosition = checkAndAddPage(yPosition, 140);
                            
                            // Insight container
                            const insightHeight = 120;
                            doc.setFillColor('#f8fafc');
                            doc.rect(leftMargin + 10, yPosition, usableWidth - 20, insightHeight, 'F');
                            doc.setDrawColor('#cbd5e1');
                            doc.rect(leftMargin + 10, yPosition, usableWidth - 20, insightHeight, 'S');
                            
                            // Insight number
                            doc.setFillColor('#f59e0b');
                            doc.circle(leftMargin + 30, yPosition + 25, 12, 'F');
                            doc.setFontSize(12);
                            doc.setFont("helvetica", "bold");
                            doc.setTextColor('#ffffff');
                            doc.text(`${index + 1}`, leftMargin + 26, yPosition + 31);
                            
                            yPosition = addFormattedText(`${item.insight || 'N/A'}`, leftMargin + 55, yPosition + 20, { 
                                fontSize: 11, 
                                fontStyle: 'bold', 
                                maxWidth: usableWidth - 70,
                                color: '#1f2937',
                                lineHeightFactor: 1.6
                            });
                            
                            yPosition = addFormattedText(`Reasoning: ${item.supporting_reasoning || 'N/A'}`, leftMargin + 55, yPosition + 10, { 
                                fontSize: 10, 
                                maxWidth: usableWidth - 70,
                                lineHeightFactor: 1.6,
                                color: '#374151'
                            });
                            
                            yPosition = addFormattedText(`Confidence: ${item.confidence_level || 'N/A'}`, leftMargin + 55, yPosition + 10, { 
                                fontSize: 10,
                                color: '#059669',
                                fontStyle: 'bold'
                            });
                            
                            if (item.identified_risks && item.identified_risks.length > 0) {
                                yPosition = addFormattedText(`âš  Risks: ${item.identified_risks.join(', ')}`, leftMargin + 55, yPosition + 8, { 
                                    fontSize: 9, 
                                    color: '#dc2626', 
                                    maxWidth: usableWidth - 70,
                                    fontStyle: 'italic',
                                    lineHeightFactor: 1.5
                                });
                            }
                            
                            if (item.identified_opportunities && item.identified_opportunities.length > 0) {
                                yPosition = addFormattedText(`â˜… Opportunities: ${item.identified_opportunities.join(', ')}`, leftMargin + 55, yPosition + 8, { 
                                    fontSize: 9, 
                                    color: '#059669', 
                                    maxWidth: usableWidth - 70,
                                    fontStyle: 'italic',
                                    lineHeightFactor: 1.5
                                });
                            }
                            
                            if (item.implementation_ideas && item.implementation_ideas.length > 0) {
                                yPosition = addFormattedText(`ðŸ’¡ Implementation Ideas:`, leftMargin + 55, yPosition + 8, { 
                                    fontSize: 9, 
                                    color: '#059669', 
                                    maxWidth: usableWidth - 70,
                                    fontStyle: 'bold',
                                    lineHeightFactor: 1.5
                                });
                                
                                item.implementation_ideas.forEach((idea, ideaIndex) => {
                                    yPosition = addFormattedText(`  ${ideaIndex + 1}. ${idea}`, leftMargin + 70, yPosition + 8, { 
                                        fontSize: 9, 
                                        color: '#374151', 
                                        maxWidth: usableWidth - 85,
                                        fontStyle: 'normal',
                                        lineHeightFactor: 1.5
                                    });
                                });
                            }
                            
                            yPosition += insightHeight - 60;
                        });
                    }
                });
            }
            
            // Market Intelligence Section
            if (data.market_intelligence && data.market_intelligence.length > 0) {
                doc.addPage();
                yPosition = 80;
                
                // Section header
                doc.setFillColor('#0891b2');
                doc.rect(0, yPosition - 20, pageWidth, 60, 'F');
                
                yPosition = addFormattedText("MARKET INTELLIGENCE ANALYSIS", 0, yPosition + 20, { 
                    fontSize: 20, 
                    fontStyle: 'bold', 
                    color: '#ffffff',
                    align: 'center'
                });
                
                yPosition += 60;
                
                data.market_intelligence.forEach((intel, index) => {
                    if (index > 0) {
                        yPosition = checkAndAddPage(yPosition, 100);
                    }
                    
                    const title = intel.title || 'Market Analysis';
                    
                    // Intelligence header
                    doc.setFillColor('#f0f9ff');
                    doc.rect(leftMargin, yPosition, usableWidth, 50, 'F');
                    doc.setDrawColor('#0891b2');
                    doc.setLineWidth(2);
                    doc.rect(leftMargin, yPosition, usableWidth, 50, 'S');
                    
                    yPosition = addFormattedText(title.toUpperCase(), leftMargin + 20, yPosition + 30, { 
                        fontSize: 14, 
                        fontStyle: 'bold', 
                        color: '#0c4a6e'
                    });
                    
                    yPosition += 40;
                    
                    // Confidence level
                    yPosition = addFormattedText(`Confidence Level: ${intel.confidence_level || 'Medium'}`, leftMargin, yPosition + 15, { 
                        fontSize: 11,
                        color: intel.confidence_level === 'High' ? '#059669' : intel.confidence_level === 'Low' ? '#dc2626' : '#ea580c',
                        fontStyle: 'bold'
                    });
                    
                    yPosition += 25;
                    
                    // Key insights
                    if (intel.key_insights && intel.key_insights.length > 0) {
                        yPosition = addFormattedText("KEY INSIGHTS:", leftMargin, yPosition + 15, { 
                            fontSize: 12, 
                            fontStyle: 'bold', 
                            color: '#1f2937'
                        });
                        yPosition += 10;
                        
                        intel.key_insights.forEach((insight, insightIndex) => {
                            yPosition = checkAndAddPage(yPosition, 35);
                            yPosition = addFormattedText(`â€¢ ${insight}`, leftMargin + 20, yPosition + 15, { 
                                fontSize: 10, 
                                maxWidth: usableWidth - 40,
                                lineHeightFactor: 1.6,
                                color: '#374151'
                            });
                        });
                        yPosition += 20;
                    }
                    
                    // Full content (truncated for PDF)
                    if (intel.content) {
                        yPosition = addFormattedText("DETAILED ANALYSIS:", leftMargin, yPosition + 15, { 
                            fontSize: 12, 
                            fontStyle: 'bold', 
                            color: '#1f2937'
                        });
                        yPosition += 10;
                        
                        const truncatedContent = intel.content.length > 1000 ? 
                            intel.content.substring(0, 1000) + '...' : 
                            intel.content;
                            
                        yPosition = addFormattedText(truncatedContent, leftMargin + 20, yPosition + 15, { 
                            fontSize: 10, 
                            maxWidth: usableWidth - 40,
                            lineHeightFactor: 1.6,
                            color: '#374151'
                        });
                        yPosition += 30;
                    }
                });
            }
            
            // Enhanced footer with page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Footer line
                doc.setDrawColor('#e5e7eb');
                doc.setLineWidth(1);
                doc.line(leftMargin, pageHeight - 50, pageWidth - rightMargin, pageHeight - 50);
                
                // Page number
                doc.setFontSize(10);
                doc.setTextColor('#6b7280');
                doc.text(`Page ${i} of ${pageCount}`, pageWidth - rightMargin - 70, pageHeight - 30);
                
                // Footer text
                doc.text('AI Expert Panel Report - Confidential', leftMargin, pageHeight - 30);
            }
            
            doc.save('AI_Expert_Panel_Report.pdf');
        }

        // Fancy HTML export with expert tabs
        function downloadHTML() {
            if (!globalReportData) {
                alert("No report data available to download.");
                return;
            }
            const data = globalReportData;
            const escapeHtml = (s) => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const experts = (data.expert_insights || []).map((p, i) => ({
                name: p.persona_name || `Expert ${i+1}`,
                insights: p.insights_and_analysis || [],
                error: p.error || null
            }));
            const personaDefinitions = data.persona_definitions || [];
            const defFor = (name) => personaDefinitions.find(d => d.name === name) || {};
            const market = data.market_intelligence || [];

            const tabs = [
                data.synthesis_report ? { id: 'tab-synthesis', label: 'Synthesis' } : null,
                ...experts.map((e, i)=>({ id:`tab-expert-${i}`, label:e.name })),
                market.length ? { id:'tab-market', label:'Market Intel' } : null
            ].filter(Boolean);

            function expertPanelHTML() {
                return experts.map((e, i)=>{
                    const def = defFor(e.name);
                    const insightBlocks = e.error ? `<div class="warn">Error: ${escapeHtml(e.error)}</div>` :
                        (e.insights.map((it, idx)=>`
                            <div class="insight">
                                <div class="insight-num">${idx+1}</div>
                                <div class="insight-body">
                                    <div class="insight-title">${escapeHtml(it.insight || '')}</div>
                                    ${it.supporting_reasoning ? `<div class="muted">${escapeHtml(it.supporting_reasoning)}</div>` : ''}
                                    <div class="meta-row">
                                        ${it.confidence_level ? `<span class="chip">Confidence: ${escapeHtml(it.confidence_level)}</span>` : ''}
                                    </div>
                                    ${it.identified_risks && it.identified_risks.length ? `<div class="risk">âš  ${escapeHtml(it.identified_risks.join(', '))}</div>` : ''}
                                    ${it.identified_opportunities && it.identified_opportunities.length ? `<div class="opp">â˜… ${escapeHtml(it.identified_opportunities.join(', '))}</div>` : ''}
                                    ${(it.implementation_ideas||[]).length ? `<ul class="ideas">${it.implementation_ideas.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>`:''}
                                </div>
                            </div>
                        `).join(''));
                    return `
                    <section id="panel-expert-${i}" class="panel hidden">
                        <div class="panel-header">
                            <div class="title">${escapeHtml(e.name)}</div>
                            ${def.description ? `<div class="desc">${escapeHtml(def.description)}</div>`:''}
                            ${def.focus_areas && def.focus_areas.length ? `<div class="muted">Focus: ${escapeHtml(def.focus_areas.join(', '))}</div>`:''}
                        </div>
                        ${insightBlocks}
                    </section>`;
                }).join('');
            }

            function synthesisHTML() {
                if (!data.synthesis_report || data.synthesis_report.error) return '';
                const s = data.synthesis_report;
                const actions = (s.actionable_next_steps||[]).map((a,i)=>`
                    <div class="action">
                        <div class="action-num">${i+1}</div>
                        <div class="action-body">
                            <div class="action-title">${escapeHtml(a.step_description||'')}</div>
                            ${a.priority ? `<div class="chip chip-priority">Priority: ${escapeHtml(a.priority)}</div>`:''}
                            ${a.suggested_rationale ? `<div class="muted">${escapeHtml(a.suggested_rationale)}</div>`:''}
                        </div>
                    </div>
                `).join('');
                return `
                <section id="panel-synthesis" class="panel">
                    <div class="panel-header">
                        <div class="title">Executive Summary</div>
                        ${data.original_problem ? `<div class="muted">Problem: ${escapeHtml(data.original_problem)}</div>`:''}
                    </div>
                    ${s.cohesive_summary ? `<p class="lead">${escapeHtml(s.cohesive_summary)}</p>`:''}
                    ${(s.key_themes||[]).length?`<h3>Key Themes</h3><ul class="bullets">${s.key_themes.map(t=>`<li>${escapeHtml(t)}</li>`).join('')}</ul>`:''}
                    ${(s.potential_blind_spots||[]).length?`<h3>Potential Blind Spots</h3><ul class="bullets warn">${s.potential_blind_spots.map(t=>`<li>${escapeHtml(t)}</li>`).join('')}</ul>`:''}
                    ${actions?`<h3>Actionable Next Steps</h3>${actions}`:''}
                    <div class="cta-bar">
                        <a id="workChartLink" href="#" class="cta">Design Work Chart (Humans + AI)</a>
                    </div>
                </section>`;
            }

            function marketHTML() {
                if (!market.length) return '';
                const blocks = market.map(m=>`
                    <div class="mi">
                        <div class="mi-title">${escapeHtml(m.title||'Market Analysis')}</div>
                        <div class="muted">Confidence: ${escapeHtml(m.confidence_level||'Medium')}</div>
                        ${(m.key_insights||[]).length?`<ul class="bullets">${m.key_insights.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>`:''}
                        ${m.content?`<div class="mi-content">${escapeHtml(m.content)}</div>`:''}
                    </div>
                `).join('');
                return `<section id="panel-market" class="panel hidden">${blocks}</section>`;
            }

            const html = `<!DOCTYPE html><html><head>
                <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>AI Expert Panel â€” Report</title>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
                <style>
                    body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:#f6f7f9;color:#111;margin:0}
                    .hero{background:linear-gradient(120deg,#0ea5e9,#6366f1);color:#fff;padding:32px 24px}
                    .hero h1{margin:0;font-size:28px;font-weight:800}
                    .hero p{margin:8px 0 0 0;opacity:.9}
                    .wrap{max-width:1100px;margin:0 auto;padding:24px}
                    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 18px 0}
                    .tab{background:#fff;border:1px solid #e5e7eb;padding:10px 14px;cursor:pointer;font-weight:600}
                    .tab.active{background:#111;color:#fff;border-color:#111}
                    .panel{background:#fff;border:1px solid #e5e7eb;padding:18px}
                    .panel.hidden{display:none}
                    .panel-header{margin-bottom:10px}
                    .panel-header .title{font-weight:800;font-size:20px}
                    .panel-header .desc{margin-top:6px}
                    .lead{font-size:16px;line-height:1.7}
                    .bullets{margin:8px 0 18px 18px}
                    .bullets.warn li{color:#b91c1c}
                    .insight{display:flex;gap:12px;margin:12px 0;border:1px solid #e5e7eb;padding:10px}
                    .insight-num{width:28px;height:28px;background:#f59e0b;color:#fff;font-weight:800;border-radius:50%;display:flex;align-items:center;justify-content:center}
                    .insight-title{font-weight:700}
                    .chip{display:inline-block;background:#111;color:#fff;padding:2px 8px;margin-top:6px;font-size:12px}
                    .chip-priority{background:#065f46}
                    .risk{color:#b91c1c;margin-top:6px}
                    .opp{color:#065f46;margin-top:6px}
                    .ideas{margin:8px 0 0 18px}
                    .mi{border:1px solid #e5e7eb;padding:12px;margin:10px 0}
                    .mi-title{font-weight:800}
                    .mi-content{white-space:pre-wrap;margin-top:8px}
                    .cta-bar{margin-top:18px;display:flex;justify-content:flex-end}
                    .cta{background:#0ea5e9;color:#fff;text-decoration:none;padding:10px 14px;font-weight:700;border:0}
                    .warn{color:#b91c1c}
                </style>
            </head><body>
                <div class="hero"><div class="wrap">
                    <h1>AI Expert Panel â€” Client Report</h1>
                    <p>${escapeHtml((data.original_problem || '').substring(0,240))}</p>
                </div></div>
                <div class="wrap">
                    <div class="tabs">
                        ${tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-target="${t.id}">${escapeHtml(t.label)}</button>`).join('')}
                    </div>
                    ${synthesisHTML()}
                    ${expertPanelHTML()}
                    ${marketHTML()}
                </div>
                <script>
                    const tabs = Array.from(document.querySelectorAll('.tab'));
                    function show(id){
                        document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
                        document.getElementById(id.replace('tab-','panel-')).classList.remove('hidden');
                        tabs.forEach(t=>t.classList.remove('active'));
                        const active = tabs.find(t=>t.dataset.target===id); if(active) active.classList.add('active');
                    }
                    tabs.forEach(t=>t.addEventListener('click',()=>show(t.dataset.target)));
                    // default
                    if(tabs[0]) show(tabs[0].dataset.target);
                    // Work Chart deep link
                    const wc = document.getElementById('workChartLink');
                    if (wc) {
                        const problem = encodeURIComponent(${JSON.stringify((globalReportData||{}).original_problem||'')} );
                        const actions = encodeURIComponent(JSON.stringify(((${JSON.stringify((globalReportData||{}).synthesis_report||{})}).actionable_next_steps)||[]));
                        wc.href = 'Work%20Chart.html?workflow=' + problem + '&actions=' + actions;
                    }
                <\/script>
            </body></html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'AI_Expert_Panel_Report.html';
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            const resultsContentDiv = document.getElementById('results-content');
            if (!resultsContentDiv.innerHTML.trim()) {
                 resultsContentDiv.innerHTML = `<div class="content-section active" id="initial-message"><p>Please enter your business problem and click "Get Expert Insights" to begin.</p></div>`;
            }
        });

    </script>
    
    <!-- Venice.ai Footer -->
    <footer class="venice-footer">
        <div class="venice-footer-content">
            <p>Powered by <a href="https://venice.ai" target="_blank" rel="noopener noreferrer" class="venice-link">Venice.ai</a></p>
        </div>
    </footer>
</body>
</html>